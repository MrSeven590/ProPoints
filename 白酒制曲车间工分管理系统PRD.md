# 项目名称：白酒制曲车间工分管理系统 (WorkPoints Pro)

最后更新：2026-02-02

## 1. 项目概况

- **目标用户**：制曲车间班级管理人员。
- **核心功能**：针对制曲工艺的 5 大环节进行工分计算、录入、考核、公示及 Excel 导出。
- **技术栈**：uni-app x (Vue3 + TypeScript)。
- **架构策略**：**本地优先 (Local-First)**，离线可用；二期扩展云端同步。
- **使用范围（关键约束）**：当前仅在“单班级”层次使用（不涉及多班级切换/汇总）。
- **数据存储**：SQLite（本地）。
- **二期字段预留**：`uuid/version/sync_status/updated_at` 等。

---

## 2. 基础设置与人员管理

### 2.1 班级配置（单班级）

#### 2.1.1 发酵仓编号规则

- **编号格式**：`[班级]-[楼层]-[序号]`（例如 `3-3-1`）。
- **序号上限（seq_max）规则**：
  - 优先取该班级、该楼层的**历史最大 `seq`** 作为 `seq_max`；
  - 若无任何历史数据，则 **默认 `24`** 为最大序号（即 `seq_max=24`）。
- **智能推断（录入页默认）**：
  - 依据最近一次提交记录，取“尾部仓号”作为起点（按 `floor DESC, seq DESC`）。
  - 默认预填 2 个连续仓号（可增减）。
  - 到达楼层末尾自动跨楼层：例如 `3-3-24 → 3-4-1`。

#### 2.1.2 轮次管理（仅用于“微机计分权”轮换）

- **轮次定义**：用于判断安曲晾堂岗位中的“微机(0.7)”是否具备计分权。
- **计分权推断规则**：
  - 读取上个轮次的 `micro_enabled`；
  - 若上轮 `micro_enabled=1`，则本轮 `micro_enabled=0`；反之亦然（隔轮次轮换）。
  - 若无历史数据：在**首次安曲工分录入**时弹窗询问“本轮次微机是否有计分权”，并保存为当前轮次配置。
- **轮次结束方式（关键交互）**：
  - 由**安曲环节的录入用户**在“工分录入页”点击按钮【结束本轮次/开始新轮次】手工确认。
  - 新轮次创建后：`round_no + 1`，并默认反转 `micro_enabled`。

---

### 2.2 人员花名册（仅姓名）

#### 2.2.1 导入方式

- **OCR/文本识别排班表**：仅提取“姓名”入库（不要求识别列/工号/岗位等）。
- **粘贴导入（Excel 复制）**：
  - 支持将 Excel 中复制的姓名直接粘贴；
  - 支持分隔符：换行符 / 空格 / 逗号（中英文逗号均可）。

#### 2.2.2 校对与入库（必做）

- OCR/粘贴解析后进入“识别结果校对列表”：
  - 支持编辑姓名（纠错）
  - 支持删除错误项
  - 支持去重（按姓名精确匹配；可选做 trim/全角半角归一）
- 确认入库后：
  - 自动生成姓名拼音索引（全拼/首字母）
  - 支持手工新增/编辑/停用人员（离线兜底）

---

### 2.3 技能画像（技能能力系数）

- 每位员工可配置“技能能力系数”（用于自动分配模式）。
- 系数用于“仓内剩余工分”按比例分配与“微调平衡”差额分摊。

---

## 3. 核心业务流程（五大环节）

### 3.1 工序流程

```
安曲(Day0) → 一次翻曲(Day7-9) → 二次翻曲(Day14-17) → 拆曲(Day40+) → 堆曲
```

### 3.2 作用域定义（贯穿全系统）

- **BIN**：按发酵仓计分/分配（每仓一个“池子”）。
- **CROSS_BIN**：跨仓岗位（如拉车/打杂），由管理员指定工分，并从所服务的多个仓按曲坯比例扣减。
- **SESSION**：按“会话总量”计分（不从单仓扣减），如：安曲晾堂岗位、堆曲独立组。

### 3.3 标准人员配置（默认值，可配置）

| 环节 | 作用域 | 默认人数 | 备注 |
| --- | --- | --- | --- |
| 安曲 | BIN | 4 | 仓内站位绑定（position_index） |
| 安曲 | CROSS_BIN | 1 | 拉车（服务多仓，按曲坯比例扣减） |
| 安曲·晾堂 | SESSION | 1/岗 | 麦料/守机/下曲/微机（微机受轮次计分权控制） |
| 一次翻曲 | BIN | 5 | / |
| 一次翻曲 | CROSS_BIN | 1 | 打杂（可选，服务多仓） |
| 二次翻曲 | BIN | 4 | 通常无跨仓岗位 |
| 拆曲 | BIN | 5 | / |
| 拆曲 | CROSS_BIN | 1 | 拉车（服务多仓） |
| 堆曲 | SESSION | 2-4 | 独立组；按当日拆曲总数计分 |

> 轮次提示：现实中“同一日不同环节可能属于不同轮次”（例如：当日安曲已进入第3轮，但拆曲/堆曲仍在处理第2轮发酵完成的曲坯）。系统需支持按仓号历史推断各环节所属轮次用于追溯；但堆曲基数始终取当日拆曲总量（见 4.5）。

### 3.4 曲坯数量口径（全流程一致，以安曲为准）

- **单仓曲坯数量来源**：每个发酵仓的曲坯数量仅在**安曲环节**录入一次，作为该仓后续所有环节的曲坯数量基准。
- **后续环节复用**：一次翻曲 / 二次翻曲 / 拆曲 / 堆曲等环节中，发酵仓曲坯数量自动使用该仓“安曲环节已录入”的曲坯数量，默认不再重复填写。
- **示例**：`3-3-1` 在安曲录入曲坯数量为 `1324`，则一次翻曲、二次翻曲、拆曲、堆曲中该仓曲坯数量均为 `1324`（用于计算对应环节的工分）。

---

## 4. 工分计算与分配逻辑（核心难点）

### 4.1 取整与精度（统一规则）

- **特殊取整规则**：保留一位小数，**向小取整**（Floor）。
  - 案例：`72.875 → 72.8`
- **存储精度建议（实现约束）**：
  - 建议内部使用整数单位存储：`points_units = points × 10`（0.1 分为 1 单位）
  - 避免浮点误差，确保对账“绝对平衡”

### 4.2 发酵仓总工分计算（BIN 池子）

公式：

```
bin_total_points = floor1(koji_count / 20 * stage_coef)
floor1(x) = floor(x * 10) / 10
```

工序系数（可配置）：
- 安曲: 1.1
- 一翻: 1.25
- 二翻: 0.9
- 拆曲: 1.12
- 堆曲: 0.29

### 4.3 跨仓岗位（CROSS_BIN）扣减逻辑

- 管理员输入该岗位应得工分（例如拉车 10 分）。
- 系统从当前录入单内选中的多个发酵仓按曲坯数比例扣减：
  - 权重：各仓曲坯数
  - 精度：0.1 分
  - 需确保：扣减来源之和 = 跨仓岗位应得工分

### 4.4 会话岗位（SESSION）池子逻辑

#### 4.4.1 安曲晾堂（归属于安曲当日）

- **麦料参数 (0.85) / 守机 (0.8) / 下曲 (0.8)**：
  - 基数 = 当日安曲环节总曲坯数（当日安曲所有仓的曲坯数合计）
- **微机 (0.7)**：
  - 基数同上
  - 校验：当前轮次是否具备计分权（`micro_enabled=1` 才可录入）
- **人员默认延用（关键交互）**：
  - 因岗位人员变动少，安曲晾堂岗位（麦料参数/守机/下曲/微机）在**首次选择人员**后，后续每次安曲工分录入时默认回填“上一次安曲晾堂”对应岗位人员（仅回填人员，不回填工分）。
  - 管理人员可随时手工调整；调整后将作为下一次默认值。
- **自动计算（关键口径）**：
  - 安曲录入时，系统根据当日安曲录入单内所有发酵仓的曲坯数量，实时汇总得到“当日安曲总曲坯数”。
  - 晾堂岗位在人员自动回填/选择完成后，系统基于“当日安曲总曲坯数 × 岗位系数”自动计算该岗位池子总分；若岗位仅 1 人，则自动将该岗位工分填入该人员（无需手工输入）。

> 生成方式：每个岗位各自生成一个“岗位池子”，要求该岗位下所有人员分配之和 = 岗位池子总分。

#### 4.4.2 堆曲（独立组）

- 堆曲为 SESSION 计分，不从任何单仓扣减。
- 堆曲会话需记录“堆曲仓号标识”（见 6.3），用于查询/追溯。

### 4.5 堆曲基数来源（关键业务口径）

- **现实业务**：当日拆曲产出的曲坯会运送到堆曲处进行堆曲。
- **口径（必须）**：`当日堆曲总曲坯数量 = 当日拆曲环节总曲坯数量`（同一天内全部拆曲记录求和，不区分轮次）。
- 堆曲总工分：
  - `duiqu_total_points = floor1(当日拆曲总曲坯数 / 20 * 0.29)`
- 若当日无拆曲记录：
  - UI 必须提示“今日无拆曲数据”
  - 提供两种操作：
    1) 跳转去录入拆曲
    2) 允许手工补录“当日拆曲总曲坯数”（需二次确认；用于生成堆曲池子）

---

## 5. 打分模式与考核

### 5.1 自动分配模式 (Smart Allocator)

流程：
1. 输入曲坯数（生成仓总分/会话总分）。
2. 输入跨仓岗位人员及其工分（如拉车/打杂，系统自动从所选仓扣减）。
3. 剩余工分根据仓内人员技能系数自动按比例分配（0.1 精度）。

### 5.2 微调平衡 (Balance System)

#### 5.2.1 输入方式（必须都支持）

- **直接输入**：可直接键入工分（系统限制为 0.1 精度）。
- **步进器微调（Stepper）**：`+0.1 / -0.1` 快速调整（现场常用）。

#### 5.2.2 平衡规则

- 管理员调整某人（A）的工分后，系统在同一作用域内自动平衡其他人员，保证总分不变：
  - BIN：同仓内平衡
  - SESSION：同岗位池子内平衡
- 差额分摊：按技能系数权重进行比例分摊（建议实现为整数单位分配）。
- **不足 0.1 的剩余单位处理（关键规则）**：
  - 当按权重分摊后，某些人的份额不足 0.1（落到 0 单位）导致出现“剩余单位”时：
    - 第一次：将剩余单位集中给同仓/同池技能系数最高的人
    - 第二次：集中给同仓/同池技能系数第二高的人
    - 第三次起：在第一/第二名之间交替轮转（避免长期集中到同一人）

### 5.3 考核扣分 (Penalty)（必须保留原始分）

#### 5.3.1 业务逻辑

- 先按正常规则得到“原始工分”，再进行“扣分”得到最终分。
- **展示口径**：
  - 当日公示默认展示“最终工分（折后分）”
  - 详情页需同时展示：原始工分 / 扣分 / 最终工分

#### 5.3.2 录入交互（关键 UX）

- 在工分录入列表中，每条人员分配行都显示【考核】按钮。
- 点击【考核】后，该行变为两段式录入并实时展示最终分：
  - `[原始工分] - [扣分] = [最终工分]`
  - 扣分原因必填

#### 5.3.3 数据落库口径（实现要求）

- 原始工分存入“工分分配表”（Assignment）。
- 考核扣分存入“考核记录表”（PenaltyRecord，独立明细）。
- 展示/统计时需同时查询两表：  
  `final = raw - SUM(deducted)`

#### 5.3.4 考核记录字段（最低要求）

- 日期
- 被考核人
- 考核人
- 原因
- 扣分分值

### 5.4 追责体系

- **站位绑定**：录入名单的顺序 = 实际站位顺序。
- 顺序统一：从发酵仓门口到发酵仓最里面（`1=门口侧 → N=最里面`）。
- 查询：按日期 + 仓号，展示当日该仓人员与站位顺序，用于追责定位。

---

## 6. 用户体验 (UX) 细节

### 6.1 统一录入页（所有环节共用）

- 进入录入页默认展示 2 个发酵仓卡片（堆曲除外），支持 `+` 添加、`-` 删除。
- 页面需提供实时“对账状态”（平衡/不平衡、差额来源），不平衡禁止提交。
- 安曲晾堂（SESSION）岗位人员默认沿用上一次安曲录入的人员，减少重复选择；仍允许手动修改。
- **曲坯数量复用交互**：
  - 安曲：曲坯数量由现场录入（作为后续环节基准），并实时汇总当日总曲坯数用于晾堂自动计分。
  - 一翻/二翻/拆曲/堆曲：发酵仓曲坯数量自动带出安曲已录入值，默认只读展示（如需更正，应回到安曲记录调整）。

### 6.2 发酵仓选择器（单班级前提）

- 班级信息在初始化时已确定：页面内只读展示班级，不提供二级班级切换。
- 仅提供“楼层”切换。
- 发酵仓网格必须展示**完整编号**（例如 `3-3-1`、`3-3-2`），不能只显示序号 `1/2/3`。
- 支持快速多选（如长按连续选择）。

### 6.3 堆曲录入（特殊要求）

- 堆曲环节需手工填写“堆曲仓号标识”，格式同 `班级-楼层-序号`（例如 `7-2-6`），但**含义不同**于发酵仓编号。
- 行为规则：
  - 首次录入堆曲工分时：用户必须填写堆曲仓号；
  - 此后默认沿用首次/最近一次的堆曲仓号，直到用户手动修改；
  - 修改后新的仓号成为后续默认值。
- 堆曲页顶部必须展示“当日拆曲总曲坯数”，用于现场核对。

### 6.4 工分输入控件与反馈

- 工分输入支持：直接输入 + 步进器微调（Stepper）。
- 直接输入建议使用“大按钮数字键盘”（适合现场手套操作）。
- 当系统因平衡规则自动调整其他人分值时，需要明显反馈（例如高亮闪烁/提示文案），避免“暗改”。

### 6.5 花名册导入体验（OCR/粘贴）

- OCR/粘贴后必须进入校对列表（可编辑/删除/去重）再入库。
- 粘贴导入需支持：换行符、空格、逗号分隔。

---

## 7. 数据查询与报表

### 7.1 每日公示

- **公示维度**：以“环节”为单位进行公示。同一日期下，不同环节（安曲/一翻/二翻/拆曲/堆曲）可在不同时间分别公示，互不依赖。
- **公示触发与时间**：不做统一定时；由各环节现场管理人员在本环节内手动触发【公示】来决定何时公示。
- **公示内容**：公示时仅需展示“当前环节”的所有人员工分，默认展示最终工分（折后分）；支持切换展示：原始 / 扣分 / 最终（如有考核）。
- **离线公示方式**：因当前为离线使用，公示页只需提供适合截图的简洁列表视图；现场管理人员截图保存后，发送至班级管理群完成公示。
- **调整权限（关键约束）**：现场管理人员对本环节拥有完整工分调整权，可随时修改历史工分（含原始工分与考核扣分）。修改后公示页展示数据以最新结果为准，可随时重新截图再次公示。

### 7.2 查询维度

- 按人员查（个人工资条：每日明细 + 扣分记录）。
- 按发酵仓查（追责：日期 + 仓号 + 站位顺序）。
- 按日期查（每日公示/简报）。

### 7.3 Excel 导出（以本 PRD 为准）

- **触发方式**：手动触发。
- **导出方式**：管理人员提供 Excel 模板，系统按日期 + 姓名填入工分数据后导出新文件（不修改原模板）。

#### 7.3.1 模板定位规则（默认约定）

- **B 列为姓名列**
- **第 2 行为日期行**
- 日期显示格式：`YYYY/MM/DD`（例如 `2025/12/23`）
- 默认范围建议：
  - 日期从 `C2` 开始向右扩展
  - 姓名从 `B3` 开始向下扩展
  - 填值单元格 = “姓名行 × 日期列”的交叉单元格

#### 7.3.2 数据口径

- 默认填入“最终工分”（原始工分 - 扣分）。
- 若模板需要拆分列（原始/扣分/最终），可在导出配置中选择写入对应列（属于增强项，MVP 可只写最终分）。

#### 7.3.3 缺失处理

- 模板中找不到的姓名/日期：导出完成后给出缺失清单提示（便于修正模板或核对人员名单）。

---

## 8. 针对开发者的建议 (Implementation Tips)

### 8.1 类型定义建议 (TypeScript)

```typescript
type ProcessType = 'AnQu' | 'FanQu1' | 'FanQu2' | 'ChaiQu' | 'DuiQu';
type Scope = 'BIN' | 'CROSS_BIN' | 'SESSION';

// 统一使用 0.1 精度整数单位，避免浮点误差
type PointsUnits = number; // points × 10

interface PenaltyRecord {
  id: string;
  assignmentId: string;
  managerName: string;
  targetName: string;
  reason: string;
  deductedPointsUnits: PointsUnits; // 扣分（单位）
}

interface Assignment {
  id: string;
  personId: string;
  nameSnapshot: string;
  scope: Scope;
  binCode?: string; // BIN 才有
  positionIndex?: number; // BIN 才有
  rawPointsUnits: PointsUnits; // 原始工分（单位）
}

interface StageSession {
  id: string;
  date: string; // YYYY-MM-DD
  stage: ProcessType;
  roundNo?: number; // 安曲必填；堆曲可能为空（混合轮次）
  microEnabled?: boolean; // 仅安曲需要
  sessionRoomCode?: string; // 堆曲仓号标识，如 7-2-6
}
```

### 8.2 数据库/存储预留字段

- `uuid`: 唯一 ID（云端合并冲突用）
- `updated_at`: 时间戳（版本判断）
- `version`: 版本号（冲突解决）
- `sync_status`: 同步状态（local/synced/conflict 等）

### 8.3 数据模型实现建议（避免冗余双写）

- 事实来源建议以“StageSession / StageBin / Assignment / PenaltyRecord”作为主模型。
- 不保留/不启用与其重复的“环节执行历史缓存表”（避免双写导致不一致）。

### 8.4 仓库约定（工程项）

- `.ccb_config` 仅为本地会话配置目录，不纳入 git（需保持在 `.gitignore` 中）。
