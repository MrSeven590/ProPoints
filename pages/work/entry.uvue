<template>
  <view class="page-container">
    <!-- äº¤äº’å¼å¤´éƒ¨å¯¼èˆªæ  -->
    <view class="header-nav">
      <view class="nav-left" @click="onPrevDay">
        <text class="nav-icon">â—€</text>
      </view>

      <view class="nav-center" @click="onOpenDatePicker">
        <text class="nav-stage">{{ stageName }}</text>
        <text class="nav-date">{{ getDateLabel() }}</text>
        <text class="nav-status" :class="getStatusClass()">{{
          getStatusLabel()
        }}</text>
      </view>

      <view class="nav-right">
        <view class="nav-today" v-if="!isToday" @click="onToday">
          <text class="nav-today-text">è¿”å›ä»Šå¤©</text>
        </view>
        <view class="nav-calendar" @click="onOpenDatePicker">
          <text class="nav-icon">ğŸ“…</text>
        </view>
        <view class="nav-next" @click="onNextDay">
          <text class="nav-icon">â–¶</text>
        </view>
      </view>
    </view>

    <scroll-view class="content" scroll-y="true">
      <view class="scroll-body">
        <view class="section">
        <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
        <view class="info-row date-row">
          <text class="info-label">æ—¥æœŸ</text>
          <text class="info-value">{{ sessionDate }}</text>
        </view>
        <view class="info-row">
          <text class="info-label">ç¯èŠ‚</text>
          <text class="info-value">{{ stageName }}</text>
        </view>
        <view class="info-row remark-row" @click="onOpenRemarkPopup">
          <text class="info-label">å¤‡æ³¨</text>
          <text
            class="info-value remark-value"
            :class="sessionRemark == '' ? 'remark-placeholder' : ''"
          >
            {{ sessionRemark == "" ? "ç‚¹å‡»æ·»åŠ å¤‡æ³¨" : sessionRemark }}
          </text>
        </view>
        <view class="info-row">
          <text class="info-label">ç³»æ•°ç‰ˆæœ¬</text>
          <text class="info-value">{{ getCoefVersionLabel() }}</text>
        </view>
      </view>

      <!-- å‘é…µä»“é€‰æ‹©ï¼ˆéå †æ›²ç¯èŠ‚ï¼‰ -->
      <view class="section" v-if="showBinSection">
        <text class="section-title">å‘é…µä»“é€‰æ‹©</text>
        <biz-bin-selector
          :selectedBins="selectedBins"
          :stageCode="stageCode"
          :disabled="viewMode == 'view' || isRestoring == true"
          @change="onBinsChange"
        />
      </view>

      <!-- ç¼ºå¤±å®‰æ›²è®°å½•è­¦å‘Š -->
      <view class="section warning-section" v-if="missingAnQuBins.length > 0">
        <view class="warning-content">
          <text class="warning-text"
            >ä»¥ä¸‹ä»“ä½ç¼ºå°‘å®‰æ›²è®°å½•: {{ missingAnQuBins.join(", ") }}</text
          >
          <text class="warning-hint">è¯·å…ˆå½•å…¥å®‰æ›²æ•°æ®åå†è¿›è¡Œå½“å‰ç¯èŠ‚æ“ä½œ</text>
        </view>
        <view class="warning-btn" @click="goToAnQuEntry">
          <text class="warning-btn-text">å»å½•å…¥å®‰æ›²</text>
        </view>
      </view>

      <!-- è·¨ä»“å²—ä½åŒºåŸŸï¼ˆCROSS_BINï¼‰ -->
      <view class="section" v-if="showCrossBinSection">
        <view class="section-header">
          <text class="section-title section-header-title">è·¨ä»“å²—ä½</text>
          <view
            class="remove-btn"
            v-if="viewMode == 'edit' && isRestoring == false"
            @click="onRemoveCrossBin"
          >
            <text class="remove-btn-text">ç§»é™¤</text>
          </view>
        </view>
        <biz-cross-bin-input
          :stageCode="stageCode"
          :bins="stageBinInfos"
          :occupiedPersonIds="occupiedIds"
          :roleCode="crossBinRoleCode"
          :roleName="crossBinRoleName"
          :initialPersonId="crossBinPersonId"
          :initialPersonName="crossBinPersonName"
          :initialPointsUnits="crossBinPointsUnits"
          :externalSources="crossBinSources"
          :readonly="viewMode == 'view' || isRestoring == true"
          @change="onCrossBinChange"
        />
      </view>

      <!-- æ·»åŠ è·¨ä»“å²—ä½æŒ‰é’®ï¼ˆå½“æœªæ˜¾ç¤ºè·¨ä»“åŒºåŸŸä¸”éå †æ›²æ—¶ï¼Œä»…ç¼–è¾‘æ¨¡å¼å¯è§ï¼‰ -->
      <view
        class="section add-section"
        v-if="
          showBinSection &&
          !showCrossBinSection &&
          viewMode == 'edit' &&
          isRestoring == false
        "
      >
        <view class="add-btn" @click="onAddCrossBin">
          <text class="add-btn-text">+ æ·»åŠ è·¨ä»“å²—ä½</text>
        </view>
      </view>

      <!-- ä»“å†…äººå‘˜åˆ†é…åŒºåŸŸï¼ˆBINï¼‰ -->
      <view class="section" v-if="showBinSection && stageBinInfos.length > 0">
        <text class="section-title">ä»“å†…äººå‘˜åˆ†é…</text>
        <view class="bin-cards">
          <biz-bin-card
            v-for="binInfo in stageBinInfos"
            :key="binInfo.stage_bin_id"
            :stageBinId="binInfo.stage_bin_id"
            :binId="binInfo.bin_id"
            :binCode="binInfo.bin_code"
            :stageCode="stageCode"
            :initialKojiCount="binInfo.koji_count"
            :initialWorkers="getBinWorkers(binInfo.stage_bin_id)"
            :occupiedPersonIds="occupiedIds"
            :defaultWorkerCount="defaultBinWorkerCount"
            :crossBinDeduction="getCrossBinDeduction(binInfo.stage_bin_id)"
            :readonly="viewMode == 'view' || isRestoring == true"
            :stageCoef="getStageCoefForBin()"
            @change="onBinCardChange"
            @kojiChange="onBinKojiChange"
          />
        </view>
      </view>

      <!-- æ™¾å ‚å²—ä½åŒºåŸŸï¼ˆSESSIONï¼Œä»…å®‰æ›²ç¯èŠ‚æ˜¾ç¤ºï¼Œæ”¾åœ¨æœ€åï¼‰ -->
      <view class="section" v-if="showLiangTangSection">
        <view class="section-header">
          <text class="section-title section-header-title">æ™¾å ‚å²—ä½</text>
          <view class="liangtang-info">
            <text class="liangtang-info-text"
              >åŸºæ•°: {{ calcDailyAnQuKojiCount() }} æ›²å¯</text
            >
          </view>
        </view>

        <!-- éº¦æ–™å‚æ•°ï¼ˆä¸¥æ ¼1äººï¼‰ -->
        <biz-session-role-card
          roleCode="WHEAT_MATERIAL"
          roleName="éº¦æ–™å‚æ•°"
          :poolUnits="calcWheatMaterialPoolUnits()"
          :strictSingle="true"
          :simpleMode="true"
          :occupiedPersonIds="occupiedIds"
          :initialWorkers="wheatMaterialWorkers"
          :readonly="viewMode == 'view' || isRestoring == true"
          @change="onLiangTangRoleChange"
        />

        <!-- å®ˆæœºï¼ˆä¸¥æ ¼1äººï¼‰ -->
        <biz-session-role-card
          roleCode="MACHINE_GUARD"
          roleName="å®ˆæœº"
          :poolUnits="calcMachineGuardPoolUnits()"
          :strictSingle="true"
          :simpleMode="true"
          :occupiedPersonIds="occupiedIds"
          :initialWorkers="machineGuardWorkers"
          :readonly="viewMode == 'view' || isRestoring == true"
          @change="onLiangTangRoleChange"
        />

        <!-- ä¸‹æ›² -->
        <biz-session-role-card
          roleCode="KOJI_UNLOADER"
          roleName="ä¸‹æ›²"
          :poolUnits="calcKojiUnloaderPoolUnits()"
          :strictSingle="false"
          :simpleMode="isKojiUnloaderSimpleMode()"
          :occupiedPersonIds="occupiedIds"
          :initialWorkers="kojiUnloaderWorkers"
          :readonly="viewMode == 'view' || isRestoring == true"
          @change="onLiangTangRoleChange"
        />

        <!-- å¾®æœºï¼ˆæ ¹æ® micro_enabled æ˜¾ç¤º/éšè—ï¼‰ -->
        <biz-session-role-card
          v-if="microEnabled"
          roleCode="MICRO_OPERATOR"
          roleName="å¾®æœº"
          :poolUnits="calcMicroOperatorPoolUnits()"
          :strictSingle="true"
          :simpleMode="true"
          :occupiedPersonIds="occupiedIds"
          :initialWorkers="microOperatorWorkers"
          :readonly="viewMode == 'view' || isRestoring == true"
          @change="onLiangTangRoleChange"
        />

        <!-- å¾®æœºç¦ç”¨æç¤º -->
        <view v-if="!microEnabled" class="micro-disabled-hint">
          <text class="micro-disabled-text">æœ¬è½®æ¬¡å¾®æœºå²—ä½ä¸è®¡åˆ†</text>
        </view>
      </view>
      </view>
    </scroll-view>

    <!-- åˆ‡æ¢é®ç½©å±‚ -->
    <view v-show="isSwitching" class="switch-mask">
      <text class="switch-mask-text">åŠ è½½ä¸­...</text>
    </view>

    <view class="footer">
      <!-- åªè¯»æ¨¡å¼ä¸‹æ˜¾ç¤º"è¿›å…¥ç¼–è¾‘"æŒ‰é’® -->
      <view
        v-if="viewMode == 'view'"
        class="btn btn-primary"
        @click="onEnterEditMode"
      >
        <text class="btn-text btn-text-primary">è¿›å…¥ç¼–è¾‘</text>
      </view>
      <!-- ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºåŸæœ‰æŒ‰é’® -->
      <template v-else>
        <view class="btn btn-secondary" @click="onOpenRemarkPopup">
          <text class="btn-text btn-text-secondary">æ·»åŠ å¤‡æ³¨</text>
        </view>
        <view class="btn btn-primary" @click="submit">
          <text class="btn-text btn-text-primary">æäº¤ç¡®è®¤</text>
        </view>
      </template>
    </view>

    <!-- æ—¥æœŸé€‰æ‹©å¼¹çª— -->
    <view v-if="showDatePicker" class="picker-mask" @click="onCloseDatePicker">
      <view class="modal-container date-picker-container" @click.stop="">
        <view class="modal-header">
          <text class="modal-title">é€‰æ‹©æ—¥æœŸ</text>
          <view class="modal-close" @click="onCloseDatePicker">
            <text class="modal-close-text">X</text>
          </view>
        </view>
        <view class="date-picker-content">
          <view class="date-stepper">
            <view class="date-stepper-btn" @click="onDateDecrease">
              <text class="date-stepper-btn-text">-1å¤©</text>
            </view>
            <text class="date-display">{{ tempDate }}</text>
            <view class="date-stepper-btn" @click="onDateIncrease">
              <text class="date-stepper-btn-text">+1å¤©</text>
            </view>
          </view>
        </view>
        <view class="modal-actions">
          <view class="modal-btn modal-btn-cancel" @click="onCancelDatePicker">
            <text class="modal-btn-text modal-btn-text-cancel">å–æ¶ˆ</text>
          </view>
          <view
            class="modal-btn modal-btn-confirm"
            @click="onConfirmDatePicker"
          >
            <text class="modal-btn-text modal-btn-text-confirm">ç¡®è®¤</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¤‡æ³¨è¾“å…¥å¼¹çª— -->
    <view
      v-if="showRemarkPopup"
      class="picker-mask"
      @click="onCloseRemarkPopup"
    >
      <view class="modal-container remark-popup-container" @click.stop="">
        <view class="modal-header">
          <text class="modal-title">æ·»åŠ å¤‡æ³¨</text>
          <view class="modal-close" @click="onCloseRemarkPopup">
            <text class="modal-close-text">X</text>
          </view>
        </view>
        <view class="remark-popup-content">
          <textarea
            class="remark-textarea"
            :value="tempRemark"
            @input="onRemarkInput"
            placeholder="è¯·è¾“å…¥å¤‡æ³¨å†…å®¹..."
            :maxlength="500"
          />
        </view>
        <view class="modal-actions">
          <view class="modal-btn modal-btn-cancel" @click="onCancelRemarkPopup">
            <text class="modal-btn-text modal-btn-text-cancel">å–æ¶ˆ</text>
          </view>
          <view
            class="modal-btn modal-btn-confirm"
            @click="onConfirmRemarkPopup"
          >
            <text class="modal-btn-text modal-btn-text-confirm">ç¡®è®¤</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<script lang="uts">
import {
  getTodayDateString,
  getCurrentTimestamp,
  addDaysToDate,
} from "../../domain/models/types.uts";
import type {
  StageCode,
  PointsUnits,
  RoleCode,
} from "../../domain/models/types.uts";
import {
  getStageName,
  stageRequiresBin,
} from "../../domain/models/stage-session.uts";
import {
  stageHasCrossBinRole,
  getStageRoleConfigs,
  getStageBinWorkerCount,
  getStageCoef,
  getStageCoefFromSnapshot,
} from "../../domain/services/StageCoefService.uts";
import type { BinCode, StageBinInfo } from "../../domain/models/ferment.uts";
import type { AssignmentSourceCreateParams } from "../../domain/models/assignment.uts";
import type { BinInfo } from "../../domain/services/ScoreAllocator.uts";
import { allocateCrossBinPoints } from "../../domain/services/ScoreAllocator.uts";
import { getBinKojiCountFromAnQu } from "../../domain/services/DuiQuBaseService.uts";
import {
  saveDraftSession,
  saveSubmittedSession,
  loadSessionForEdit,
  saveLiangTangDefault,
  loadLiangTangDefault,
  getActiveCoefSetId,
  loadCoefSetById,
  getCurrentClassNo,
  getManagerName,
} from "../../domain/stores/AppStore.uts";
import {
  validateSessionData,
  formatErrorsForModal,
} from "../../domain/services/Validator.uts";
import type { ValidationContext } from "../../domain/services/Validator.uts";
import { calcLiangTangPoolUnits } from "../../domain/services/ScoreCalculator.uts";
import {
  isMicroEnabledForCurrentRound,
  isMicroEnabledByRoundId,
} from "../../domain/services/RoundService.uts";

// ç³»æ•°ç‰ˆæœ¬å¸¸é‡
const DEFAULT_COEF_SET_ID = 260000;

/**
 * ä»“å†…å·¥äººåˆ†é…æ•°æ®ç±»å‹
 */
type BinWorkerData = {
  personId: number | null;
  personName: string;
  pointsUnits: PointsUnits;
  positionIndex: number;
  deductedUnits: PointsUnits;
  penaltyReason: string;
  penaltyId: number | null;
};

/**
 * ä»“å¡ç‰‡æ•°æ®ç±»å‹
 */
type BinCardData = {
  stageBinId: number;
  binId: number;
  binCode: string;
  kojiCount: number;
  totalPointsUnits: PointsUnits;
  assignedUnits: PointsUnits;
  workers: BinWorkerData[];
};

/**
 * æ™¾å ‚å²—ä½å·¥äººæ•°æ®ç±»å‹
 */
type LiangTangWorkerData = {
  personId: number | null;
  personName: string;
  pointsUnits: PointsUnits;
};

/**
 * æ™¾å ‚å²—ä½æ•°æ®ç±»å‹
 */
type LiangTangRoleData = {
  roleCode: RoleCode;
  workers: LiangTangWorkerData[];
};

export default {
  data() {
    return {
      stageCode: "AN_QU" as StageCode,
      stageName: "å®‰æ›²",
      sessionDate: "",
      roundId: null as number | null,
      coefSetId: null as number | null,
      showBinSection: true,
      showCrossBinSection: false,
      selectedBins: [] as BinCode[],
      // å‘é…µä»“è¯¦ç»†ä¿¡æ¯ï¼ˆç”¨äºè·¨ä»“ç»„ä»¶ï¼‰
      stageBinInfos: [] as StageBinInfo[],
      // è·¨ä»“å²—ä½é…ç½®
      crossBinRoleCode: "CART_PULLER" as RoleCode,
      crossBinRoleName: "æ‹‰è½¦",
      // è·¨ä»“å²—ä½åˆ†é…æ•°æ®
      crossBinPersonId: null as number | null,
      crossBinPersonName: "" as string,
      crossBinPointsUnits: 0 as PointsUnits,
      crossBinSources: [] as AssignmentSourceCreateParams[],
      // äººå‘˜äº’æ–¥åˆ—è¡¨
      occupiedIds: [] as number[],
      // ä»“å¡ç‰‡æ•°æ®
      binCardsData: new Map<number, BinCardData>(),
      // é»˜è®¤ä»“å†…å·¥äººæ•°
      defaultBinWorkerCount: 4 as number,
      // ç¼ºå¤±å®‰æ›²è®°å½•çš„ä»“å·åˆ—è¡¨
      missingAnQuBins: [] as string[],
      // æ—¥æœŸé€‰æ‹©å¼¹çª—
      showDatePicker: false as boolean,
      tempDate: "" as string,
      // è‡ªåŠ¨ä¿å­˜ç›¸å…³çŠ¶æ€
      autoSaveTimer: 0 as number,
      autoSaveDebounceMs: 1200 as number,
      draftRevision: 0 as number,
      savedRevision: 0 as number,
      isSubmitting: false as boolean,
      sessionStatus: "draft" as string,
      // å®¡è®¡å­—æ®µï¼ˆç®¡ç†å‘˜å§“åå¿«ç…§ï¼‰
      createdByManager: "" as string,
      updatedByManager: "" as string,
      lastAutoSaveErrorTime: 0 as number,
      // æ™¾å ‚å²—ä½ç›¸å…³çŠ¶æ€ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
      showLiangTangSection: false as boolean,
      microEnabled: false as boolean,
      // æ™¾å ‚å²—ä½æ•°æ®
      liangTangRolesData: new Map<string, LiangTangRoleData>(),
      // æ™¾å ‚å²—ä½åˆå§‹å·¥äººæ•°æ®ï¼ˆç”¨äºç»„ä»¶åˆå§‹åŒ–ï¼‰
      wheatMaterialWorkers: [] as UTSJSONObject[],
      machineGuardWorkers: [] as UTSJSONObject[],
      kojiUnloaderWorkers: [] as UTSJSONObject[],
      microOperatorWorkers: [] as UTSJSONObject[],
      // æ™¾å ‚æ± å­æ€»åˆ†ç¼“å­˜ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
      dailyKojiCount: 0 as number,
      wheatMaterialPoolUnits: 0 as PointsUnits,
      machineGuardPoolUnits: 0 as PointsUnits,
      kojiUnloaderPoolUnits: 0 as PointsUnits,
      microOperatorPoolUnits: 0 as PointsUnits,
      // å¤‡æ³¨å¼¹çª—ç›¸å…³çŠ¶æ€
      showRemarkPopup: false as boolean,
      tempRemark: "" as string,
      sessionRemark: "" as string,
      // åªè¯»æ¨¡å¼ç›¸å…³çŠ¶æ€
      viewMode: "edit" as "edit" | "view",
      isRestoring: false as boolean,
      // ç³»æ•°å¿«ç…§ï¼ˆæŒä¹…åŒ–åˆ°ä¼šè¯æ•°æ®ä¸­ï¼‰
      coefSnapshot: null as UTSJSONObject | null,
      // æ—¥æœŸåˆ‡æ¢æ§åˆ¶
      isSwitching: false as boolean,
      pendingDate: null as string | null,
      switchSeq: 0 as number,
    };
  },
  onLoad(options: UTSJSONObject) {
    // é»˜è®¤ä½¿ç”¨ä»Šæ—¥æ—¥æœŸ
    this.sessionDate = getTodayDateString();

    // è§£æç¯èŠ‚ä»£ç 
    const stage = options["stage"] as string | null;
    if (stage != null) {
      this.stageCode = stage as StageCode;
      this.stageName = getStageName(this.stageCode);
      this.showBinSection = stageRequiresBin(this.stageCode);
      this.showCrossBinSection = stageHasCrossBinRole(this.stageCode);
      this.initCrossBinRole();
      // åˆå§‹åŒ–é»˜è®¤ä»“å†…å·¥äººæ•°
      this.defaultBinWorkerCount = getStageBinWorkerCount(this.stageCode);
      // åˆå§‹åŒ–æ™¾å ‚å²—ä½ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
      this.initLiangTangSection();
    }

    // è§£ææ—¥æœŸå‚æ•°ï¼ˆç”¨äºåŠ è½½å·²æœ‰ä¼šè¯ï¼‰
    const dateParam = options["date"] as string | null;
    if (dateParam != null) {
      this.sessionDate = dateParam;
    }

    // è§£æè½®æ¬¡ ID
    const roundIdParam = options["roundId"] as string | null;
    if (roundIdParam != null) {
      const parsedRoundId = parseInt(roundIdParam);
      if (isNaN(parsedRoundId) == false) {
        this.roundId = parsedRoundId;
      }
    }

    // å§‹ç»ˆå°è¯•åŠ è½½å·²å­˜åœ¨çš„ä¼šè¯ï¼ˆdraft ä¼˜å…ˆï¼‰
    // ä½¿ç”¨æ–°çš„åŸå­çŠ¶æ€äº¤æ¢æ–¹å¼
    const initialState = this.buildStateForDate(this.sessionDate);
    this.applyState(initialState);
  },
  onHide() {
    // é¡µé¢éšè—æ—¶ç«‹å³ä¿å­˜è‰ç¨¿
    this.cancelAutoSave();
    if (this.sessionStatus == "draft" && this.isSubmitting == false) {
      // å¼ºåˆ¶è§¦å‘ blurï¼Œç¡®ä¿è¾“å…¥æ¡†æ•°æ®å·²åŒæ­¥
      uni.hideKeyboard();
      this.doAutoSave();
    }
  },
  onUnload() {
    // é¡µé¢å¸è½½æ—¶ç«‹å³ä¿å­˜è‰ç¨¿å¹¶æ¸…ç†å®šæ—¶å™¨
    this.cancelAutoSave();
    if (this.sessionStatus == "draft" && this.isSubmitting == false) {
      // å¼ºåˆ¶è§¦å‘ blurï¼Œç¡®ä¿è¾“å…¥æ¡†æ•°æ®å·²åŒæ­¥
      uni.hideKeyboard();
      this.doAutoSave();
    }
  },
  computed: {
    /**
     * åˆ¤æ–­å½“å‰æ—¥æœŸæ˜¯å¦ä¸ºä»Šå¤©
     */
    isToday(): boolean {
      return this.sessionDate == getTodayDateString();
    },
  },
  methods: {
    /**
     * åˆ‡æ¢åˆ°å‰ä¸€å¤©
     */
    onPrevDay() {
      const prevDate = addDaysToDate(this.sessionDate, -1);
      this.requestSwitchDate(prevDate);
    },

    /**
     * åˆ‡æ¢åˆ°åä¸€å¤©
     */
    onNextDay() {
      const nextDate = addDaysToDate(this.sessionDate, 1);
      this.requestSwitchDate(nextDate);
    },

    /**
     * åˆ‡æ¢åˆ°ä»Šå¤©
     */
    onToday() {
      const today = getTodayDateString();
      if (this.sessionDate != today) {
        this.requestSwitchDate(today);
      }
    },

    /**
     * è·å–æ—¥æœŸæ ‡ç­¾ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€å…·ä½“æ—¥æœŸï¼‰
     */
    getDateLabel(): string {
      const today = getTodayDateString();
      if (this.sessionDate == today) {
        return "ä»Šå¤©";
      }

      const yesterday = addDaysToDate(today, -1);
      if (this.sessionDate == yesterday) {
        return "æ˜¨å¤©";
      }

      const beforeYesterday = addDaysToDate(today, -2);
      if (this.sessionDate == beforeYesterday) {
        return "å‰å¤©";
      }

      return this.sessionDate;
    },

    /**
     * è·å–çŠ¶æ€æ ‡ç­¾
     */
    getStatusLabel(): string {
      if (this.viewMode == "view") {
        return "[å·²æäº¤]";
      } else if (this.sessionStatus == "draft") {
        return "[è‰ç¨¿]";
      } else {
        return "[å½•å…¥ä¸­]";
      }
    },

    /**
     * è·å–çŠ¶æ€æ ·å¼ç±»
     */
    getStatusClass(): string {
      if (this.viewMode == "view") {
        return "status-submitted";
      } else if (this.sessionStatus == "draft") {
        return "status-draft";
      } else {
        return "status-editing";
      }
    },

    /**
     * è·å–ç³»æ•°ç‰ˆæœ¬æ ‡ç­¾
     * @returns ç³»æ•°ç‰ˆæœ¬æ ‡ç­¾ï¼Œé»˜è®¤ç‰ˆæœ¬æ˜¾ç¤º"é»˜è®¤"ï¼Œå…¶ä»–ç‰ˆæœ¬æ˜¾ç¤ºæ—¥æœŸæ•°å­—
     */
    getCoefVersionLabel(): string {
      const id = this.coefSetId;
      if (id == null || id == DEFAULT_COEF_SET_ID) {
        return "é»˜è®¤";
      }
      return id.toString();
    },

    /**
     * è·å–ä»“çš„å·¥åºç³»æ•°ï¼ˆä¼˜å…ˆä½¿ç”¨ä¼šè¯ç»‘å®šçš„ç³»æ•°å¿«ç…§ï¼‰
     */
    getStageCoefForBin(): number {
      // ä¼˜å…ˆä½¿ç”¨ coefSnapshotï¼ˆä¸ä¾èµ–å­˜å‚¨å±‚ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±å¯¼è‡´æ¼‚ç§»ï¼‰
      if (this.coefSnapshot != null) {
        return getStageCoefFromSnapshot(this.stageCode, this.coefSnapshot);
      }
      // å›é€€åˆ°æŒ‰ç‰ˆæœ¬IDä»å­˜å‚¨å±‚è¯»å–
      return getStageCoef(this.stageCode, this.coefSetId);
    },

    /**
     * è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼ˆä»åªè¯»æ¨¡å¼åˆ‡æ¢ï¼‰
     */
    onEnterEditMode() {
      // è¯»å– submitted æ•°æ®ï¼Œå†™å…¥ draft
      const sessionData = loadSessionForEdit(
        this.sessionDate,
        this.stageCode,
        this.roundId,
      );
      if (sessionData == null) {
        uni.showToast({
          title: "æ— æ³•åŠ è½½ä¼šè¯æ•°æ®",
          icon: "none",
        });
        return;
      }

      // ä¿®æ”¹çŠ¶æ€ä¸º draft
      sessionData["status"] = "draft";

      // å®¡è®¡å­—æ®µï¼šè¿›å…¥ç¼–è¾‘æ—¶æ›´æ–° updated_by_managerï¼Œå¹¶åœ¨ç¼ºå¤±æ—¶è¡¥é½ created_by_manager
      const managerName = getManagerName().trim();
      if (managerName != "") {
        const createdByManager = sessionData["created_by_manager"] as
          | string
          | null;
        if (createdByManager == null || createdByManager == "") {
          sessionData["created_by_manager"] = managerName;
        }
        sessionData["updated_by_manager"] = managerName;
      }

      // ä¿å­˜ä¸ºè‰ç¨¿
      saveDraftSession(
        this.sessionDate,
        this.stageCode,
        this.roundId,
        sessionData,
      );

      // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
      this.viewMode = "edit";
      this.sessionStatus = "draft";

      uni.showToast({
        title: "å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼",
        icon: "success",
      });
    },

    /**
     * åˆå§‹åŒ–æ™¾å ‚å²—ä½åŒºåŸŸï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
     */
    initLiangTangSection() {
      // ä»…å®‰æ›²ç¯èŠ‚æ˜¾ç¤ºæ™¾å ‚å²—ä½
      this.showLiangTangSection = this.stageCode == "AN_QU";
      if (this.showLiangTangSection == false) {
        return;
      }
      // è·å–å¾®æœºè®¡åˆ†æƒï¼šå¦‚æœæœ‰ roundIdï¼Œä½¿ç”¨ä¼šè¯çš„è½®æ¬¡ï¼›å¦åˆ™ä½¿ç”¨å½“å‰è½®æ¬¡
      const classNo = getCurrentClassNo();
      if (this.roundId != null) {
        this.microEnabled = isMicroEnabledByRoundId(this.roundId);
      } else {
        this.microEnabled = isMicroEnabledForCurrentRound(classNo);
      }
      // åŠ è½½æ™¾å ‚é»˜è®¤äººå‘˜
      this.loadLiangTangDefaults();
    },

    /**
     * åŠ è½½æ™¾å ‚é»˜è®¤äººå‘˜ï¼ˆä»ä¸Šæ¬¡å®‰æ›²ä¼šè¯å›å¡«ï¼‰
     * ä¿®å¤ï¼šå¾®æœºç¦ç”¨æ—¶ä¸åŠ è½½å¾®æœºé»˜è®¤æ•°æ®
     */
    loadLiangTangDefaults() {
      const classNo = getCurrentClassNo();
      const defaults = loadLiangTangDefault(classNo);
      if (defaults == null) {
        return;
      }
      // å›å¡«å„å²—ä½é»˜è®¤äººå‘˜ï¼ˆä»…äººå‘˜ï¼Œä¸å›å¡«å·¥åˆ†ï¼‰
      const wheatMaterial = defaults["WHEAT_MATERIAL"] as
        | UTSJSONObject[]
        | null;
      if (wheatMaterial != null && wheatMaterial.length > 0) {
        const workers: UTSJSONObject[] = [];
        const roleWorkers: LiangTangWorkerData[] = [];
        const len = wheatMaterial.length;
        for (let i = 0; i < len; i++) {
          const w = wheatMaterial[i];
          workers.push({
            personId: w["personId"],
            personName: w["personName"],
            pointsUnits: 0,
          } as UTSJSONObject);
          roleWorkers.push({
            personId: w["personId"] as number | null,
            personName: w["personName"] as string,
            pointsUnits: 0,
          } as LiangTangWorkerData);
        }
        this.wheatMaterialWorkers = workers;
        this.liangTangRolesData.set("WHEAT_MATERIAL", {
          roleCode: "WHEAT_MATERIAL",
          workers: roleWorkers,
        } as LiangTangRoleData);
      }
      const machineGuard = defaults["MACHINE_GUARD"] as UTSJSONObject[] | null;
      if (machineGuard != null && machineGuard.length > 0) {
        const workers: UTSJSONObject[] = [];
        const roleWorkers: LiangTangWorkerData[] = [];
        const len = machineGuard.length;
        for (let i = 0; i < len; i++) {
          const w = machineGuard[i];
          workers.push({
            personId: w["personId"],
            personName: w["personName"],
            pointsUnits: 0,
          } as UTSJSONObject);
          roleWorkers.push({
            personId: w["personId"] as number | null,
            personName: w["personName"] as string,
            pointsUnits: 0,
          } as LiangTangWorkerData);
        }
        this.machineGuardWorkers = workers;
        this.liangTangRolesData.set("MACHINE_GUARD", {
          roleCode: "MACHINE_GUARD",
          workers: roleWorkers,
        } as LiangTangRoleData);
      }
      const kojiUnloader = defaults["KOJI_UNLOADER"] as UTSJSONObject[] | null;
      if (kojiUnloader != null && kojiUnloader.length > 0) {
        const workers: UTSJSONObject[] = [];
        const roleWorkers: LiangTangWorkerData[] = [];
        const len = kojiUnloader.length;
        for (let i = 0; i < len; i++) {
          const w = kojiUnloader[i];
          workers.push({
            personId: w["personId"],
            personName: w["personName"],
            pointsUnits: 0,
          } as UTSJSONObject);
          roleWorkers.push({
            personId: w["personId"] as number | null,
            personName: w["personName"] as string,
            pointsUnits: 0,
          } as LiangTangWorkerData);
        }
        this.kojiUnloaderWorkers = workers;
        this.liangTangRolesData.set("KOJI_UNLOADER", {
          roleCode: "KOJI_UNLOADER",
          workers: roleWorkers,
        } as LiangTangRoleData);
      }

      // ä¿®å¤ï¼šå¾®æœºç¦ç”¨æ—¶ä¸åŠ è½½å¾®æœºé»˜è®¤æ•°æ®
      if (this.microEnabled == false) {
        // æ¸…é™¤å¾®æœºæ•°æ®
        this.microOperatorWorkers = [] as UTSJSONObject[];
        this.liangTangRolesData.delete('MICRO_OPERATOR');
      } else {
        // å¾®æœºå¯ç”¨æ—¶æ‰åŠ è½½å¾®æœºé»˜è®¤æ•°æ®
        const microOperator = defaults["MICRO_OPERATOR"] as
          | UTSJSONObject[]
          | null;
        if (microOperator != null && microOperator.length > 0) {
          const workers: UTSJSONObject[] = [];
          const roleWorkers: LiangTangWorkerData[] = [];
          const len = microOperator.length;
          for (let i = 0; i < len; i++) {
            const w = microOperator[i];
            workers.push({
              personId: w["personId"],
              personName: w["personName"],
              pointsUnits: 0,
            } as UTSJSONObject);
            roleWorkers.push({
              personId: w["personId"] as number | null,
              personName: w["personName"] as string,
              pointsUnits: 0,
            } as LiangTangWorkerData);
          }
          this.microOperatorWorkers = workers;
          this.liangTangRolesData.set("MICRO_OPERATOR", {
            roleCode: "MICRO_OPERATOR",
            workers: roleWorkers,
          } as LiangTangRoleData);
        }
      }
    },

    /**
     * åŠ è½½æ™¾å ‚é»˜è®¤äººå‘˜ï¼ˆç”¨äºæ–°ä¼šè¯ï¼‰
     * è¿”å›ç»“æ„åŒ–æ•°æ®ï¼Œä¸ä¿®æ”¹ç»„ä»¶çŠ¶æ€
     */
    loadLiangTangDefaultsForNewSession(): UTSJSONObject {
      const result = {
        rolesData: new Map<string, LiangTangRoleData>(),
        wheatMaterialWorkers: [] as UTSJSONObject[],
        machineGuardWorkers: [] as UTSJSONObject[],
        kojiUnloaderWorkers: [] as UTSJSONObject[],
        microOperatorWorkers: [] as UTSJSONObject[]
      } as UTSJSONObject;

      if (this.showLiangTangSection == false) {
        return result;
      }

      const classNo = getCurrentClassNo();
      const defaults = loadLiangTangDefault(classNo);
      if (defaults == null) {
        return result;
      }

      const rolesData = new Map<string, LiangTangRoleData>();
      const wheatMaterialWorkers: UTSJSONObject[] = [];
      const machineGuardWorkers: UTSJSONObject[] = [];
      const kojiUnloaderWorkers: UTSJSONObject[] = [];
      const microOperatorWorkers: UTSJSONObject[] = [];

      // å›å¡«å„å²—ä½é»˜è®¤äººå‘˜ï¼ˆä»…äººå‘˜ï¼Œä¸å›å¡«å·¥åˆ†ï¼‰
      const wheatMaterial = defaults["WHEAT_MATERIAL"] as UTSJSONObject[] | null;
      if (wheatMaterial != null && wheatMaterial.length > 0) {
        const roleWorkers: LiangTangWorkerData[] = [];
        for (let i = 0; i < wheatMaterial.length; i++) {
          const w = wheatMaterial[i];
          wheatMaterialWorkers.push({
            personId: w["personId"],
            personName: w["personName"],
            pointsUnits: 0
          } as UTSJSONObject);
          roleWorkers.push({
            personId: w["personId"] as number | null,
            personName: w["personName"] as string,
            pointsUnits: 0
          } as LiangTangWorkerData);
        }
        rolesData.set("WHEAT_MATERIAL", {
          roleCode: "WHEAT_MATERIAL",
          workers: roleWorkers
        } as LiangTangRoleData);
      }

      const machineGuard = defaults["MACHINE_GUARD"] as UTSJSONObject[] | null;
      if (machineGuard != null && machineGuard.length > 0) {
        const roleWorkers: LiangTangWorkerData[] = [];
        for (let i = 0; i < machineGuard.length; i++) {
          const w = machineGuard[i];
          machineGuardWorkers.push({
            personId: w["personId"],
            personName: w["personName"],
            pointsUnits: 0
          } as UTSJSONObject);
          roleWorkers.push({
            personId: w["personId"] as number | null,
            personName: w["personName"] as string,
            pointsUnits: 0
          } as LiangTangWorkerData);
        }
        rolesData.set("MACHINE_GUARD", {
          roleCode: "MACHINE_GUARD",
          workers: roleWorkers
        } as LiangTangRoleData);
      }

      const kojiUnloader = defaults["KOJI_UNLOADER"] as UTSJSONObject[] | null;
      if (kojiUnloader != null && kojiUnloader.length > 0) {
        const roleWorkers: LiangTangWorkerData[] = [];
        for (let i = 0; i < kojiUnloader.length; i++) {
          const w = kojiUnloader[i];
          kojiUnloaderWorkers.push({
            personId: w["personId"],
            personName: w["personName"],
            pointsUnits: 0
          } as UTSJSONObject);
          roleWorkers.push({
            personId: w["personId"] as number | null,
            personName: w["personName"] as string,
            pointsUnits: 0
          } as LiangTangWorkerData);
        }
        rolesData.set("KOJI_UNLOADER", {
          roleCode: "KOJI_UNLOADER",
          workers: roleWorkers
        } as LiangTangRoleData);
      }

      const microOperator = defaults["MICRO_OPERATOR"] as UTSJSONObject[] | null;
      if (microOperator != null && microOperator.length > 0) {
        const roleWorkers: LiangTangWorkerData[] = [];
        for (let i = 0; i < microOperator.length; i++) {
          const w = microOperator[i];
          microOperatorWorkers.push({
            personId: w["personId"],
            personName: w["personName"],
            pointsUnits: 0
          } as UTSJSONObject);
          roleWorkers.push({
            personId: w["personId"] as number | null,
            personName: w["personName"] as string,
            pointsUnits: 0
          } as LiangTangWorkerData);
        }
        rolesData.set("MICRO_OPERATOR", {
          roleCode: "MICRO_OPERATOR",
          workers: roleWorkers
        } as LiangTangRoleData);
      }

      return {
        rolesData: rolesData,
        wheatMaterialWorkers: wheatMaterialWorkers,
        machineGuardWorkers: machineGuardWorkers,
        kojiUnloaderWorkers: kojiUnloaderWorkers,
        microOperatorWorkers: microOperatorWorkers
      } as UTSJSONObject;
    },

    /**
     * è®¡ç®—å½“æ—¥å®‰æ›²æ€»æ›²å¯æ•°
     */
    calcDailyAnQuKojiCount(): number {
      return this.dailyKojiCount;
    },

    /**
     * æ›´æ–°æ™¾å ‚æ± å­æ€»åˆ†ç¼“å­˜
     * åœ¨ stageBinInfos å˜åŒ–æ—¶è°ƒç”¨
     * ä¼˜å…ˆä½¿ç”¨ coefSnapshot è®¡ç®—ç³»æ•°ï¼Œå›é€€åˆ°ç‰ˆæœ¬åŒ–å­˜å‚¨
     */
    updateLiangTangPoolCache() {
      // è®¡ç®—å½“æ—¥å®‰æ›²æ€»æ›²å¯æ•°
      let total = 0;
      for (let i = 0; i < this.stageBinInfos.length; i++) {
        total = total + this.stageBinInfos[i].koji_count;
      }
      this.dailyKojiCount = total;

      // è®¡ç®—å„å²—ä½æ± å­æ€»åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨ coefSnapshotï¼‰
      this.wheatMaterialPoolUnits = calcLiangTangPoolUnits(
        this.dailyKojiCount,
        "WHEAT_MATERIAL" as RoleCode,
        this.coefSnapshot,
        this.coefSetId,
      );
      this.machineGuardPoolUnits = calcLiangTangPoolUnits(
        this.dailyKojiCount,
        "MACHINE_GUARD" as RoleCode,
        this.coefSnapshot,
        this.coefSetId,
      );
      this.kojiUnloaderPoolUnits = calcLiangTangPoolUnits(
        this.dailyKojiCount,
        "KOJI_UNLOADER" as RoleCode,
        this.coefSnapshot,
        this.coefSetId,
      );
      this.microOperatorPoolUnits = calcLiangTangPoolUnits(
        this.dailyKojiCount,
        "MICRO_OPERATOR" as RoleCode,
        this.coefSnapshot,
        this.coefSetId,
      );
    },

    /**
     * è®¡ç®—éº¦æ–™å‚æ•°å²—ä½æ± å­æ€»åˆ†
     */
    calcWheatMaterialPoolUnits(): PointsUnits {
      return this.wheatMaterialPoolUnits;
    },

    /**
     * è®¡ç®—å®ˆæœºå²—ä½æ± å­æ€»åˆ†
     */
    calcMachineGuardPoolUnits(): PointsUnits {
      return this.machineGuardPoolUnits;
    },

    /**
     * è®¡ç®—ä¸‹æ›²å²—ä½æ± å­æ€»åˆ†
     */
    calcKojiUnloaderPoolUnits(): PointsUnits {
      return this.kojiUnloaderPoolUnits;
    },

    /**
     * è®¡ç®—å¾®æœºå²—ä½æ± å­æ€»åˆ†
     */
    calcMicroOperatorPoolUnits(): PointsUnits {
      return this.microOperatorPoolUnits;
    },

    /**
     * åˆ¤æ–­ä¸‹æ›²å²—ä½æ˜¯å¦ä½¿ç”¨ç®€åŒ–æ¨¡å¼
     * ç®€åŒ–æ¨¡å¼ï¼šåªæœ‰1äººæˆ–æ²¡æœ‰äººæ—¶éšè—æ± å­æ€»åˆ†å’ŒçŠ¶æ€
     */
    isKojiUnloaderSimpleMode(): boolean {
      const roleData = this.liangTangRolesData.get("KOJI_UNLOADER");
      if (roleData == null) {
        // æ²¡æœ‰æ•°æ®æ—¶ï¼Œæ£€æŸ¥åˆå§‹å·¥äººæ•°
        return this.kojiUnloaderWorkers.length <= 1;
      }
      return roleData.workers.length <= 1;
    },

    /**
     * æ™¾å ‚å²—ä½æ•°æ®å˜æ›´
     */
    onLiangTangRoleChange(payload: UTSJSONObject) {
      if (this.isRestoring == true || this.viewMode != "edit") {
        return;
      }
      const roleCode = payload["roleCode"] as string;
      const workers = payload["workers"] as UTSJSONObject[];

      // è§£æå·¥äººæ•°æ®
      const workerList: LiangTangWorkerData[] = [];
      for (let i = 0; i < workers.length; i++) {
        const w = workers[i];
        workerList.push({
          personId: w["personId"] != null ? (w["personId"] as number) : null,
          personName:
            w["personName"] != null ? (w["personName"] as string) : "",
          pointsUnits:
            w["pointsUnits"] != null ? (w["pointsUnits"] as number) : 0,
        } as LiangTangWorkerData);
      }

      // æ›´æ–°æ™¾å ‚å²—ä½æ•°æ®
      this.liangTangRolesData.set(roleCode, {
        roleCode: roleCode as RoleCode,
        workers: workerList,
      } as LiangTangRoleData);

      // æ›´æ–°äººå‘˜äº’æ–¥åˆ—è¡¨
      this.updateOccupiedIds();
      // è§¦å‘è‡ªåŠ¨ä¿å­˜
      this.scheduleAutoSave();
    },

    /**
     * åˆå§‹åŒ–è·¨ä»“å²—ä½é…ç½®
     */
    initCrossBinRole() {
      if (this.showCrossBinSection == false) {
        return;
      }
      // è·å–è¯¥ç¯èŠ‚çš„è·¨ä»“å²—ä½é…ç½®
      const roleConfigs = getStageRoleConfigs(this.stageCode);
      for (let i = 0; i < roleConfigs.length; i++) {
        const config = roleConfigs[i];
        if (config.scope == "CROSS_BIN") {
          this.crossBinRoleCode = config.role_code;
          // æ ¹æ® role_code è®¾ç½®æ˜¾ç¤ºåç§°
          if (config.role_code == "CART_PULLER") {
            this.crossBinRoleName = "æ‹‰è½¦";
          } else if (config.role_code == "HELPER") {
            this.crossBinRoleName = "æ‰“æ‚";
          }
          break;
        }
      }
    },

    /**
     * æ‰‹åŠ¨æ·»åŠ è·¨ä»“å²—ä½
     */
    onAddCrossBin() {
      if (this.isRestoring == true || this.viewMode != "edit") {
        return;
      }
      this.showCrossBinSection = true;
      // è®¾ç½®é»˜è®¤å²—ä½ä¸ºæ‰“æ‚ï¼ˆç”¨æˆ·æ‰‹åŠ¨æ·»åŠ æ—¶é€šå¸¸æ˜¯äºŒæ¬¡ç¿»æ›²ç­‰ç¯èŠ‚ï¼‰
      this.crossBinRoleCode = "HELPER" as RoleCode;
      this.crossBinRoleName = "æ‰“æ‚";
      // é‡ç½®è·¨ä»“å²—ä½æ•°æ®
      this.crossBinPersonId = null;
      this.crossBinPersonName = "";
      this.crossBinPointsUnits = 0;
      this.crossBinSources = [] as AssignmentSourceCreateParams[];
      // è§¦å‘è‡ªåŠ¨ä¿å­˜
      this.scheduleAutoSave();
    },

    /**
     * ç§»é™¤è·¨ä»“å²—ä½
     */
    onRemoveCrossBin() {
      if (this.isRestoring == true || this.viewMode != "edit") {
        return;
      }
      // ä»äº’æ–¥åˆ—è¡¨ç§»é™¤è·¨ä»“äººå‘˜
      if (this.crossBinPersonId != null) {
        const idx = this.occupiedIds.indexOf(this.crossBinPersonId as number);
        if (idx != -1) {
          this.occupiedIds.splice(idx, 1);
        }
      }
      // é‡ç½®è·¨ä»“å²—ä½æ•°æ®
      this.showCrossBinSection = false;
      this.crossBinPersonId = null;
      this.crossBinPersonName = "";
      this.crossBinPointsUnits = 0;
      this.crossBinSources = [] as AssignmentSourceCreateParams[];
      // è§¦å‘è‡ªåŠ¨ä¿å­˜
      this.scheduleAutoSave();
    },

    /**
     * å‘é…µä»“é€‰æ‹©å˜æ›´
     */
    onBinsChange(bins: BinCode[]) {
      if (this.isRestoring == true || this.viewMode != "edit") {
        return;
      }
      this.selectedBins = bins;
      // æ›´æ–° stageBinInfosï¼ˆç”¨äºè·¨ä»“ç»„ä»¶ï¼‰
      this.updateStageBinInfos(bins);
      // æ›´æ–°æ™¾å ‚æ± å­æ€»åˆ†ç¼“å­˜ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
      if (this.showLiangTangSection == true) {
        this.updateLiangTangPoolCache();
      }
      // ä»“é›†åˆå˜æ›´åé‡æ–°è®¡ç®—è·¨ä»“å·¥åˆ†åˆ†é…
      this.recalculateCrossBinSources();
      // è§¦å‘è‡ªåŠ¨ä¿å­˜
      this.scheduleAutoSave();
    },

    /**
     * æ›´æ–°å‘é…µä»“è¯¦ç»†ä¿¡æ¯
     * - å®‰æ›²ç¯èŠ‚ï¼šæ›²å¯æ•°å¯ç¼–è¾‘ï¼Œä½¿ç”¨é»˜è®¤å€¼
     * - éå®‰æ›²ç¯èŠ‚ï¼ˆä¸€ç¿»/äºŒç¿»/æ‹†æ›²ï¼‰ï¼šä»å®‰æ›²è®°å½•è·å–æ›²å¯æ•°
     */
    updateStageBinInfos(bins: BinCode[]) {
      const infos: StageBinInfo[] = [];
      const missingBins: string[] = [];

      // åˆ¤æ–­æ˜¯å¦éœ€è¦ä»å®‰æ›²è®°å½•è·å–æ›²å¯æ•°
      const needFetchFromAnQu =
        this.stageCode == "YI_FAN" ||
        this.stageCode == "ER_FAN" ||
        this.stageCode == "CHAI_QU";

      for (let i = 0; i < bins.length; i++) {
        const bin = bins[i];
        const binCode = `${bin.class_no}-${bin.floor_no}-${bin.seq_no}`;
        // ä½¿ç”¨ç´¢å¼•+1ä½œä¸ºä¸´æ—¶ bin_idï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä»å­˜å‚¨å±‚è·å–çœŸå®IDï¼‰
        const binId = i + 1;

        let kojiCount = 0;

        if (needFetchFromAnQu) {
          // éå®‰æ›²ç¯èŠ‚ï¼šä»å®‰æ›²è®°å½•è·å–æ›²å¯æ•°
          const result = getBinKojiCountFromAnQu(binId);
          if (result.found == true) {
            kojiCount = result.kojiCount;
          } else {
            // è®°å½•ç¼ºå¤±å®‰æ›²è®°å½•çš„ä»“
            missingBins.push(binCode);
            kojiCount = 0;
          }
        } else {
          // å®‰æ›²ç¯èŠ‚ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œç”¨æˆ·å¯ç¼–è¾‘
          kojiCount = 1260;
        }

        infos.push({
          bin_id: binId,
          stage_bin_id: binId,
          koji_count: kojiCount,
          bin_code: binCode,
        } as StageBinInfo);
      }

      this.stageBinInfos = infos;
      this.missingAnQuBins = missingBins;
    },

    /**
     * è·¨ä»“å²—ä½åˆ†é…å˜æ›´
     */
    onCrossBinChange(payload: UTSJSONObject) {
      if (this.isRestoring == true || this.viewMode != "edit") {
        return;
      }
      const personId = payload["person_id"];
      const personName = payload["person_name"];
      const pointsUnits = payload["points_units"];
      const sources = payload["sources"];

      // æ›´æ–°äººå‘˜äº’æ–¥åˆ—è¡¨
      if (this.crossBinPersonId != null) {
        // ç§»é™¤æ—§çš„äººå‘˜
        const oldIdx = this.occupiedIds.indexOf(
          this.crossBinPersonId as number,
        );
        if (oldIdx != -1) {
          this.occupiedIds.splice(oldIdx, 1);
        }
      }

      if (personId != null) {
        this.crossBinPersonId = personId as number;
        this.crossBinPersonName = personName as string;
        // æ·»åŠ æ–°äººå‘˜åˆ°äº’æ–¥åˆ—è¡¨
        if (this.occupiedIds.indexOf(this.crossBinPersonId as number) == -1) {
          this.occupiedIds.push(this.crossBinPersonId as number);
        }
      } else {
        this.crossBinPersonId = null;
        this.crossBinPersonName = "";
      }

      if (pointsUnits != null) {
        this.crossBinPointsUnits = pointsUnits as number;
      }

      if (sources != null) {
        this.crossBinSources = sources as AssignmentSourceCreateParams[];
      }
      // è·¨ä»“å·¥åˆ†å˜æ›´åé‡æ–°è®¡ç®—åˆ†é…
      this.recalculateCrossBinSources();
      // è§¦å‘è‡ªåŠ¨ä¿å­˜
      this.scheduleAutoSave();
    },

    /**
     * è·å–æŒ‡å®šå‘é…µä»“çš„è·¨ä»“æ‰£é™¤å·¥åˆ†
     * @param stageBinId å‘é…µä»“ ID
     * @returns ä»è¯¥ä»“æ‰£é™¤çš„è·¨ä»“å·¥åˆ†å•ä½
     */
    getCrossBinDeduction(stageBinId: number): PointsUnits {
      // å¦‚æœè·¨ä»“åŒºåŸŸæœªæ˜¾ç¤ºï¼Œè¿”å› 0
      if (this.showCrossBinSection == false) {
        return 0;
      }
      // ä» crossBinSources ä¸­æŸ¥æ‰¾å¯¹åº”ä»“çš„æ‰£é™¤å€¼
      for (let i = 0; i < this.crossBinSources.length; i++) {
        const source = this.crossBinSources[i];
        if (source.stage_bin_id == stageBinId) {
          return source.source_points_units;
        }
      }
      return 0;
    },

    /**
     * è·å–æŒ‡å®šä»“çš„å·¥äººåˆ†é…æ•°æ®ï¼ˆç”¨äºåˆå§‹åŒ–ä»“å¡ç‰‡ï¼‰
     */
    getBinWorkers(stageBinId: number): UTSJSONObject[] {
      const cardData = this.binCardsData.get(stageBinId);
      if (cardData != null) {
        const workers: UTSJSONObject[] = [];
        for (let i = 0; i < cardData.workers.length; i++) {
          const w = cardData.workers[i];
          workers.push({
            personId: w.personId,
            personName: w.personName,
            pointsUnits: w.pointsUnits,
            deductedUnits: w.deductedUnits,
            penaltyReason: w.penaltyReason,
            penaltyId: w.penaltyId,
          } as UTSJSONObject);
        }
        return workers;
      }
      return [] as UTSJSONObject[];
    },

    /**
     * ä»“å¡ç‰‡æ•°æ®å˜æ›´
     */
    onBinCardChange(payload: UTSJSONObject) {
      if (this.isRestoring == true || this.viewMode != "edit") {
        return;
      }
      const stageBinId = payload["stageBinId"] as number;
      const binId = payload["binId"] as number;
      const binCode = payload["binCode"] as string;
      const kojiCount = payload["kojiCount"] as number;
      const totalPointsUnits = payload["totalPointsUnits"] as number;
      const assignedUnits = payload["assignedUnits"] as number;
      const workersData = payload["workers"] as UTSJSONObject[];

      // è§£æå·¥äººæ•°æ®
      const workers: BinWorkerData[] = [];
      for (let i = 0; i < workersData.length; i++) {
        const w = workersData[i];
        workers.push({
          personId: w["personId"] != null ? (w["personId"] as number) : null,
          personName:
            w["personName"] != null ? (w["personName"] as string) : "",
          pointsUnits:
            w["pointsUnits"] != null ? (w["pointsUnits"] as number) : 0,
          positionIndex:
            w["positionIndex"] != null ? (w["positionIndex"] as number) : i + 1,
          deductedUnits:
            w["deductedUnits"] != null ? (w["deductedUnits"] as number) : 0,
          penaltyReason:
            w["penaltyReason"] != null ? (w["penaltyReason"] as string) : "",
          penaltyId: w["penaltyId"] != null ? (w["penaltyId"] as number) : null,
        } as BinWorkerData);
      }

      // æ›´æ–°ä»“å¡ç‰‡æ•°æ®
      this.binCardsData.set(stageBinId, {
        stageBinId: stageBinId,
        binId: binId,
        binCode: binCode,
        kojiCount: kojiCount,
        totalPointsUnits: totalPointsUnits,
        assignedUnits: assignedUnits,
        workers: workers,
      } as BinCardData);

      // æ›´æ–°äººå‘˜äº’æ–¥åˆ—è¡¨
      this.updateOccupiedIds();
      // è§¦å‘è‡ªåŠ¨ä¿å­˜
      this.scheduleAutoSave();
    },

    /**
     * ä»“æ›²å¯æ•°å˜æ›´ï¼ˆç”¨äºåˆ·æ–°å½“æ—¥å®‰æ›²æ€»æ›²å¯æ•°ï¼‰
     * æ³¨æ„ï¼šbiz-bin-card ä¼šåŒæ—¶è§¦å‘ change å’Œ kojiChange äº‹ä»¶
     * è‡ªåŠ¨ä¿å­˜å·²åœ¨ onBinCardChange ä¸­è°ƒåº¦ï¼Œæ­¤å¤„ä¸é‡å¤è°ƒåº¦
     */
    onBinKojiChange(payload: UTSJSONObject) {
      const stageBinId = payload["stageBinId"] as number;
      const kojiCount = payload["kojiCount"] as number;
      const totalPointsUnits = payload["totalPointsUnits"] as number;

      // æ›´æ–° stageBinInfos ä¸­çš„æ›²å¯æ•°
      for (let i = 0; i < this.stageBinInfos.length; i++) {
        if (this.stageBinInfos[i].stage_bin_id == stageBinId) {
          this.stageBinInfos[i].koji_count = kojiCount;
          break;
        }
      }

      // æ›´æ–°ä»“å¡ç‰‡æ•°æ®ä¸­çš„æ›²å¯æ•°
      const cardData = this.binCardsData.get(stageBinId);
      if (cardData != null) {
        cardData.kojiCount = kojiCount;
        cardData.totalPointsUnits = totalPointsUnits;
      }

      // æ›´æ–°æ™¾å ‚æ± å­æ€»åˆ†ç¼“å­˜ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
      if (this.showLiangTangSection == true) {
        this.updateLiangTangPoolCache();
      }

      // æ›²å¯æ•°å˜æ›´åé‡æ–°è®¡ç®—è·¨ä»“å·¥åˆ†åˆ†é…
      this.recalculateCrossBinSources();
      // ä¸åœ¨æ­¤å¤„è°ƒç”¨ scheduleAutoSave()ï¼Œé¿å…é‡å¤è°ƒåº¦
      // biz-bin-card ä¼šåŒæ—¶è§¦å‘ change äº‹ä»¶ï¼Œå·²åœ¨ onBinCardChange ä¸­è°ƒåº¦
    },

    /**
     * æ›´æ–°äººå‘˜äº’æ–¥åˆ—è¡¨
     */
    updateOccupiedIds() {
      const idsSet = new Set<number>();

      // æ·»åŠ è·¨ä»“å²—ä½äººå‘˜
      if (this.crossBinPersonId != null) {
        idsSet.add(this.crossBinPersonId as number);
      }

      // æ·»åŠ æ‰€æœ‰ä»“å¡ç‰‡ä¸­çš„äººå‘˜ï¼ˆUTS Map ä½¿ç”¨ forEach éå†ï¼‰
      this.binCardsData.forEach((cardData: BinCardData, _key: number) => {
        for (let i = 0; i < cardData.workers.length; i++) {
          const worker = cardData.workers[i];
          if (worker.personId != null) {
            idsSet.add(worker.personId as number);
          }
        }
      });

      // æ·»åŠ æ™¾å ‚å²—ä½äººå‘˜
      this.liangTangRolesData.forEach(
        (roleData: LiangTangRoleData, _key: string) => {
          for (let i = 0; i < roleData.workers.length; i++) {
            const worker = roleData.workers[i];
            if (worker.personId != null) {
              idsSet.add(worker.personId as number);
            }
          }
        },
      );

      // è½¬æ¢ä¸ºæ•°ç»„
      const ids: number[] = [];
      idsSet.forEach((id: number) => {
        ids.push(id);
      });
      this.occupiedIds = ids;
    },

    /**
     * è·³è½¬åˆ°å®‰æ›²å½•å…¥é¡µé¢
     */
    goToAnQuEntry() {
      uni.navigateTo({
        url: "/pages/work/entry?stage=AN_QU",
      });
    },

    // ============================================
    // æ—¥æœŸé€‰æ‹©å¼¹çª—æ“ä½œ
    // ============================================

    /**
     * æ‰“å¼€æ—¥æœŸé€‰æ‹©å¼¹çª—
     */
    onOpenDatePicker() {
      // å…è®¸åœ¨åªè¯»æ¨¡å¼ä¸‹åˆ‡æ¢æ—¥æœŸï¼šç”¨äºæŸ¥çœ‹/å½•å…¥å…¶ä»–æ—¥æœŸ
      this.tempDate = this.sessionDate;
      this.showDatePicker = true;
    },

    /**
     * å…³é—­æ—¥æœŸé€‰æ‹©å¼¹çª—
     */
    onCloseDatePicker() {
      this.showDatePicker = false;
    },

    /**
     * æ—¥æœŸå‡ä¸€å¤©
     */
    onDateDecrease() {
      this.tempDate = addDaysToDate(this.tempDate, -1);
    },

    /**
     * æ—¥æœŸåŠ ä¸€å¤©
     */
    onDateIncrease() {
      this.tempDate = addDaysToDate(this.tempDate, 1);
    },

    /**
     * å–æ¶ˆæ—¥æœŸé€‰æ‹©
     */
    onCancelDatePicker() {
      this.showDatePicker = false;
    },

    /**
     * ç¡®è®¤æ—¥æœŸé€‰æ‹©
     */
    onConfirmDatePicker() {
      this.showDatePicker = false;
      const newDate = this.tempDate;
      if (newDate == this.sessionDate) {
        return;
      }
      this.requestSwitchDate(newDate);
    },

    // ============================================
    // æ—¥æœŸåˆ‡æ¢æ§åˆ¶å™¨ï¼ˆå•æ¬¡é£è¡Œæ¨¡å¼ï¼‰
    // ============================================

    /**
     * è¯·æ±‚åˆ‡æ¢æ—¥æœŸï¼ˆå•æ¬¡é£è¡Œæ§åˆ¶å™¨ï¼‰
     * å¦‚æœæ­£åœ¨åˆ‡æ¢ï¼Œå°†è¯·æ±‚åˆå¹¶åˆ° pendingDate
     */
    requestSwitchDate(targetDate: string) {
      if (targetDate == this.sessionDate) {
        return;
      }

      if (this.isSwitching == true) {
        // æ­£åœ¨åˆ‡æ¢ï¼Œåˆå¹¶è¯·æ±‚
        this.pendingDate = targetDate;
        return;
      }

      this.performSwitchDate(targetDate);
    },

    /**
     * æ‰§è¡Œæ—¥æœŸåˆ‡æ¢ï¼ˆåŸå­çŠ¶æ€äº¤æ¢ï¼‰
     */
    performSwitchDate(targetDate: string) {
      this.isSwitching = true;
      const seq = ++this.switchSeq;

      // 1. æ•è·å½“å‰æ—¥æœŸï¼ˆç”¨äºä¿å­˜è‰ç¨¿ï¼‰
      const fromDate = this.sessionDate;

      // 2. ä¿å­˜å½“å‰è‰ç¨¿ï¼ˆä½¿ç”¨ fromDate ç¡®ä¿æ—¥æœŸå®‰å…¨ï¼‰
      this.flushDraftIfNeeded(fromDate);

      // 3. åœ¨ setTimeout ä¸­æ„å»ºå’Œåº”ç”¨æ–°çŠ¶æ€
      setTimeout(() => {
        // åºåˆ—å·æ£€æŸ¥ï¼ˆå¦‚æœä¸åŒ¹é…ï¼Œæ¸…ç†çŠ¶æ€åé€€å‡ºï¼‰
        if (seq != this.switchSeq) {
          this.isSwitching = false;
          return;
        }

        try {
          // 4. æ„å»ºæ–°çŠ¶æ€
          const nextState = this.buildStateForDate(targetDate);

          // 5. åº”ç”¨æ–°çŠ¶æ€
          this.applyState(nextState);
        } catch (e) {
          console.error('æ—¥æœŸåˆ‡æ¢å¤±è´¥:', e);
          uni.showToast({
            title: 'åˆ‡æ¢å¤±è´¥',
            icon: 'none'
          });
        } finally {
          // 6. åˆ‡æ¢å®Œæˆï¼ˆç¡®ä¿çŠ¶æ€æ¸…ç†ï¼‰
          this.isSwitching = false;

          // 7. å¤„ç†å¾…å¤„ç†çš„æ—¥æœŸ
          if (this.pendingDate != null) {
            const pending = this.pendingDate;
            this.pendingDate = null;
            this.requestSwitchDate(pending);
          }
        }
      }, 0);
    },

    /**
     * æ„å»ºæŒ‡å®šæ—¥æœŸçš„çŠ¶æ€å¯¹è±¡ï¼ˆæ— å‰¯ä½œç”¨ï¼‰
     */
    buildStateForDate(date: string): UTSJSONObject {
      // åŠ è½½ä¼šè¯æ•°æ®
      const sessionData = loadSessionForEdit(date, this.stageCode, this.roundId);

      if (sessionData == null) {
        // æ— å·²æœ‰æ•°æ®ï¼Œè¿”å›é»˜è®¤æ–°å»ºçŠ¶æ€
        // åŠ è½½æ™¾å ‚é»˜è®¤äººå‘˜ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
        const defaultLiangTangData = this.loadLiangTangDefaultsForNewSession();

        const activeCoefSetId = getActiveCoefSetId();
        return {
          hasData: false,
          sessionDate: date,
          coefSetId: activeCoefSetId,
          coefSnapshot: loadCoefSetById(activeCoefSetId),
          selectedBins: [] as BinCode[],
          stageBinInfos: [] as StageBinInfo[],
          binCardsData: new Map<number, BinCardData>(),
          occupiedIds: [] as number[],
          showCrossBinSection: stageHasCrossBinRole(this.stageCode),
          crossBinPersonId: null,
          crossBinPersonName: '',
          crossBinPointsUnits: 0,
          crossBinSources: [] as AssignmentSourceCreateParams[],
          liangTangRolesData: defaultLiangTangData['rolesData'],
          wheatMaterialWorkers: defaultLiangTangData['wheatMaterialWorkers'],
          machineGuardWorkers: defaultLiangTangData['machineGuardWorkers'],
          kojiUnloaderWorkers: defaultLiangTangData['kojiUnloaderWorkers'],
          microOperatorWorkers: defaultLiangTangData['microOperatorWorkers'],
          sessionStatus: 'draft',
          viewMode: 'edit',
          sessionRemark: '',
          createdByManager: getManagerName().trim(),
          updatedByManager: getManagerName().trim(),
          missingAnQuBins: [] as string[]
        } as UTSJSONObject;
      }

      // è§£æå·²æœ‰æ•°æ®
      const state = {} as UTSJSONObject;
      state['hasData'] = true;
      state['sessionDate'] = date;

      // ç³»æ•°ç‰ˆæœ¬
      const coefSetId = sessionData['coef_set_id'] as number | null;
      state['coefSetId'] = coefSetId != null ? coefSetId : DEFAULT_COEF_SET_ID;

      // ç³»æ•°å¿«ç…§
      const savedSnapshot = sessionData['coef_snapshot'] as UTSJSONObject | null;
      if (savedSnapshot != null) {
        state['coefSnapshot'] = savedSnapshot;
      } else {
        state['coefSnapshot'] = loadCoefSetById(state['coefSetId'] as number);
      }

      // å‘é…µä»“æ•°æ®
      const binsData = sessionData['bins'] as UTSJSONObject[] | null;
      const bins: BinCode[] = [];
      const infos: StageBinInfo[] = [];
      const cardsData = new Map<number, BinCardData>();
      const missingBins: string[] = [];

      if (binsData != null && binsData.length > 0) {
        for (let i = 0; i < binsData.length; i++) {
          const binObj = binsData[i];
          const classNo = binObj['class_no'] as number | null;
          const floorNo = binObj['floor_no'] as number | null;
          const seqNo = binObj['seq_no'] as number | null;
          const binId = binObj['bin_id'] as number | null;
          const stageBinId = binObj['stage_bin_id'] as number | null;
          const kojiCount = binObj['koji_count'] as number | null;
          const binCode = binObj['bin_code'] as string | null;

          if (classNo != null && floorNo != null && seqNo != null) {
            bins.push({
              class_no: classNo,
              floor_no: floorNo,
              seq_no: seqNo
            } as BinCode);

            infos.push({
              bin_id: binId != null ? binId : i + 1,
              stage_bin_id: stageBinId != null ? stageBinId : i + 1,
              koji_count: kojiCount != null ? kojiCount : 0,
              bin_code: binCode != null ? binCode : `${classNo}-${floorNo}-${seqNo}`
            } as StageBinInfo);

            // è§£æå·¥äººæ•°æ®
            const workersData = binObj['workers'] as UTSJSONObject[] | null;
            if (workersData != null) {
              const workers: BinWorkerData[] = [];
              for (let j = 0; j < workersData.length; j++) {
                const w = workersData[j];
                workers.push({
                  personId: w['personId'] != null ? (w['personId'] as number) : null,
                  personName: w['personName'] != null ? (w['personName'] as string) : '',
                  pointsUnits: w['pointsUnits'] != null ? (w['pointsUnits'] as number) : 0,
                  positionIndex: w['positionIndex'] != null ? (w['positionIndex'] as number) : j + 1,
                  deductedUnits: w['deductedUnits'] != null ? (w['deductedUnits'] as number) : 0,
                  penaltyReason: w['penaltyReason'] != null ? (w['penaltyReason'] as string) : '',
                  penaltyId: w['penaltyId'] != null ? (w['penaltyId'] as number) : null
                } as BinWorkerData);
              }

              const cardStageBinId = stageBinId != null ? stageBinId : i + 1;
              cardsData.set(cardStageBinId, {
                stageBinId: cardStageBinId,
                binId: binId != null ? binId : i + 1,
                binCode: binCode != null ? binCode : `${classNo}-${floorNo}-${seqNo}`,
                kojiCount: kojiCount != null ? kojiCount : 0,
                totalPointsUnits: binObj['totalPointsUnits'] != null ? (binObj['totalPointsUnits'] as number) : 0,
                assignedUnits: binObj['assignedUnits'] != null ? (binObj['assignedUnits'] as number) : 0,
                workers: workers
              } as BinCardData);
            }
          }
        }
      }

      state['selectedBins'] = bins;
      state['stageBinInfos'] = infos;
      state['binCardsData'] = cardsData;
      state['missingAnQuBins'] = missingBins;

      // è·¨ä»“å²—ä½æ•°æ®
      const crossBinData = sessionData['cross_bin'] as UTSJSONObject | null;
      if (crossBinData != null) {
        const hasCrossBin = crossBinData['enabled'] as boolean | null;

        // ä¿®å¤ï¼šå¦‚æœ enabled=falseï¼Œä¿æŒ falseï¼ˆç”¨æˆ·ä¸»åŠ¨ç§»é™¤ï¼‰
        // åªæœ‰åœ¨ enabled=true æˆ– nullï¼ˆæ—§æ•°æ®ï¼‰æ—¶æ‰æ˜¾ç¤º
        if (hasCrossBin == false) {
          state['showCrossBinSection'] = false;
          state['crossBinPersonId'] = null;
          state['crossBinPersonName'] = '';
          state['crossBinPointsUnits'] = 0;
          state['crossBinSources'] = [] as AssignmentSourceCreateParams[];
        } else if (hasCrossBin == true) {
          state['showCrossBinSection'] = true;
          state['crossBinPersonId'] = crossBinData['person_id'] != null ? (crossBinData['person_id'] as number) : null;
          state['crossBinPersonName'] = crossBinData['person_name'] != null ? (crossBinData['person_name'] as string) : '';
          state['crossBinPointsUnits'] = crossBinData['points_units'] != null ? (crossBinData['points_units'] as number) : 0;

          const roleCode = crossBinData['role_code'] as string | null;
          if (roleCode != null) {
            state['crossBinRoleCode'] = roleCode;
          }

          const sourcesRaw = crossBinData['sources'] as UTSJSONObject[] | null;
          if (sourcesRaw != null && sourcesRaw.length > 0) {
            const parsedSources: AssignmentSourceCreateParams[] = [];
            for (let j = 0; j < sourcesRaw.length; j++) {
              const s = sourcesRaw[j];
              parsedSources.push({
                assignment_id: s['assignment_id'] != null ? (s['assignment_id'] as number) : 0,
                stage_bin_id: s['stage_bin_id'] != null ? (s['stage_bin_id'] as number) : 0,
                source_points_units: s['source_points_units'] != null ? (s['source_points_units'] as number) : 0
              } as AssignmentSourceCreateParams);
            }
            state['crossBinSources'] = parsedSources;
          } else {
            state['crossBinSources'] = [] as AssignmentSourceCreateParams[];
          }
        } else {
          // hasCrossBin == nullï¼ˆæ—§æ•°æ®ï¼‰ï¼Œä½¿ç”¨é»˜è®¤å€¼
          state['showCrossBinSection'] = stageHasCrossBinRole(this.stageCode);
          state['crossBinPersonId'] = null;
          state['crossBinPersonName'] = '';
          state['crossBinPointsUnits'] = 0;
          state['crossBinSources'] = [] as AssignmentSourceCreateParams[];
        }
      } else {
        // æ—  cross_bin æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼
        state['showCrossBinSection'] = stageHasCrossBinRole(this.stageCode);
        state['crossBinPersonId'] = null;
        state['crossBinPersonName'] = '';
        state['crossBinPointsUnits'] = 0;
        state['crossBinSources'] = [] as AssignmentSourceCreateParams[];
      }

      // æ™¾å ‚å²—ä½æ•°æ®
      const liangTangRolesData = new Map<string, LiangTangRoleData>();
      const wheatMaterialWorkers: UTSJSONObject[] = [];
      const machineGuardWorkers: UTSJSONObject[] = [];
      const kojiUnloaderWorkers: UTSJSONObject[] = [];
      const microOperatorWorkers: UTSJSONObject[] = [];

      if (this.showLiangTangSection == true) {
        const liangTangData = sessionData['liang_tang'] as UTSJSONObject | null;
        if (liangTangData != null) {
          const roleKeys: string[] = ['WHEAT_MATERIAL', 'MACHINE_GUARD', 'KOJI_UNLOADER', 'MICRO_OPERATOR'];
          for (let k = 0; k < roleKeys.length; k++) {
            const roleKey = roleKeys[k];
            const roleWorkersRaw = liangTangData[roleKey] as UTSJSONObject[] | null;
            if (roleWorkersRaw != null && roleWorkersRaw.length > 0) {
              const workerList: LiangTangWorkerData[] = [];
              const workersForInit: UTSJSONObject[] = [];
              for (let j = 0; j < roleWorkersRaw.length; j++) {
                const w = roleWorkersRaw[j];
                workerList.push({
                  personId: w['personId'] != null ? (w['personId'] as number) : null,
                  personName: w['personName'] != null ? (w['personName'] as string) : '',
                  pointsUnits: w['pointsUnits'] != null ? (w['pointsUnits'] as number) : 0
                } as LiangTangWorkerData);
                workersForInit.push({
                  personId: w['personId'],
                  personName: w['personName'],
                  pointsUnits: w['pointsUnits']
                } as UTSJSONObject);
              }
              liangTangRolesData.set(roleKey, {
                roleCode: roleKey as RoleCode,
                workers: workerList
              } as LiangTangRoleData);

              if (roleKey == 'WHEAT_MATERIAL') {
                for (let j = 0; j < workersForInit.length; j++) {
                  wheatMaterialWorkers.push(workersForInit[j]);
                }
              } else if (roleKey == 'MACHINE_GUARD') {
                for (let j = 0; j < workersForInit.length; j++) {
                  machineGuardWorkers.push(workersForInit[j]);
                }
              } else if (roleKey == 'KOJI_UNLOADER') {
                for (let j = 0; j < workersForInit.length; j++) {
                  kojiUnloaderWorkers.push(workersForInit[j]);
                }
              } else if (roleKey == 'MICRO_OPERATOR') {
                for (let j = 0; j < workersForInit.length; j++) {
                  microOperatorWorkers.push(workersForInit[j]);
                }
              }
            }
          }
        }
      }

      state['liangTangRolesData'] = liangTangRolesData;
      state['wheatMaterialWorkers'] = wheatMaterialWorkers;
      state['machineGuardWorkers'] = machineGuardWorkers;
      state['kojiUnloaderWorkers'] = kojiUnloaderWorkers;
      state['microOperatorWorkers'] = microOperatorWorkers;

      // ä¼šè¯çŠ¶æ€
      const status = sessionData['status'] as string | null;
      state['sessionStatus'] = status != null ? status : 'draft';
      state['viewMode'] = (status == 'submitted') ? 'view' : 'edit';

      // å¤‡æ³¨
      const remark = sessionData['remark'] as string | null;
      state['sessionRemark'] = remark != null ? remark : '';

      // å®¡è®¡å­—æ®µ
      const createdByManager = sessionData['created_by_manager'] as string | null;
      const updatedByManager = sessionData['updated_by_manager'] as string | null;
      state['createdByManager'] = createdByManager != null ? createdByManager : '';
      state['updatedByManager'] = updatedByManager != null ? updatedByManager : '';

      // occupiedIds å°†åœ¨ applyState ä¸­è®¡ç®—
      state['occupiedIds'] = [] as number[];

      return state;
    },

    /**
     * åº”ç”¨çŠ¶æ€å¯¹è±¡åˆ°ç»„ä»¶ï¼ˆåŸå­æ€§æ›¿æ¢ï¼‰
     */
    applyState(nextState: UTSJSONObject) {
      try {
        this.isRestoring = true;

        // åº”ç”¨æ‰€æœ‰çŠ¶æ€å­—æ®µ
        this.sessionDate = nextState['sessionDate'] as string;
        this.tempDate = this.sessionDate;
        this.coefSetId = nextState['coefSetId'] as number | null;
        this.coefSnapshot = nextState['coefSnapshot'] as UTSJSONObject | null;
        this.selectedBins = nextState['selectedBins'] as BinCode[];
        this.stageBinInfos = nextState['stageBinInfos'] as StageBinInfo[];
        this.binCardsData = nextState['binCardsData'] as Map<number, BinCardData>;
        this.missingAnQuBins = nextState['missingAnQuBins'] as string[];
        this.showCrossBinSection = nextState['showCrossBinSection'] as boolean;
        this.crossBinPersonId = nextState['crossBinPersonId'] as number | null;
        this.crossBinPersonName = nextState['crossBinPersonName'] as string;
        this.crossBinPointsUnits = nextState['crossBinPointsUnits'] as number;
        this.crossBinSources = nextState['crossBinSources'] as AssignmentSourceCreateParams[];

        // è·¨ä»“å²—ä½é…ç½®
        const crossBinRoleCode = nextState['crossBinRoleCode'] as string | null;
        if (crossBinRoleCode != null) {
          this.crossBinRoleCode = crossBinRoleCode as RoleCode;
          if (crossBinRoleCode == 'CART_PULLER') {
            this.crossBinRoleName = 'æ‹‰è½¦';
          } else if (crossBinRoleCode == 'HELPER') {
            this.crossBinRoleName = 'æ‰“æ‚';
          }
        } else {
          this.initCrossBinRole();
        }

        this.liangTangRolesData = nextState['liangTangRolesData'] as Map<string, LiangTangRoleData>;
        this.wheatMaterialWorkers = nextState['wheatMaterialWorkers'] as UTSJSONObject[];
        this.machineGuardWorkers = nextState['machineGuardWorkers'] as UTSJSONObject[];
        this.kojiUnloaderWorkers = nextState['kojiUnloaderWorkers'] as UTSJSONObject[];
        this.microOperatorWorkers = nextState['microOperatorWorkers'] as UTSJSONObject[];
        this.sessionStatus = nextState['sessionStatus'] as string;
        this.viewMode = nextState['viewMode'] as 'edit' | 'view';
        this.sessionRemark = nextState['sessionRemark'] as string;
        this.createdByManager = nextState['createdByManager'] as string;
        this.updatedByManager = nextState['updatedByManager'] as string;

        // ä¿®å¤ï¼šé‡æ–°è®¡ç®— microEnabledï¼ˆåŸºäº roundIdï¼‰
        if (this.showLiangTangSection == true && this.roundId != null) {
          this.microEnabled = isMicroEnabledByRoundId(this.roundId as number);
        }

        // é‡æ–°è®¡ç®—æ´¾ç”Ÿæ•°æ®
        this.updateOccupiedIds();
        this.recalculateCrossBinSources();

        // æ›´æ–°æ™¾å ‚æ± å­æ€»åˆ†ç¼“å­˜ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
        if (this.showLiangTangSection == true) {
          this.updateLiangTangPoolCache();
        }

        // é‡ç½®è‡ªåŠ¨ä¿å­˜çŠ¶æ€
        this.draftRevision = 0;
        this.savedRevision = 0;
      } finally {
        // ç¡®ä¿ isRestoring æ€»æ˜¯è¢«é‡ç½®
        this.isRestoring = false;
      }
    },

    /**
     * æ—¥æœŸå®‰å…¨çš„è‰ç¨¿ä¿å­˜
     * ä½¿ç”¨ä¼ å…¥çš„ fromDate å‚æ•°ä¿å­˜è‰ç¨¿ï¼Œé¿å…æ—¥æœŸæ··æ·†
     */
    flushDraftIfNeeded(fromDate: string) {
      this.cancelAutoSave();
      if (this.sessionStatus == 'draft' && this.isSubmitting == false) {
        uni.hideKeyboard();
        try {
          const sessionData = this.buildSessionData('draft');
          saveDraftSession(fromDate, this.stageCode, this.roundId, sessionData);
          this.savedRevision = this.draftRevision;
        } catch (e) {
          console.error('ä¿å­˜è‰ç¨¿å¤±è´¥:', e);
        }
      }
    },

    // ============================================
    // å¤‡æ³¨å¼¹çª—æ“ä½œ
    // ============================================

    /**
     * æ‰“å¼€å¤‡æ³¨å¼¹çª—
     */
    onOpenRemarkPopup() {
      // åªè¯»æ¨¡å¼ä¸‹ç¦æ­¢ä¿®æ”¹å¤‡æ³¨
      if (this.viewMode == "view") {
        return;
      }
      this.tempRemark = this.sessionRemark;
      this.showRemarkPopup = true;
    },

    /**
     * å¤‡æ³¨è¾“å…¥å¤„ç†
     */
    onRemarkInput(e: UniInputEvent) {
      this.tempRemark = e.detail.value;
    },

    /**
     * å…³é—­å¤‡æ³¨å¼¹çª—
     */
    onCloseRemarkPopup() {
      this.showRemarkPopup = false;
    },

    /**
     * å–æ¶ˆå¤‡æ³¨è¾“å…¥
     */
    onCancelRemarkPopup() {
      this.showRemarkPopup = false;
    },

    /**
     * ç¡®è®¤å¤‡æ³¨è¾“å…¥
     */
    onConfirmRemarkPopup() {
      // æ£€æŸ¥å¤‡æ³¨æ˜¯å¦çœŸæ­£æ”¹å˜
      if (this.tempRemark == this.sessionRemark) {
        this.showRemarkPopup = false;
        return;
      }

      this.sessionRemark = this.tempRemark;
      this.showRemarkPopup = false;

      // ç«‹å³ä¿å­˜ï¼ˆå–æ¶ˆå®šæ—¶å™¨ï¼Œç›´æ¥æ‰§è¡Œä¿å­˜ï¼‰
      this.cancelAutoSave();
      this.draftRevision = this.draftRevision + 1;
      this.doAutoSave();

      uni.showToast({
        title: "å¤‡æ³¨å·²ä¿å­˜",
        icon: "success",
      });
    },

    // ============================================
    // æ—§çš„æ—¥æœŸåˆ‡æ¢æ–¹æ³•ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
    // ============================================

    /**
     * åˆ‡æ¢ä¼šè¯æ—¥æœŸï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ requestSwitchDate æ›¿ä»£ï¼‰
     * ä¿ç•™æ­¤æ–¹æ³•ç”¨äºå‘åå…¼å®¹
     */
    switchSessionDate(newDate: string) {
      this.requestSwitchDate(newDate);
    },

    /**
     * é‡ç½®ä¼šè¯ç¼–è¾‘çŠ¶æ€ï¼ˆä¸æ”¹å˜ç¯èŠ‚é…ç½®ï¼‰
     * å·²åºŸå¼ƒï¼šä½¿ç”¨ buildStateForDate + applyState æ›¿ä»£
     */
    resetSessionState() {
      // æ­¤æ–¹æ³•å·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹
      // æ–°çš„æ—¥æœŸåˆ‡æ¢æµç¨‹ä¸å†è°ƒç”¨æ­¤æ–¹æ³•
      console.warn('resetSessionState() is deprecated, use buildStateForDate + applyState instead');

      this.selectedBins = [] as BinCode[];
      this.stageBinInfos = [] as StageBinInfo[];
      this.occupiedIds = [] as number[];
      this.binCardsData = new Map<number, BinCardData>();
      this.missingAnQuBins = [] as string[];

      // é‡ç½®è·¨ä»“å²—ä½ä¸ºé»˜è®¤çŠ¶æ€ï¼ˆç”±ç¯èŠ‚å†³å®šæ˜¯å¦æ˜¾ç¤ºï¼‰
      this.showCrossBinSection = stageHasCrossBinRole(this.stageCode);
      this.initCrossBinRole();
      this.crossBinPersonId = null;
      this.crossBinPersonName = "";
      this.crossBinPointsUnits = 0;
      this.crossBinSources = [] as AssignmentSourceCreateParams[];

      // é‡ç½®æ™¾å ‚å²—ä½æ•°æ®
      this.liangTangRolesData = new Map<string, LiangTangRoleData>();
      this.wheatMaterialWorkers = [] as UTSJSONObject[];
      this.machineGuardWorkers = [] as UTSJSONObject[];
      this.kojiUnloaderWorkers = [] as UTSJSONObject[];
      this.microOperatorWorkers = [] as UTSJSONObject[];
      // é‡æ–°åŠ è½½æ™¾å ‚é»˜è®¤äººå‘˜
      if (this.showLiangTangSection == true) {
        this.loadLiangTangDefaults();
      }

      // è‡ªåŠ¨ä¿å­˜ç›¸å…³çŠ¶æ€é‡ç½®
      this.draftRevision = 0;
      this.savedRevision = 0;
      this.sessionStatus = "draft";

      // é‡ç½®å¤‡æ³¨
      this.sessionRemark = "";
      this.tempRemark = "";
      this.showRemarkPopup = false;

      // é‡ç½®å®¡è®¡å­—æ®µ
      this.createdByManager = "";
      this.updatedByManager = "";
    },

    /**
     * åŠ è½½å·²æœ‰ä¼šè¯æ•°æ®ï¼ˆdraft ä¼˜å…ˆï¼‰
     * å·²åºŸå¼ƒï¼šä½¿ç”¨ buildStateForDate + applyState æ›¿ä»£
     */
    loadExistingSession() {
      // æ­¤æ–¹æ³•å·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹
      console.warn('loadExistingSession() is deprecated, use buildStateForDate + applyState instead');

      // ä½¿ç”¨æ–°çš„åŸå­çŠ¶æ€äº¤æ¢æ–¹å¼
      const nextState = this.buildStateForDate(this.sessionDate);
      this.applyState(nextState);
    },

    /**
     * æ„å»ºä¼šè¯æ•°æ®å¯¹è±¡
     * @param status ä¼šè¯çŠ¶æ€
     * @returns ä¼šè¯æ•°æ®å¯¹è±¡
     */
    buildSessionData(status: string): UTSJSONObject {
      // ç¡®ä¿ coefSnapshot éç©ºï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
      if (this.coefSnapshot == null && this.coefSetId != null) {
        const setData = loadCoefSetById(this.coefSetId as number);
        if (setData != null) {
          this.coefSnapshot = setData;
        }
      }

      // å®¡è®¡å­—æ®µï¼šç®¡ç†å‘˜å§“åå¿«ç…§ï¼ˆé¿å…é…ç½®ä¸ºç©ºæ—¶è¦†ç›–æ—§å€¼ï¼‰
      const managerName = getManagerName().trim();
      if (managerName != "") {
        if (this.createdByManager == "") {
          this.createdByManager = managerName;
        }
        this.updatedByManager = managerName;
      }

      // æ„å»ºå‘é…µä»“æ•°æ®
      const binsData: UTSJSONObject[] = [];
      for (let i = 0; i < this.stageBinInfos.length; i++) {
        const info = this.stageBinInfos[i];
        const cardData = this.binCardsData.get(info.stage_bin_id);

        // æ„å»ºå·¥äººæ•°æ®
        const workersData: UTSJSONObject[] = [];
        if (cardData != null) {
          for (let j = 0; j < cardData.workers.length; j++) {
            const w = cardData.workers[j];
            workersData.push({
              personId: w.personId,
              personName: w.personName,
              pointsUnits: w.pointsUnits,
              positionIndex: w.positionIndex,
              deductedUnits: w.deductedUnits,
              penaltyReason: w.penaltyReason,
              penaltyId: w.penaltyId,
            } as UTSJSONObject);
          }
        }

        // ä» selectedBins è·å–åŸå§‹ BinCode
        let classNo = 0;
        let floorNo = 0;
        let seqNo = 0;
        if (i < this.selectedBins.length) {
          classNo = this.selectedBins[i].class_no;
          floorNo = this.selectedBins[i].floor_no;
          seqNo = this.selectedBins[i].seq_no;
        }

        binsData.push({
          bin_id: info.bin_id,
          stage_bin_id: info.stage_bin_id,
          koji_count: info.koji_count,
          bin_code: info.bin_code,
          class_no: classNo,
          floor_no: floorNo,
          seq_no: seqNo,
          totalPointsUnits: cardData != null ? cardData.totalPointsUnits : 0,
          assignedUnits: cardData != null ? cardData.assignedUnits : 0,
          workers: workersData,
        } as UTSJSONObject);
      }

      // æ„å»ºè·¨ä»“å²—ä½æ•°æ®
      // ç›´æ¥ä½¿ç”¨ this.crossBinSourcesï¼Œç¡®ä¿"ç”¨æˆ·çœ‹åˆ°çš„ == ä¿å­˜çš„"
      const crossBinData = {
        enabled: this.showCrossBinSection,
        role_code: this.crossBinRoleCode,
        role_name: this.crossBinRoleName,
        person_id: this.crossBinPersonId,
        person_name: this.crossBinPersonName,
        points_units: this.crossBinPointsUnits,
        sources: this.crossBinSources,
      } as UTSJSONObject;

      // æ„å»ºæ™¾å ‚å²—ä½æ•°æ®ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
      let liangTangData: UTSJSONObject | null = null;
      if (this.showLiangTangSection == true) {
        liangTangData = {} as UTSJSONObject;
        const roleKeys: string[] = [
          "WHEAT_MATERIAL",
          "MACHINE_GUARD",
          "KOJI_UNLOADER",
          "MICRO_OPERATOR",
        ];
        for (let k = 0; k < roleKeys.length; k++) {
          const roleKey = roleKeys[k];
          const roleData = this.liangTangRolesData.get(roleKey);
          if (roleData != null) {
            const workersData: UTSJSONObject[] = [];
            for (let j = 0; j < roleData.workers.length; j++) {
              const w = roleData.workers[j];
              workersData.push({
                personId: w.personId,
                personName: w.personName,
                pointsUnits: w.pointsUnits,
              } as UTSJSONObject);
            }
            liangTangData[roleKey] = workersData;
          }
        }
      }

      // æ„å»ºå®Œæ•´ä¼šè¯æ•°æ®
      const sessionData = {
        status: status,
        created_by_manager: this.createdByManager,
        updated_by_manager: this.updatedByManager,
        session_date: this.sessionDate,
        stage_code: this.stageCode,
        stage_name: this.stageName,
        round_id: this.roundId,
        coef_set_id: this.coefSetId,
        coef_snapshot: this.coefSnapshot,
        bins: binsData,
        cross_bin: crossBinData,
        liang_tang: liangTangData,
        remark: this.sessionRemark,
        timestamp: getCurrentTimestamp(),
      } as UTSJSONObject;

      return sessionData;
    },

    /**
     * ä¿å­˜è‰ç¨¿
     */
    /**
     * æäº¤ç¡®è®¤
     */
    submit() {
      try {
        // 1. æ„å»ºæäº¤æ•°æ®
        const sessionData = this.buildSessionData("submitted");

        // 2. æ„å»ºæ ¡éªŒä¸Šä¸‹æ–‡
        const ctx = {
          mode: "submit",
          locale: "zh-CN" as "zh-CN",
          stage_code: this.stageCode,
          round_id: this.roundId,
          micro_enabled: this.microEnabled,
          manager_name: getManagerName().trim()
        } as ValidationContext;

        // 3. è°ƒç”¨æ ¡éªŒå¼•æ“
        const result = validateSessionData(sessionData, ctx);

        // 4. å¤„ç†æ ¡éªŒç»“æœ
        if (result.is_valid == false) {
          uni.showModal({
            title: "æ— æ³•æäº¤",
            content: formatErrorsForModal(result),
            showCancel: false
          });
          return;
        }

        // 5. ç”¨æˆ·ç¡®è®¤åæäº¤
        this.confirmAndSubmit(sessionData);
      } catch (e : any) {
        // æ•è·æ ¡éªŒå¼•æ“å¼‚å¸¸
        console.error("æ ¡éªŒå¼•æ“é”™è¯¯:", e);
        uni.showModal({
          title: "æ ¡éªŒå¤±è´¥",
          content: "æ•°æ®æ ¡éªŒæ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ•°æ®åé‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message,
          showCancel: false
        });
      }
    },

    /**
     * ç¡®è®¤å¹¶æäº¤ä¼šè¯æ•°æ®
     * @param sessionData ä¼šè¯æ•°æ®
     */
    confirmAndSubmit(sessionData: UTSJSONObject) {
      uni.showModal({
        title: "æç¤º",
        content: "ç¡®è®¤æäº¤å·¥åˆ†å½•å…¥ï¼Ÿ",
        success: (res) => {
          if (res.confirm == true) {
            // å–æ¶ˆè‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
            this.cancelAutoSave();
            this.isSubmitting = true;

            try {
              // ä¿å­˜åˆ°å­˜å‚¨
              saveSubmittedSession(
                this.sessionDate,
                this.stageCode,
                this.roundId,
                sessionData,
              );

              // ä¿å­˜æ™¾å ‚é»˜è®¤äººå‘˜é…ç½®ï¼ˆä»…å®‰æ›²ç¯èŠ‚ï¼‰
              this.saveLiangTangDefaultPersons();

              // æ›´æ–°ä¼šè¯çŠ¶æ€
              this.sessionStatus = "submitted";

              uni.showToast({
                title: "æäº¤æˆåŠŸ",
                icon: "success",
              });
              setTimeout(() => {
                uni.navigateBack();
              }, 1000);
            } catch (e) {
              console.error("æäº¤å¤±è´¥:", e);
              uni.showToast({
                title: "æäº¤å¤±è´¥",
                icon: "none",
              });
            } finally {
              this.isSubmitting = false;
            }
          }
        },
      });
    },

    /**
     * ä¿å­˜æ™¾å ‚é»˜è®¤äººå‘˜é…ç½®
     * å°†å½“å‰æ™¾å ‚å²—ä½çš„äººå‘˜ä¿å­˜ä¸ºä¸‹æ¬¡é»˜è®¤å€¼
     */
    saveLiangTangDefaultPersons() {
      if (this.showLiangTangSection == false) {
        return;
      }
      const classNo = getCurrentClassNo();
      const defaults = {} as UTSJSONObject;
      const roleKeys: string[] = [
        "WHEAT_MATERIAL",
        "MACHINE_GUARD",
        "KOJI_UNLOADER",
        "MICRO_OPERATOR",
      ];
      let validRoleCount = 0;
      for (let k = 0; k < roleKeys.length; k++) {
        const roleKey = roleKeys[k];
        const roleData = this.liangTangRolesData.get(roleKey);
        if (roleData != null && roleData.workers.length > 0) {
          const workersData: UTSJSONObject[] = [];
          for (let j = 0; j < roleData.workers.length; j++) {
            const w = roleData.workers[j];
            if (w.personId != null) {
              workersData.push({
                personId: w.personId,
                personName: w.personName,
              } as UTSJSONObject);
            }
          }
          if (workersData.length > 0) {
            defaults[roleKey] = workersData;
            validRoleCount = validRoleCount + 1;
          }
        }
      }
      // åªæœ‰å½“æœ‰æœ‰æ•ˆæ•°æ®æ—¶æ‰ä¿å­˜ï¼Œé¿å…è¦†ç›–å·²æœ‰çš„é»˜è®¤äººå‘˜
      if (validRoleCount > 0) {
        saveLiangTangDefault(classNo, defaults);
      }
    },

    // ============================================
    // è‡ªåŠ¨ä¿å­˜ç›¸å…³æ–¹æ³•
    // ============================================

    /**
     * è°ƒåº¦è‡ªåŠ¨ä¿å­˜ï¼ˆé˜²æŠ–ï¼‰
     * ä»…å¯¹è‰ç¨¿çŠ¶æ€çš„ä¼šè¯ç”Ÿæ•ˆ
     */
    scheduleAutoSave() {
      // åªè¯»æ¨¡å¼æˆ–æ•°æ®æ¢å¤æœŸé—´ä¸è‡ªåŠ¨ä¿å­˜
      if (this.viewMode != "edit" || this.isRestoring == true) {
        return;
      }
      // ç¼–è¾‘æ—¶å§‹ç»ˆè¿›å…¥è‰ç¨¿æ¨¡å¼ï¼ˆè‡ªåŠ¨ä¿å­˜å§‹ç»ˆå†™ draft keyï¼‰
      if (this.sessionStatus != "draft") {
        this.sessionStatus = "draft";
      }
      // æäº¤è¿‡ç¨‹ä¸­ä¸è‡ªåŠ¨ä¿å­˜
      if (this.isSubmitting == true) {
        return;
      }

      // å¢åŠ ä¿®è®¢ç‰ˆæœ¬å·
      this.draftRevision = this.draftRevision + 1;

      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (this.autoSaveTimer != 0) {
        clearTimeout(this.autoSaveTimer);
      }

      // è®¾ç½®é˜²æŠ–å®šæ—¶å™¨
      this.autoSaveTimer = setTimeout(() => {
        this.autoSaveTimer = 0;
        this.doAutoSave();
      }, this.autoSaveDebounceMs);
    },

    /**
     * æ‰§è¡Œè‡ªåŠ¨ä¿å­˜
     * é™é»˜ä¿å­˜ï¼Œä¸æ˜¾ç¤º toast
     */
    doAutoSave() {
      // ä»…å¯¹è‰ç¨¿çŠ¶æ€è‡ªåŠ¨ä¿å­˜
      if (this.sessionStatus != "draft") {
        return;
      }
      // æäº¤è¿‡ç¨‹ä¸­ä¸è‡ªåŠ¨ä¿å­˜
      if (this.isSubmitting == true) {
        return;
      }
      // å¦‚æœæ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡ä¿å­˜
      if (this.draftRevision == this.savedRevision) {
        return;
      }

      try {
        // æ„å»ºä¼šè¯æ•°æ®
        const sessionData = this.buildSessionData("draft");

        // ä¿å­˜åˆ°å­˜å‚¨
        saveDraftSession(
          this.sessionDate,
          this.stageCode,
          this.roundId,
          sessionData,
        );

        // æ›´æ–°å·²ä¿å­˜ç‰ˆæœ¬å·
        this.savedRevision = this.draftRevision;
      } catch (e) {
        console.error("è‡ªåŠ¨ä¿å­˜å¤±è´¥:", e);
        // å¤±è´¥å†·å´æœºåˆ¶ï¼šåªåœ¨è·ç¦»ä¸Šæ¬¡é”™è¯¯è¶…è¿‡ 10 ç§’æ—¶æ‰æ˜¾ç¤º toast
        const now = Date.now();
        const cooldownMs = 10000;
        if (now - this.lastAutoSaveErrorTime > cooldownMs) {
          this.lastAutoSaveErrorTime = now;
          uni.showToast({
            title: "è‡ªåŠ¨ä¿å­˜å¤±è´¥",
            icon: "none",
          });
        }
      }
    },

    /**
     * å–æ¶ˆè‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
     */
    cancelAutoSave() {
      if (this.autoSaveTimer != 0) {
        clearTimeout(this.autoSaveTimer);
        this.autoSaveTimer = 0;
      }
    },

    /**
     * é‡æ–°è®¡ç®—è·¨ä»“å·¥åˆ†åˆ†é…
     * å½“æ›²å¯æ•°å˜æ›´ã€ä»“é›†åˆå˜æ›´æˆ–è·¨ä»“å·¥åˆ†å˜æ›´æ—¶è°ƒç”¨
     * ç¡®ä¿ crossBinSources ä¸å½“å‰ stageBinInfos å’Œ crossBinPointsUnits ä¸€è‡´
     */
    recalculateCrossBinSources() {
      // å¦‚æœä¸æ˜¾ç¤ºè·¨ä»“åŒºåŸŸï¼Œæ¸…ç©º sources
      if (this.showCrossBinSection == false) {
        this.crossBinSources = [] as AssignmentSourceCreateParams[];
        return;
      }

      // å¦‚æœè·¨ä»“å·¥åˆ†ä¸º 0ï¼Œæ¸…ç©º sources
      if (this.crossBinPointsUnits <= 0) {
        this.crossBinSources = [] as AssignmentSourceCreateParams[];
        return;
      }

      // å¦‚æœæ²¡æœ‰ä»“ï¼Œæ¸…ç©º sources
      if (this.stageBinInfos.length == 0) {
        this.crossBinSources = [] as AssignmentSourceCreateParams[];
        return;
      }

      // æ„å»º BinInfo æ•°ç»„
      const binInfos: BinInfo[] = [];
      for (let i = 0; i < this.stageBinInfos.length; i++) {
        const bin = this.stageBinInfos[i];
        binInfos.push({
          bin_id: bin.bin_id,
          stage_bin_id: bin.stage_bin_id,
          koji_count: bin.koji_count,
        } as BinInfo);
      }

      // è°ƒç”¨åˆ†é…ç®—æ³•é‡æ–°è®¡ç®—
      const result = allocateCrossBinPoints(binInfos, this.crossBinPointsUnits);
      this.crossBinSources = result.sources;
    },
  },
};
</script>

<style>
.page-container {
  flex: 1;
  flex-direction: column;
  background-color: #f5f5f5;
}

.header-nav {
  background-color: #007aff;
  padding: 12px 16px;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
}

.nav-left,
.nav-next {
  width: 40px;
  height: 40px;
  align-items: center;
  justify-content: center;
}

.nav-icon {
  font-size: 18px;
  color: #ffffff;
}

.nav-center {
  flex: 1;
  flex-direction: column;
  align-items: center;
  padding: 0 12px;
}

.nav-stage {
  font-size: 18px;
  font-weight: bold;
  color: #ffffff;
}

.nav-date {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  margin-top: 2px;
}

.nav-status {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 4px;
  margin-top: 4px;
}

.status-submitted {
  background-color: #34c759;
  color: #ffffff;
}

.status-draft {
  background-color: #ff9500;
  color: #ffffff;
}

.status-editing {
  background-color: #5856d6;
  color: #ffffff;
}

.nav-right {
  flex-direction: row;
  align-items: center;
}

.nav-today {
  padding: 4px 12px;
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  margin-right: 8px;
}

.nav-today-text {
  font-size: 14px;
  color: #ffffff;
}

.nav-calendar {
  width: 32px;
  height: 32px;
  align-items: center;
  justify-content: center;
  margin-right: 8px;
}

.content {
  flex: 1;
}

.section {
  margin: 12px;
  background-color: #ffffff;
  border-radius: 8px;
  padding: 16px;
}

.section-title {
  font-size: 16px;
  font-weight: bold;
  color: #333333;
  margin-bottom: 12px;
}

.bin-cards {
  margin-top: 4px;
}

.liangtang-info {
  flex-direction: row;
  align-items: center;
}

.liangtang-info-text {
  font-size: 12px;
  color: #666666;
}

.micro-disabled-hint {
  padding: 12px;
  background-color: #f5f5f5;
  border-radius: 8px;
  align-items: center;
}

.micro-disabled-text {
  font-size: 13px;
  color: #999999;
}

.section-header {
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.section-header-title {
  margin-bottom: 0;
}

.remove-btn {
  padding: 4px 10px;
  background-color: #fff0f0;
  border-radius: 4px;
}

.remove-btn-text {
  font-size: 12px;
  color: #ff4d4f;
}

.add-section {
  padding: 12px 16px;
}

.add-btn {
  flex-direction: row;
  justify-content: center;
  align-items: center;
  padding: 12px;
  background-color: #f0f7ff;
  border-radius: 6px;
  border-width: 1px;
  border-style: dashed;
  border-color: #007aff;
}

.add-btn-text {
  font-size: 14px;
  color: #007aff;
}

.warning-section {
  background-color: #fffbe6;
  border-width: 1px;
  border-style: solid;
  border-color: #ffe58f;
}

.warning-content {
  flex-direction: column;
  margin-bottom: 12px;
}

.warning-text {
  font-size: 14px;
  color: #d48806;
  line-height: 20px;
}

.warning-hint {
  font-size: 12px;
  color: #d48806;
  margin-top: 4px;
}

.warning-btn {
  background-color: #faad14;
  border-radius: 4px;
  padding: 8px 16px;
  align-self: flex-start;
}

.warning-btn-text {
  font-size: 14px;
  color: #ffffff;
}

.info-row {
  flex-direction: row;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom-width: 1px;
  border-bottom-color: #f0f0f0;
  border-bottom-style: solid;
}

.info-label {
  font-size: 14px;
  color: #666666;
}

.info-value {
  font-size: 14px;
  color: #333333;
}

.remark-row {
}

.remark-value {
  flex: 1;
  text-align: right;
}

.remark-placeholder {
  color: #999999;
}

.placeholder-text {
  font-size: 14px;
  color: #999999;
  text-align: center;
  padding: 40px 0;
}

.footer {
  flex-direction: row;
  padding: 12px 16px;
  background-color: #ffffff;
  border-top-width: 1px;
  border-top-color: #e0e0e0;
  border-top-style: solid;
}

.btn {
  flex: 1;
  height: 44px;
  border-radius: 8px;
  justify-content: center;
  align-items: center;
  margin: 0 6px;
}

.btn-primary {
  background-color: #007aff;
}

.btn-secondary {
  background-color: #f0f0f0;
}

.btn-text {
  font-size: 16px;
  font-weight: bold;
}

.btn-text-primary {
  color: #ffffff;
}

.btn-text-secondary {
  color: #666666;
}

/* å¼¹çª—é®ç½©å±‚ï¼ˆå…±äº«ï¼‰ */
.picker-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
}

/* å…±äº« Modal æ ·å¼ */
.modal-container {
  background-color: #ffffff;
  border-radius: 12px;
  padding: 16px;
}

.modal-header {
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.modal-title {
  font-size: 16px;
  font-weight: bold;
  color: #333333;
}

.modal-close {
  width: 28px;
  height: 28px;
  justify-content: center;
  align-items: center;
  background-color: #f0f2f5;
  border-radius: 14px;
}

.modal-close-text {
  font-size: 14px;
  color: #666666;
}

.modal-actions {
  flex-direction: row;
  justify-content: space-between;
  margin-top: 16px;
}

.modal-btn {
  flex: 1;
  height: 40px;
  justify-content: center;
  align-items: center;
  border-radius: 8px;
  margin: 0 4px;
}

.modal-btn-cancel {
  background-color: #f0f0f0;
}

.modal-btn-confirm {
  background-color: #007aff;
}

.modal-btn-text {
  font-size: 14px;
  font-weight: bold;
}

.modal-btn-text-cancel {
  color: #666666;
}

.modal-btn-text-confirm {
  color: #ffffff;
}

/* æ—¥æœŸé€‰æ‹©å™¨ç‰¹å®šæ ·å¼ */
.date-picker-container {
  width: 300px;
}

.date-picker-content {
  padding: 16px 0;
}

.date-stepper {
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
}

.date-stepper-btn {
  width: 60px;
  height: 40px;
  justify-content: center;
  align-items: center;
  background-color: #f0f2f5;
  border-radius: 8px;
  border-width: 1px;
  border-style: solid;
  border-color: #e8e8e8;
}

.date-stepper-btn-text {
  font-size: 14px;
  color: #333333;
}

.date-display {
  font-size: 18px;
  font-weight: bold;
  color: #333333;
}

/* å¤‡æ³¨å¼¹çª—ç‰¹å®šæ ·å¼ */
.remark-popup-container {
  width: 320px;
}

.remark-popup-content {
  padding: 8px 0;
}

.remark-textarea {
  width: 100%;
  height: 120px;
  padding: 12px;
  font-size: 14px;
  color: #333333;
  background-color: #f5f5f5;
  border-radius: 8px;
  border-width: 1px;
  border-style: solid;
  border-color: #e8e8e8;
}

/* åˆ‡æ¢é®ç½©å±‚æ ·å¼ */
.switch-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.3);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.switch-mask-text {
  font-size: 16px;
  color: #ffffff;
  background-color: rgba(0, 0, 0, 0.7);
  padding: 12px 24px;
  border-radius: 8px;
}

/* scroll-body æ ·å¼ */
.scroll-body {
  flex-direction: column;
  padding-bottom: 20px;
}
</style>
