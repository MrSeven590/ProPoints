# ProPoints 工分管理系统 - 技术方案

> 基于 Codex（后端架构）+ Gemini（前端架构）的综合方案

> 宗旨：本地优先（Local-First），离线可用，后续可扩展云端同步。

- 目标用户：制曲车间班级管理人员
- 技术栈：uni-app x（Vue3 + TypeScript）
- 第一阶段：单机离线（SQLite 本地存储）
- 第二阶段：预留 `uuid/version/sync_status/updated_at` 等字段，升级“本地+云端同步”
- 使用范围：当前仅在“单班级”层次使用（不涉及多班级切换/汇总）

---

## 一、核心设计特点

### 1.1 发酵仓数量动态化
- 支持任意数量发酵仓的动态配置（由用户自行确定）
- 系统不预设数量上限，完全由实际业务需求决定
- 录入默认展示 2 间发酵仓卡片（堆曲除外），可 `+` 添加或 `-` 删除

### 1.2 发酵仓编号结构化
- **编号格式**：`班级-楼层-序号`（如 3-3-1）
- **数据存储**：拆分为三个字段（class_no, floor_no, seq_no）

### 1.3 智能推断系统
- 根据历史记录自动推断下一组发酵仓编号
- 按"顺序递增"原则推荐（如上次 3-3-1、3-3-2 → 推断 3-3-3、3-3-4）
- 到达楼层末尾时自动跳转到下一楼层
- **楼层末尾推断规则**：优先取该班级该楼层历史最大 `seq_no`；若无历史，默认 `24` 为最大 `seq_no`

### 1.4 统一录入模型
- 所有环节（安曲、一次翻曲、二次翻曲、拆曲、堆曲）使用同一录入页面
- 录入模型统一支持三种作用域：`BIN / CROSS_BIN / SESSION`，按环节配置启用（如：堆曲仅 SESSION）
- 路由：`pages/work/entry`，通过参数区分工序类型

### 1.5 整数单位存储
- `points_units = points × 10`（如 12.3分 → 123单位）
- 避免浮点数漂移，确保跨仓抽取计算精确

### 1.6 拼音快速搜索
- 支持姓名首字母、全拼、中文三种匹配方式
- 预计算拼音索引（写入时计算，查询时使用）

---

## 二、核心业务规则

### 2.1 五环节工序流程
```
安曲(Day0) → 一次翻曲(Day7-9) → 二次翻曲(Day14-17) → 拆曲(Day40+) → 堆曲
```

### 2.1.1 标准人员配置（默认值，可调整）

| 环节 | 作用域 | 默认人数 | 可选/备注 |
| --- | --- | --- | --- |
| 安曲 | BIN | 4 | 仓内站位绑定（position_index） |
| 安曲 | CROSS_BIN | 1 | 拉车（服务多仓，按曲坯比例抽取） |
| 一次翻曲 | BIN | 5 | / |
| 一次翻曲 | CROSS_BIN | 1 | 打杂（可选，服务多仓，按曲坯比例抽取） |
| 二次翻曲 | BIN | 4 | / |
| 拆曲 | BIN | 5 | / |
| 拆曲 | CROSS_BIN | 1 | 拉车（服务多仓，按曲坯比例抽取） |
| 堆曲 | SESSION | 2-4 | 独立组；按当日拆曲总曲坯数计分 |

### 2.2 工分计算公式
```
发酵仓总工分（BIN） = floor1(曲坯数量/20 × 工序系数)
floor1(x) = Math.floor(x * 10) / 10  // 向下取1位小数

系数表（可配置）：
- 安曲：1.1
- 一次翻曲：1.25
- 二次翻曲：0.9
- 拆曲：1.12
- 堆曲：0.29（按“会话总量”计分，见下）

堆曲（DuiQu）会话总工分：
- 当日堆曲总曲坯数量 = 当日拆曲环节总曲坯数量：
  - 默认：汇总同一 `session_date` 下所有“拆曲 StageSession”的 StageBin.koji_count（若当日存在多条拆曲录入单则求和；当日拆曲产出都会运送到堆曲，因此不区分轮次）
- 堆曲总工分 = floor1(当日堆曲总曲坯数量/20 × 0.29)

安曲晾堂部分（按每日安曲总曲坯数）：
- 麦料参数：0.85
- 守机：0.8
- 下曲：0.8
- 微机：0.7（需校验“本轮次是否具备计分权”）

晾堂岗位总工分（SESSION）：
- 麦料/守机/下曲/微机各自的“岗位池子”总分 = floor1(当日安曲总曲坯数/20 × 岗位系数)
- 微机岗位仅在本轮次 `micro_enabled=1` 时生成池子并允许分配
```

补充口径（曲坯数量复用/晾堂自动计分）：
- 每个发酵仓的曲坯数量（`koji_count`）仅在安曲环节录入一次，作为该仓后续所有环节的曲坯数量基准；一次翻曲/二次翻曲/拆曲/堆曲录入时自动带出该值。
- 安曲录入时系统实时汇总“当日安曲总曲坯数”（= 本次安曲录入单内所有发酵仓曲坯数量之和），并据此自动计算晾堂各岗位池子总分；岗位仅 1 人时自动把该岗位分值填入该人员（无需手工输入）。

### 2.3 工分分配逻辑
- 跨仓岗位（拉车/打杂）从多间发酵仓按曲坯数量比例抽取工分
- 发酵仓内人员分配剩余工分
- SESSION岗位（安曲晾堂/堆曲组）按“会话总量”计分，不从单个发酵仓扣减
- 校验拆分：BIN平衡 / CROSS_BIN来源平衡 / SESSION池子平衡（见 4.3）

### 2.4 考核系统
- 违反工艺操作扣分
- 记录：考核原因、考核人员、被考核人员、考核分数
- 录入交互：录入页显示【考核】按钮；点击后同一条分配行展示“原始工分 - 扣分”两段输入，并实时计算“最终分”
- 提交落库：原始工分写入 `Assignment.points_units`；扣分明细写入考核表（见 3.2）
- 展示口径：查询时联表汇总扣分，展示“原始工分 / 扣分 / 最终工分”三列（最终 = 原始 - SUM(扣分)）

### 2.5 轮次与微机计分权（离线推断）
- 轮次用于控制“微机(0.7)”是否具备计分权（隔轮次轮换）
- 推断规则：读取上个轮次的 `micro_enabled`；若上个轮次有计分权，则本轮次无（反之亦然）
- 无历史数据：在**首次安曲工分录入**时弹窗询问“本轮次微机是否有计分权”，并落库为本轮次配置
- 轮次切换：在**安曲录入页**提供【结束本轮次/开始新轮次】按钮，由安曲录入用户手工确认（round_no + 1），并默认自动反转 `micro_enabled`
- UI约束：当本轮次 `micro_enabled=0` 时，安曲晾堂岗位不展示/不可选“微机”，防止误录

### 2.6 人员花名册导入（仅姓名）
- 支持 OCR/文本识别排班表，解析结果只保留“姓名”写入花名册
- 支持从 Excel 复制后粘贴姓名批量导入（换行符/空格/逗号分隔）
- 导入后统一去重（按姓名精确匹配），并自动生成拼音索引用于检索
- 支持手工新增/编辑/停用人员（离线场景兜底）

---

## 三、数据架构设计

### 3.1 核心四表模型

#### StageSession（工序会话）
某天某工序的一次录入单
```
字段：
- id, uuid, session_date, class_no
- stage_code（安曲/一次翻曲/二次翻曲/拆曲/堆曲）
- round_id（轮次归属，关联 `ferment_round.id`；安曲必填用于“微机计分权”，其他环节用于追溯；堆曲若当日拆曲存在多个 round_id 则可为空并在UI提示“混合轮次”）
- coef_set_id（系数版本，防止历史数据漂移）
- session_room_code（可空；堆曲仓号等“会话标识”，三段式编号格式如 `7-2-6`；**格式同发酵仓编号但含义不同**，不做 `ferment_bin` 校验；堆曲首次录入必填，后续默认沿用，允许手动修改）
- session_total_koji_count（可空；堆曲等“按会话计分”场景使用）
- session_total_points_units（可空；会话总工分，整数单位）
- status（draft/submitted）：用于区分“草稿/已提交确认”；**已提交仍允许随时修改历史工分**（不做锁定）。
- published_at（可空）：记录本环节最近一次点击【公示】的时间戳（仅作标记/追溯，不代表锁定）。
- updated_at, version, sync_status（为二期同步预留）

约束建议：
- 单班级使用前提下，可简化为：同一天同一环节同一轮次最多一条：`UNIQUE(session_date, stage_code, round_id)`（本系统当前不做多班级切换）
```

#### StageBin（发酵仓明细）
```
字段：
- id, uuid, stage_session_id
- bin_id（发酵仓ID）
- koji_count（曲坯数量；安曲环节由用户录入；其他环节默认从该仓安曲记录自动带出并只读展示）
- total_points_units（发酵仓总工分，整数单位）
- updated_at, version, sync_status（为二期同步预留）

说明：
- 堆曲（DuiQu）为 SESSION 计分，不产生 StageBin 记录（仅使用 StageSession.session_room_code 作为“堆曲仓号标识”）。
```

#### Assignment（工分分配行）
```
字段：
- id, uuid, stage_session_id
- stage_bin_id（nullable，仅BIN类型需要）
- person_id, person_name_snapshot（人员ID必填；临时工可在录入时快速新增到 `person`；name_snapshot 用于保留历史姓名）
- role_code（岗位代码）
- scope（BIN | CROSS_BIN | SESSION）
- position_index（站位顺序，用于追责）
- points_units（原始工分，整数单位；最终工分需减去考核扣分）
- updated_at, version, sync_status（为二期同步预留）

约束：
- scope=BIN → stage_bin_id 必填
- scope=CROSS_BIN/SESSION → stage_bin_id 为空
```

#### AssignmentSource（工分来源）
记录跨仓抽取的工分来源
```
字段：
- assignment_id, stage_bin_id（联合主键）
- source_points_units（从该仓抽取的工分，整数单位）

约束：
- 仅用于 scope=CROSS_BIN 的 Assignment
- SUM(source_points_units) = assignment.points_units
```

### 3.2 辅助表

#### ferment_bin（发酵仓基础信息）
```sql
CREATE TABLE ferment_bin (
  id         INTEGER PRIMARY KEY,
  class_no   INTEGER NOT NULL CHECK (class_no > 0),
  floor_no   INTEGER NOT NULL CHECK (floor_no > 0),
  seq_no     INTEGER NOT NULL CHECK (seq_no > 0),
  is_active  INTEGER NOT NULL DEFAULT 1,
  UNIQUE (class_no, floor_no, seq_no)
);
```

#### person（人员基础信息）
```sql
CREATE TABLE person (
  id                    INTEGER PRIMARY KEY,
  name                  TEXT NOT NULL,
  name_pinyin_full      TEXT NOT NULL,  -- 全拼（如"zhangsan"）
  name_pinyin_initials  TEXT NOT NULL,  -- 首字母（如"zs"）
  team_id               INTEGER
);
```

#### ferment_round（轮次配置）
用于控制“微机”岗位是否有计分权（隔轮次轮换）。
```sql
CREATE TABLE ferment_round (
  id            INTEGER PRIMARY KEY,
  uuid          TEXT NOT NULL,
  class_no      INTEGER NOT NULL,
  round_no      INTEGER NOT NULL,
  micro_enabled INTEGER NOT NULL CHECK (micro_enabled IN (0,1)),
  started_at    INTEGER NOT NULL,
  ended_at      INTEGER NULL,
  updated_at    INTEGER NOT NULL,
  version       INTEGER NOT NULL DEFAULT 1,
  sync_status   TEXT NOT NULL DEFAULT 'local',
  UNIQUE (class_no, round_no)
);
```

#### penalty_record（考核扣分记录）
扣分明细独立落库，查询时与 `Assignment` 联表汇总展示。
```sql
CREATE TABLE penalty_record (
  id                   INTEGER PRIMARY KEY,
  uuid                 TEXT NOT NULL,
  stage_session_id     INTEGER NOT NULL,
  assignment_id        INTEGER NOT NULL,
  target_person_id     INTEGER NOT NULL,
  manager_name         TEXT NOT NULL,
  reason               TEXT NOT NULL,
  deducted_points_units INTEGER NOT NULL CHECK (deducted_points_units >= 0),
  created_at           INTEGER NOT NULL,
  updated_at           INTEGER NOT NULL,
  version              INTEGER NOT NULL DEFAULT 1,
  sync_status          TEXT NOT NULL DEFAULT 'local'
);
```

#### process_role_type（岗位类型配置）
```sql
CREATE TABLE process_role_type (
  role_code               TEXT PRIMARY KEY,
  role_name               TEXT NOT NULL,
  scope                   TEXT NOT NULL CHECK (scope IN ('BIN','CROSS_BIN','SESSION')),
  requires_position_index INTEGER NOT NULL DEFAULT 0,
  is_active               INTEGER NOT NULL DEFAULT 1
);
```

#### process_stage_type（环节类型配置）
```sql
CREATE TABLE process_stage_type (
  stage_code         TEXT PRIMARY KEY,
  stage_name         TEXT NOT NULL,
  default_bin_count  INTEGER NOT NULL DEFAULT 2,
  min_bin_count      INTEGER NOT NULL DEFAULT 1,
  max_bin_count      INTEGER NULL,  -- NULL表示不限制
  is_active          INTEGER NOT NULL DEFAULT 1
);
```

#### process_stage_role_default（环节-岗位默认配置）
用于“录入页默认展示哪些岗位/默认人数/是否必填”，让 PRD 的“标准配置”可配置化。
```sql
CREATE TABLE process_stage_role_default (
  stage_code     TEXT NOT NULL,
  role_code      TEXT NOT NULL,
  default_count  INTEGER NOT NULL,
  min_count      INTEGER NOT NULL DEFAULT 0,
  max_count      INTEGER NULL,
  is_required    INTEGER NOT NULL DEFAULT 0,
  sort_no        INTEGER NOT NULL DEFAULT 0,
  PRIMARY KEY (stage_code, role_code)
);
```

### 3.3 存储方案
- **技术选型**：SQLite
- **状态字段**：`draft/submitted`；公示为人工触发且不产生“锁定”，可选记录 `published_at` 作为“最近一次公示时间”。
- **本地优先**：第一阶段单机离线；核心表统一预留 `uuid/version/sync_status/updated_at` 便于二期云端同步
- `is_synced` 可由 `sync_status` 推导（例如：`sync_status='synced'`）

---

## 四、业务逻辑

### 4.1 工分计算引擎
```typescript
// 发酵仓总工分（整数单位）
function calcBinTotalPointsUnits(kojiCount: number, coef: number): number {
    return Math.floor((kojiCount / 20) * coef * 10)
}

// 会话池子/岗位池子总工分（整数单位）
// - 堆曲：baseKojiCount = 当日拆曲总曲坯数
// - 安曲晾堂：baseKojiCount = 当日安曲总曲坯数
function calcSessionTotalPointsUnits(baseKojiCount: number, coef: number): number {
    return Math.floor((baseKojiCount / 20) * coef * 10)
}
```

### 4.2 跨仓比例抽取算法（最大余数法）

使用整数单位（1单位=0.1分），避免浮点数漂移。

**约束**：仅从当日该环节（同一 StageSession）的发酵仓中抽取工分。

```
输入：
- bins[]：当日该环节的发酵仓列表（来自同一 StageSession），每仓曲坯数 k[i]
- totalUnits：跨仓岗位目标工分（整数单位）

算法步骤：
1. 计算权重和：sumK = sum(k[i])
2. 计算原始份额：raw[i] = totalUnits × k[i] / sumK
3. 取整下界：base[i] = floor(raw[i])
4. 计算余数：rem[i] = raw[i] - base[i]
5. 最大余数补齐：
   - 按 rem[i] 从大到小排序（平局按 bin_id 升序）
   - 前 R 个各+1单位（R = totalUnits - sum(base)）

输出：
- AssignmentSource[](stage_bin_id, source_points_units)
- 保证：sum(source_points_units) = totalUnits
```

### 4.3 数据校验规则
- **BIN平衡**：对每个发酵仓，`bin.total_points_units = sum(BIN分配原始工分) + sum(从该仓抽取的工分)`
- **来源完整性**：对每条跨仓分配，`Assignment.points_units = sum(AssignmentSource.source_points_units)`
- **SESSION池子平衡**：对“按会话计分”的环节（如堆曲），`StageSession.session_total_points_units = sum(SESSION分配原始工分)`
- **安曲晾堂池子平衡**：`当日安曲总曲坯数 = sum(安曲 StageSession 下所有BIN曲坯数)`；各晾堂岗位按系数生成“岗位池子”，并要求 `sum(该岗位SESSION分配原始工分) = 该岗位池子总分`（微机仅在本轮次有计分权时启用）
- **考核口径**：最终工分不回写原始表；对单条分配行，`final = Assignment.points_units - SUM(penalty_record.deducted_points_units WHERE assignment_id=Assignment.id)`；对“按人/按日”统计则在此基础上汇总
- **站位完整性**：仓内人员必须填 `position_index`，且同仓不重复；`1=门口侧 → N=最里面`（列表顺序即站位顺序）

### 4.4 发酵仓编号推断算法

1. 查询该环节+该班级最近一次的执行记录
2. 找到"尾部发酵仓"（按 `floor_no DESC, seq_no DESC` 排序取第一条）
3. 计算楼层最大序号 `seq_max`：优先取该班级该楼层历史最大 `seq_no`，若无历史默认 `24`
4. 从尾部的下一个序号开始，连续选择N个发酵仓
5. 跨楼层处理：当 `seq_no > seq_max` 时，`seq_no=1` 且 `floor_no+1`

补充：
- 本项目当前以“单班级”使用为前提，推断时默认使用该班级的数据（不提供跨班级切换）。

### 4.5 轮次归属推断（StageSession.round_id）
- 约束：一次录入单（StageSession）只允许属于一个轮次；若选择的发酵仓存在不同轮次的历史记录，则提示拆分成多张录入单
- 安曲（AnQu）：默认使用“当前轮次”（由安曲录入用户在安曲录入页手工确认轮次结束并切换）；若无轮次历史则首次安曲录入时创建 round_no=1 并询问 `micro_enabled`
- 一次翻曲/二次翻曲/拆曲：默认从所选发酵仓的最近一次历史记录推断其 `round_id`（同仓跨环节沿用同一轮次）
- 堆曲（DuiQu）：默认取“当日拆曲录入单”的 `round_id`（用于展示/追溯）；若当日存在多条拆曲且 `round_id` 不一致，则堆曲 `round_id` 置空并在UI提示“混合轮次”；当日无拆曲记录时按 5.3 的兜底策略处理

### 4.6 堆曲仓号默认值推断（StageSession.session_room_code）
- 首次堆曲录入：用户手工填写 `session_room_code`（格式如 `7-2-6`），保存后作为该班级堆曲默认仓号
- 后续堆曲录入：默认回填该班级最新一次已保存的 `session_room_code`，直到用户手动修改（修改后更新默认值）

---

## 五、UI/UX设计

设计目标：现场环境（戴手套/粉尘/无网）下“少点击、少输入、强校验”，并让复杂规则（跨仓扣减、轮次/微机、考核、自动平衡）在界面上可见、可控、可追溯。

### 5.1 页面架构

底部导航：工作台 | 统计 | 我的

```text
/pages
  /index                 # 工作台：当日概览 + 新建录入入口 + 最近草稿
    index.uvue
  /work                  # 工分录入核心模块
    entry.uvue           # 统一工分录入页（5个环节共用，按stage参数切换）
    assessment.uvue      # （可选）考核明细页：查看/编辑扣分记录
  /stats                 # 数据查询与报表
    index.uvue           # 统计概览
    date-detail.uvue     # 按日期+环节：公示预览（适合截图）/简报 + Excel导出入口
    person-detail.uvue   # 按人员：工资条（原始/扣分/最终）
    bin-detail.uvue      # 按发酵仓：追溯/追责（站位顺序）
  /mine                  # 我的/设置
    index.uvue
    settings.uvue        # 管理员姓名/导出模板等通用设置
    class-config.uvue    # 班级配置：发酵仓设置/编号规则/轮次历史（轮次切换入口在安曲录入页）
    roster-import.uvue   # 花名册导入：OCR/文本/粘贴导入（仅姓名）+ 校对列表
```

### 5.2 智能发酵仓推断与选择

#### 5.2.1 智能推断（进入录入页默认生效）
- 适用范围：安曲/一翻/二翻/拆曲（堆曲为 SESSION 计分，仓号单独手填，不走该推断）。
- 默认展示 2 间发酵仓卡片（可 `+` 添加 / `-` 删除）。
- 推断依据：取该班级、该环节最近一次提交记录的“尾部发酵仓”作为起点，按序号递增推断下一组。
  - 示例：上次提交 `3-3-1` & `3-3-2` → 本次默认 `3-3-3` & `3-3-4`。
- 跨楼层：当 `seq_no` 超过楼层最大值时自动跳转到下一楼层：
  - `seq_max` 取“该班级该楼层历史最大 seq”，若无历史默认 `24`；
  - 示例：`3-3-24` → `3-4-1`。

#### 5.2.2 发酵仓选择器（当需要修改默认推断时使用）
适用范围：安曲/一翻/二翻/拆曲；堆曲不使用该选择器（堆曲仓号手工填写，见 5.3）。

说明：班级信息在初始化时已确定（页面内只读展示），日常只需切换楼层。

顶部：楼层选择（班级只读展示）
```
┌─────────────────────────────────┐
│ 班级: 3（只读）   楼层: [3 ▼]  │
└─────────────────────────────────┘
```

发酵仓网格（多选；网格上限默认展示至 seq_max=24，可随历史扩展；每格展示完整编号）
```
┌─────────────────────────────────┐
│ 3-3-1  3-3-2  3-3-3✨ 3-3-4✨ ... │  ✨ = 智能推断预选
│ 3-3-9  3-3-10 3-3-11 3-3-12 ... │  🔵 = 当前选中
│ 3-3-17 3-3-18 3-3-19 3-3-20 ... │
└─────────────────────────────────┘
```

交互：
- 点击编号格：切换选中/取消
- 长按：连续范围选择（适合“今天录很多仓”的场景）
- 页面加载时自动预选“下一组”（智能推断结果）

### 5.3 统一录入页（entry.uvue，T型信息架构）

目标：单屏完成“环境确认 + 会话/跨仓任务 + 发酵仓明细分配 + 校验提交”。

#### A. 顶部控制区（Context）
- 选择：日期（默认今日）、工序（安曲/一翻/二翻/拆曲/堆曲）。
- 展示：班级信息（初始化确定且单班级使用；页面只读展示）。
- 发酵仓选择器（非堆曲）：默认 2 仓并可 `+`/`-` 调整。
- 轮次提示（非安曲）：根据所选发酵仓历史自动推断 `round_id` 并展示；若所选发酵仓属于不同轮次，则提示“需按轮次拆分录入单”并禁止提交。
- 安曲专属：显示“当前轮次（如第3轮）/ 微机计分权状态”。
  - 提供【结束本轮次/开始新轮次】按钮（二次确认）：
    - 创建 `round_no + 1`；
    - `micro_enabled` 默认按上一轮反转；
    - 若无历史（首次安曲录入）弹窗询问本轮 `micro_enabled`。
- 堆曲专属（SESSION计分，无多仓卡片；本系统单班级使用，默认无需切换班级）：
  - 堆曲仓号：手工填写（格式同 `班级-楼层-序号`，如 `7-2-6`，但含义为“堆曲场景的仓号标识”，与发酵仓含义不同）。
    - 首次录入：必填，并保存为该班级堆曲默认仓号；
    - 后续录入：自动回填默认仓号，直到用户手动修改（修改后更新为新的默认值）。
  - 顶部醒目展示“当日拆曲总曲坯数：XXXX”（默认自动汇总当日全部拆曲记录；当日拆曲产出都会运送到堆曲，因此不区分轮次）。
    - 若当日拆曲存在多个 `round_id`：轮次栏显示“混合”，但堆曲基数仍为“当日拆曲总曲坯数”。
  - 若当日无拆曲记录：显示警告，并提供两种操作：
    1) 跳转去录入拆曲
    2) 手动补录“当日拆曲总曲坯数”（用于生成堆曲池子；需二次确认）

#### B. 共享/会话任务区（Global）
- 规则：根据当前工序动态展示“跨仓岗位/会话岗位”，无对应岗位则整块隐藏（避免误录）。
- CROSS_BIN（跨仓岗位）：拉车/打杂的工分录入区（每条为“人 + 工分”）。
  - 提示文案：该岗位工分将从当前会话内所选发酵仓按曲坯数比例扣减（系统自动分摊并对账）。
- SESSION（会话岗位）：
  - 安曲晾堂：麦料/守机/下曲/微机（微机仅当本轮 `micro_enabled=1` 时显示；否则隐藏或显示“本轮无计分权”提示）。
    - 人员默认延用：首次选择人员后，后续每次安曲录入自动回填“上一次安曲晾堂”各岗位人员（仅回填人员，不回填分值）；管理人员可随时调整，调整结果作为下一次默认值。
    - 工分自动计算：系统基于“当日安曲总曲坯数 × 岗位系数”自动计算岗位池子总分；岗位仅 1 人时自动填入该人员。
  - 堆曲组：2-4人独立组（按堆曲池子总分分配，不从单仓扣减）。
  - 每个SESSION岗位区都应显示：基数（当日总曲坯数）、系数、池子总分（便于现场核对）。

#### C. 发酵仓卡片区（Bin Cards）
- 堆曲环节：不展示该区域（堆曲为 SESSION 计分，仅填写“堆曲仓号”并录入堆曲组人员）。
- 默认加载即生成 2 张卡片。
- 卡片结构（每仓）：
  1) 仓号（大字，如 `3-3-3`）+ 删除按钮
  2) 曲坯数量：
     - 安曲：可编辑输入（变更即重算仓总分，并实时更新“当日安曲总曲坯数”与晾堂池子总分）
     - 一翻/二翻/拆曲：自动带出该仓安曲曲坯数量，默认只读展示（如需更正，回到安曲记录调整）
  3) 仓总分展示（向下取1位小数；整数单位内部存储）
  4) 人员分配（站位顺序即责任顺序）：
     - 默认列表顺序：`1=门口侧 → N=最里面`（支持拖拽/上下移动调整站位）
     - 每行：姓名 + 工分（直接输入 + Stepper）+【考核】按钮
     - 支持“同上”复制上一仓的人名/站位结构（不直接复制分数）
     - 支持“一键按技能建议分配”（生成建议值并可微调）
- 人员互斥：同一会话内已被选择的人员在其他位置置灰，防止重复录入。

#### D. 底部操作栏（Actions）
- 实时对账状态：绿色=平衡可提交；红色=失衡并显示差额来源（哪一仓/哪一岗位）。
- 操作：`[保存草稿]` / `[提交确认]`（提交前执行：BIN平衡、CROSS_BIN来源完整性、SESSION池子平衡、站位完整性、微机计分权校验）。

### 5.4 关键交互细节

#### 5.4.1 人员选择（拼音检索）
- 支持：中文、全拼、首字母匹配（例：输入 `ZS` → `张三`、`张四`）。
- 常用人员置顶；已被占用人员置灰不可选。

#### 5.4.2 工分输入与微调（Stepper）
- 工分输入支持两种方式：直接输入 + 步进器微调（Stepper）。
  - 直接输入：弹出自定义大按钮数字键盘；自动格式化为 1 位小数（0.1 精度），不合法输入提示修正。
  - 步进器微调：`+0.1/-0.1`（= 1单位），用于现场快速微调/对账。
- 自动平衡反馈：
  - 当通过步进器或直接改值导致某人分数变化时，系统自动在同作用域内对其他人做平衡分摊，保证总分不变。
  - 被系统自动调整的人员行短暂高亮闪烁，提示发生联动变化。
- “不足0.1的剩余单位”轮转规则（同仓内）：
  - 第一次：集中给技能系数最高的人；
  - 第二次：给技能系数第二高的人；
  - 后续：在第一/第二名之间交替轮转（避免长期集中到同一人）。

#### 5.4.3 考核扣分交互（原始/扣分/最终）
- 每条人员分配行提供【考核】按钮。
- 点击后该行展开为两段式输入，并实时显示最终分：
  - `[原始工分] - [扣分] = [最终工分]`
- 扣分需填写“原因”（用于落库为考核记录）；展示/统计时同时显示“原始/扣分/最终”三列。

### 5.5 数据查询、公示与Excel导出

#### 5.5.1 每日公示（按日期）
- **公示单位**：以“环节”为单位独立公示；同一日期下，不同环节可在不同时间分别公示，互不依赖。
- **公示入口与时间控制**：各环节现场管理人员在本环节内手动触发【公示】进入公示预览页，系统不做统一定时。
- **公示内容（离线截图）**：公示页仅展示“当前环节”的所有人员工分，默认最终工分（可切换 原始/扣分/最终）；页面布局需适合截图保存，管理人员截图后发送至班级管理群完成公示。
- **历史可改**：现场管理人员对本环节拥有完整工分调整权，可随时修改历史工分；修改后公示页以最新数据为准，可重新截图再次公示。
- **导出Excel**：仍由 `date-detail.uvue` 提供【导出Excel】入口（手动触发）。

#### 5.5.2 按人员查询（工资条）
- `person-detail.uvue`：按日期列表/日历展示个人每日得分，并可展开查看扣分明细与原因。

#### 5.5.3 按发酵仓查询（追责）
- `bin-detail.uvue`：输入“日期 + 仓号”，展示该仓当日人员与站位顺序（门口→最里面），用于追责定位。

#### 5.5.4 Excel导出交互（模板填充）
- 导出流程：选择（或预先保存的）模板文件 → 系统按“日期+姓名”定位单元格 → 填入数据 → 另存为新文件 → 调用系统分享/保存。
- 默认模板定位规则（已确定）：
  - `B` 列为姓名列（姓名从 `B3` 向下）
  - 第 `2` 行为日期行（日期从 `C2` 向右）
  - 日期格式：`YYYY/MM/DD`（如 `2025/12/23`，匹配时按单元格格式化后的文本对齐）
  - 填值单元格 = “姓名行 × 日期列”的交叉单元格
- 导出完成提示：列出“模板缺失的姓名/日期”清单，便于人工补齐模板或核对数据。

### 5.6 花名册导入（OCR/文本/粘贴导入）校对体验

流程：
1) 选择导入方式：
   - OCR/文本识别：上传/拍摄排班表图片
   - 粘贴导入：从Excel复制姓名后粘贴（支持换行符/空格/逗号分隔）
2) 解析提取姓名（仅取姓名；自动 trim；忽略空值）
3) 校对列表页（核心）：
   - 展示识别出的姓名列表（支持批量勾选）
   - 支持：删除错误项、编辑错别字、一键去重（重复项高亮）
4) 确认入库：写入花名册并生成拼音索引（全拼/首字母），便于录入页快速检索

## 六、技能自动打分功能

### 6.1 功能概述

**核心理念**：从"强制约束"到"建议辅助"
- 算法提供基于技能系数的建议分配
- 管理人员拥有最终决策权
- 支持微调+自动平衡（调整一人，其他人联动）
- 记录建议值vs实际值，支持审计

### 6.2 技能系数表

**skill_coeff_set（技能系数版本集）**：
```
字段：id, team_id, version, effective_from, effective_to, remark
```

**skill_coeff_item（技能系数明细）**：
```
字段：id, set_id, person_id, coeff（如1.2）
```

### 6.3 自动打分算法（最大余数法）

```
1. 整数化：total × 10 → T（整数单位）
2. 比例分配：raw_i = T × w_i / sum(w)
3. 取整下界：base_i = floor(raw_i)
4. 最大余数补齐：前R个各+1单位
5. 保证 sum(units_i) = T
```

**示例**：
```
总分49.4分，4人，技能系数[1.2, 1.0, 0.9, 0.8]
结果：[15.3, 12.7, 11.5, 9.9]
```

### 6.4 微调平衡算法

- 接受任何微调操作
- 微调入口：支持直接输入 + 步进器（Stepper）微调；Stepper 步长 `0.1` 分（即 `1` 单位）
- 自动平衡同一作用域内的其他人员（同仓 BIN / 同会话 SESSION），保证总分不变
- 差额分摊：按技能系数权重进行比例分摊（整数单位，1单位=0.1分）
- 0.1精度处理：若分摊到某人的份额不足 0.1 分（即 0 单位），则不分给该人；产生的剩余单位按“作用域内技能系数排名”轮转分配（BIN=同仓；SESSION=同会话岗位组）：
  - 第一次：集中给技能系数最高的人
  - 第二次：给技能系数第二高的人
  - 后续：在第一/第二名之间交替轮转（避免长期集中到同一人）
- 下限处理：任何人原始工分不得小于 0；若扣减导致触发下限，则跳过该人，将需补正的单位按上述轮转策略集中到第一/第二名（加分时加给他们，扣分时从他们身上扣），直到平衡或提示需人工调整

### 6.5 UI设计

**智能输入框**：
- 默认状态：黑色数字，白色背景
- 偏离状态：深蓝色数字，显示建议值和偏离量
- 颜色编码：灰色(<0.2) / 橙色(≥0.2) / 紫色(≥1.0)

---

## 七、Excel导出方案

### 7.1 导出原则（以模板为准）
- 由管理人员提供 Excel 模板（.xlsx）
- 系统按“日期 + 人员姓名”定位单元格并填入工分数据
- 导出为“已填充的新文件”，不修改原模板

### 7.2 模板定位策略（默认约定，可配置）
- 默认约定：第 `2` 行为日期行，`B` 列为姓名列；日期显示格式为 `YYYY/MM/DD`（如 `2025/12/23`）
- 默认约定：日期从 `C2` 开始向右扩展；姓名从 `B3` 开始向下扩展；填值单元格为“姓名行 × 日期列”的交叉单元格
- 匹配：优先按“日期单元格格式化后文本”匹配（统一格式化为 `YYYY/MM/DD`）；姓名按文本精确匹配（可选开启“忽略空格/全角半角归一”）
- 缺失处理：模板中找不到的姓名/日期，导出后给出缺失清单提示

### 7.3 数据口径
- 单元格填入“最终工分”（原始工分 - 扣分）
- 如模板需要“原始/扣分/最终”三列，可在导出配置中选择对应写入列

### 7.4 技术实现建议
- 使用 XLSX 读写库对模板进行“读取 → 定位 → 写入 → 另存”
- 若目标平台对 XLSX 写入受限，则降级为：导出“姓名×日期”CSV + 提示用 Excel 打开（仅作为兜底，不作为默认）

---

## 八、项目架构

```
/ProPoints
├── /database
│   ├── schema.sql          # SQLite建表脚本
│   └── repository.uts      # 数据访问层
├── /domain
│   ├── /models             # 实体类型定义
│   ├── /services
│   │   ├── ScoreCalculator.uts    # 工分计算引擎
│   │   ├── ScoreAllocator.uts     # 跨仓抽取算法
│   │   ├── Validator.uts          # 校验规则
│   │   ├── RoundService.uts       # 轮次管理/微机计分权
│   │   ├── PenaltyService.uts     # 考核扣分记录
│   │   └── ExcelExportService.uts # Excel模板填充导出
│   └── /stores
│       └── ProductionStore.uts    # 状态管理
├── /components
│   ├── biz-bin-selector.uvue
│   ├── biz-worker-selector-pinyin.uvue
│   ├── biz-bin-card.uvue
│   └── biz-score-input.uvue
└── /pages
    ├── /index
    ├── /work
    ├── /stats
    └── /mine
```

---

## 九、技术风险与应对

| 风险 | 应对策略 |
|------|----------|
| 小数舍入导致对账不平 | 整数单位存储 + 最大余数法 |
| 历史数据漂移 | 系数版本化（coef_set_id） |
| 站位追责困难 | 强制position_index |
| 多人编辑冲突 | 离线单机阶段默认不冲突；二期同步通过 `version/updated_at` 做冲突检测与提示，不采用“locked后不可改”约束（需保留历史可改能力） |
| XLSX模板填充兼容性 | 优先选稳定XLSX读写方案；不支持时降级导出CSV并提示 |
| OCR识别漏/错名 | 导入后提供“识别结果校对列表”（可批量删除/更正） |

---

## 十、待确认决策点

| 决策项 | 推荐方案 | 备选方案 |
|--------|----------|----------|
| 数据存储 | SQLite | uni-storage |
| Excel导出模板定位 | 约定：第2行=日期、B列=姓名（日期格式YYYY/MM/DD） | 提供“模板映射配置”界面（可指定姓名列/日期行/起止范围/日期格式） |
| 轮次切换方式 | 安曲录入页手动“结束本轮次/开始新轮次”（自动反转micro_enabled） | 班级配置页手动切换 / 自动推断轮次（基于历史/日期） |
| 堆曲无拆曲记录处理 | 禁止导出/提示先录拆曲 | 允许手工补录“当日拆曲总曲坯数”生成堆曲池子 |
| 系数管理 | 版本化管理 | 直接修改 |
| 工分精度 | 向下取1位小数 | - |

---

**方案制定者**：Claude Opus 4.5 + Codex + Gemini
**方案版本**：2.0
**最后更新**：2026-02-02

**核心特性**：
- 统一录入页（所有环节共用）
- 跨仓岗位通用化（支持拉车/打杂等 CROSS_BIN 作用域，按环节启用）
- 发酵仓数量动态配置（支持任意数量）
- 发酵仓编号结构化（班级-楼层-序号）
- 智能推断系统（基于历史记录自动推荐）
- 拼音快速搜索（支持首字母匹配）
- 人员互斥机制
- 整数单位存储（避免浮点数漂移）
- 轮次管理 + 微机计分权离线推断
- 考核扣分：原始/扣分/最终分三段口径 + 独立明细表
- 堆曲按“当日拆曲总曲坯数”生成会话池子计分
- Excel模板填充导出（日期+姓名定位）
