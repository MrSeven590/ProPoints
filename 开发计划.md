# 开发计划：白酒制曲车间工分管理系统（ProPoints / WorkPoints Pro）

> 计划依据：
> 1) `白酒制曲车间工分管理系统PRD.md`（最后更新：2026-02-02）
> 2) `.claude/方案总结.md`（最后更新：2026-02-05）
>
> 技术栈：uni-app x（Vue3 + TypeScript/UTS），Local-First（一期离线），二期预留云端同步字段。

---

## 0. 目标、范围与约束（一期）

- **目标**：覆盖制曲五大环节（安曲/一翻/二翻/拆曲/堆曲）的工分录入、自动计算、跨仓扣减、会话计分、考核扣分、公示截图、统计查询、Excel 导出。
- **使用范围**：**单班级**（不做多班级切换/汇总）。
- **存储策略**：一期以 `uni.*Storage` 作为主存储（key-value，按“日期/环节/轮次”拆 key），避免小程序端单 key/总量限制；同时用 **SQLite DDL** 作为“关系模型说明/二期落库”文档。
- **可改历史**：已提交/已公示数据仍允许编辑，不做锁定；公示仅记录 `published_at` 时间戳用于追溯。
- **工分精度**：统一 **0.1 分**精度，**向下取 1 位小数**；内部统一使用整数单位 `points_units = points × 10`，避免浮点误差。

---

## 1. 核心架构摘要（执行任务时的统一口径）

### 1.1 核心四表模型（逻辑模型）

- `StageSession`：某天某环节的一次录入单（含 `session_date/stage_code/round_id/status/published_at/...`）
- `StageBin`：某录入单下的发酵仓明细（安曲录 `koji_count`；后续环节复用安曲基准）
- `Assignment`：人员分配行（`scope=BIN/CROSS_BIN/SESSION`，保存“原始工分”）
- `AssignmentSource`：跨仓抽取来源明细（`scope=CROSS_BIN` 时生效，要求 SUM=目标工分）

> 扣分明细采用“独立明细表”口径：`PenaltyRecord`（查询/统计时联表汇总，最终分不回写原始表）。

### 1.2 辅助表（逻辑模型）

- `ferment_bin`（发酵仓基础信息：`class_no/floor_no/seq_no`）
- `person`（花名册：姓名 + 拼音索引 + 启停用）
- `ferment_round`（轮次：控制安曲晾堂“微机”岗位计分权，隔轮轮换）
- `process_role_type / process_stage_type / process_stage_role_default`（环节与岗位配置化）
- `skill_coeff_set / skill_coeff_item`（技能系数版本与明细，用于建议分配/自动平衡）

### 1.3 本地存储 Key 约定（一期落地口径）

- 会话主数据：`pp:session:{YYYY-MM-DD}:{stage}:{roundId}`（JSON：包含 session + bins + assignments + penalties...）
- 日期索引：`pp:idx:date:{YYYY-MM-DD}`（当日会话 key 列表）
- 预留索引：`pp:idx:person:{personId}` / `pp:idx:bin:{class-floor-seq}`（按人/按仓查询加速）
- 配置：`pp:cfg:*`（班级配置、系数版本、轮次当前态、上次堆曲仓号、晾堂默认人员、管理员姓名等）
- 变更队列：`pp:oplog`（二期同步预留）

### 1.4 关键业务逻辑（必须统一实现）

- **BIN 总分**：`floor1(koji_count/20 × stage_coef)` → 转 `points_units`
- **CROSS_BIN 抽取**：按曲坯数比例，用**最大余数法**分摊到各仓（整数单位），保证和相等
- **SESSION 池子**：
  - 安曲晾堂：基数=当日安曲总曲坯数；按岗位系数生成“岗位池子”（微机需 `micro_enabled=1`）
  - 堆曲：基数=当日拆曲总曲坯数；无拆曲数据需提示并提供“跳转录拆曲/手工补录基数”
- **校验规则**：
  - BIN 平衡：`bin.total = sum(BIN原始分) + sum(被跨仓抽取)`
  - CROSS_BIN 来源完整：`assignment.points_units = sum(source_points_units)`
  - SESSION 池子平衡：`pool_total = sum(SESSION原始分)`
  - 站位完整：仓内人员必须有 `position_index` 且 1..N 不重复
  - 微机计分权：`micro_enabled=0` 时禁止出现“微机”分配

### 1.5 UI/UX 页面架构（一期）

- TabBar：`工作台`（快捷录入/草稿）| `统计`（公示/查询/导出）| `我的`（配置/花名册/设置）
- 统一录入页：`pages/work/entry.uvue`（路由参数区分环节）
- 花名册导入：`pages/mine/roster-import.uvue`（粘贴/（二期 OCR）→ 校对 → 入库）
- 配置：`pages/mine/class-config.uvue`（班级/楼层仓数/轮次） + `pages/mine/settings.uvue`（管理员/导出模板等）
- 统计：`pages/stats/date-detail.uvue`（公示预览/导出入口）+ `person-detail/bin-detail`

---

## Phase 1：基础架构搭建（中等复杂度）

**阶段目标**：完成目录结构、核心类型、存储基座、初始化、路由与 TabBar，确保可启动/可导航/可持久化。

### P1-T01 目录结构与模块边界固化
- 任务描述：明确并固化工程目录职责，避免 UI/业务/存储耦合；建立后续新增模块的放置规则。
- 涉及的文件/模块：
  - `pages/`、`components/`、`domain/models/`、`domain/services/`、`domain/stores/`、`storage/`
  - `.trellis/spec/*`（编码规范参考）
- 依赖关系：无
- 验收标准：
  - [ ] 新增功能能明确落在“页面/组件/服务/存储”某一层，不出现跨层循环依赖
  - [ ] 关键业务逻辑仅存在于 `domain/services/*`（页面仅编排与状态绑定）

### P1-T02 核心数据类型与枚举统一
- 任务描述：将 PRD/方案中的 Stage/Role/Scope/PointsUnits/Status 等核心类型统一定义，保证全链路类型一致。
- 涉及的文件/模块：
  - `domain/models/types.uts`
  - `domain/models/stage-session.uts`
  - `domain/models/assignment.uts`
  - `domain/models/person.uts`
  - `domain/models/ferment.uts`
- 依赖关系：P1-T01
- 验收标准：
  - [ ] 编译期可发现非法 `stage_code/role_code/scope`
  - [ ] 工分只在 `PointsUnits`（整数单位）和 UI 显示小数之间转换

### P1-T03 Storage Key 规范与 Repository 基座
- 任务描述：落地一期 `uni.*Storage` 的 key 规范、读写封装与索引结构（日期索引必需；人/仓索引后续补齐）。
- 涉及的文件/模块：
  - `storage/storage-keys.uts`
  - `storage/storage-repository.uts`
  - `storage/init.uts`
  - `storage/oplog.uts`（二期预留）
- 依赖关系：P1-T02
- 验收标准：
  - [ ] 会话以 `pp:session:{date}:{stage}:{roundId}` 存储，且日期索引 `pp:idx:date:{date}` 自动维护
  - [ ] `initStorage()` 能在首次启动时补齐基础配置（环节/岗位/系数/楼层仓数）

### P1-T04 SQLite 建表（关系模型文档）与本地 JSON 映射说明
- 任务描述：提供与“核心四表 + 辅助表”一致的 SQLite DDL 作为数据字典，并补充“Storage JSON 结构映射”说明，便于二期迁移与对账。
- 涉及的文件/模块（计划新增）：
  - `storage/schema.sql`（或 `docs/schema.sql`）
  - `docs/storage-mapping.md`
- 依赖关系：P1-T02, P1-T03
- 验收标准：
  - [ ] DDL 覆盖：StageSession/StageBin/Assignment/AssignmentSource + person/ferment_bin/ferment_round/penalty_record/配置表
  - [ ] 文档能明确：哪些字段“一期仅在 JSON 中保存”、哪些字段“二期落库必须保留”

### P1-T05 App 初始化与 TabBar/路由打通
- 任务描述：确保应用启动初始化、底部导航、页面路由可用；统一录入页通过参数区分工序。
- 涉及的文件/模块：
  - `App.uvue`（启动时 `initStorage()`）
  - `pages.json`（TabBar 与路由）
  - `pages/index/index.uvue`、`pages/stats/index.uvue`、`pages/mine/index.uvue`、`pages/work/entry.uvue`
- 依赖关系：P1-T03
- 验收标准：
  - [ ] App 启动无异常日志，能正常进入 TabBar 三个入口
  - [ ] 从工作台可跳转到 `entry?stage=AN_QU|...` 且展示对应环节名称

### P1-T06 基础 UI 规范与通用样式基座
- 任务描述：建立统一的按钮/卡片/输入样式基座，保证现场“高对比、大触控、少输入”的一致体验。
- 涉及的文件/模块：
  - `App.uvue`（全局样式）
  - `uni.scss`
  - `components/`（后续通用组件放置规则）
- 依赖关系：P1-T05
- 验收标准：
  - [ ] 关键操作按钮（保存/提交/公示）具备一致的视觉层级与禁用态
  - [ ] 输入控件满足“手套操作”基本可用（触控面积/间距/字体）

---

## Phase 2：人员与配置模块（中等复杂度）

**阶段目标**：完成花名册、技能系数、发酵仓配置、轮次管理与关键配置项持久化，为录入页提供“可选人员/可推断仓号/可判定微机计分权”。

### P2-T01 花名册数据模型与 CRUD（启用/停用/删除）
- 任务描述：实现人员基础信息的本地持久化与管理（仅姓名为必需），支持停用与删除，并兼容后续拼音索引与技能系数。
- 涉及的文件/模块：
  - `domain/models/person.uts`
  - `storage/storage-repository.uts`（`loadPersons/savePersons`）
  - `pages/mine/roster-import.uvue`（列表、编辑、停用、删除）
- 依赖关系：P1-T03
- 验收标准：
  - [ ] 可新增/编辑/停用/启用/删除人员，退出重进仍保留
  - [ ] 停用人员在选择器中不可选（或置灰），避免误录

### P2-T02 粘贴导入 → 校对列表 → 去重入库（必做闭环）
- 任务描述：支持从 Excel 复制后粘贴批量导入（换行/空格/逗号分隔），强制进入校对列表完成纠错/删除/去重后入库。
- 涉及的文件/模块：
  - `pages/mine/roster-import.uvue`
  - `domain/services/PersonSearchService.uts`（可复用去重/搜索逻辑）
- 依赖关系：P2-T01
- 验收标准：
  - [ ] 粘贴后必经“校对列表”才能入库
  - [ ] 去重规则按姓名精确匹配（可附加 trim/全角半角归一）
  - [ ] 入库后可在人员选择器中按中文/拼音首字母/全拼检索

### P2-T03 拼音索引生成策略（写入时计算）
- 任务描述：按方案要求“写入时计算拼音索引”，避免每次搜索都实时计算；同时保留小规模场景可降级策略。
- 涉及的文件/模块：
  - `domain/services/PersonSearchService.uts`
  - `domain/services/PinyinMatchService.uts`（如采用纯 UTS 实现）
  - `pages/mine/roster-import.uvue`
- 依赖关系：P2-T02
- 验收标准：
  - [ ] 人员实体持久化后包含 `name_pinyin_full/name_pinyin_initials`（或等价索引）
  - [ ] 搜索性能在 500+ 人规模下仍可用（滚动不卡顿、输入无明显延迟）

### P2-T04 技能系数（Skill Coeff）配置与持久化
- 任务描述：为每位员工配置技能能力系数，作为“建议分配/平衡分摊”的权重来源。
- 涉及的文件/模块：
  - `storage/storage-repository.uts`（`loadSkillCoeffs/saveSkillCoeffs`）
  - `pages/mine/roster-import.uvue`（扩展：编辑技能系数入口）或新增 `pages/mine/skill-config.uvue`
  - `domain/models/person.uts`（`PersonSkillCoeff`）
- 依赖关系：P2-T01
- 验收标准：
  - [ ] 未配置人员默认系数为 1.0（或业务默认）
  - [ ] 可批量/单个编辑系数，保存后在分配建议中可读取

### P2-T05 发酵仓楼层默认仓数配置（3/4/5 楼）
- 任务描述：实现 `seq_max` 的配置与使用规则：优先历史最大 seq；无历史则取楼层默认仓数（默认 24）。
- 涉及的文件/模块：
  - `pages/mine/class-config.uvue`
  - `domain/stores/AppStore.uts`（`get/setBinSeqMaxByFloor`）
  - `domain/services/BinService.uts`（`getSeqMaxForFloor`）
  - `components/biz-bin-selector/biz-bin-selector.uvue`
- 依赖关系：P1-T03
- 验收标准：
  - [ ] 配置可保存并影响仓选择器网格上限
  - [ ] 同一楼层一旦出现历史更大 seq，`seq_max` 自动随历史扩展

### P2-T06 轮次管理（开始/结束/修正）与微机计分权推断
- 任务描述：实现轮次的创建、结束进入下一轮（自动反转 `micro_enabled`）、首次无历史提示选择、以及“修正轮次状态”。
- 涉及的文件/模块：
  - `domain/services/RoundService.uts`
  - `pages/mine/class-config.uvue`（轮次管理 UI）
  - `storage/storage-repository.uts`（`loadRounds/saveRounds/loadRoundConfig/saveRoundConfig`）
- 依赖关系：P1-T03
- 验收标准：
  - [ ] 无历史时可初始化第一轮，并保存 `micro_enabled`
  - [ ] 结束本轮会创建新轮次并自动反转 `micro_enabled`
  - [ ] 修正轮次后，安曲录入页能读取到正确的轮次/计分权状态

### P2-T07 管理员姓名与导出模板等通用设置
- 任务描述：管理员姓名用于创建/更新审计字段与扣分记录；导出模板用于 Excel 导出。
- 涉及的文件/模块：
  - `pages/mine/settings.uvue`
  - `domain/stores/AppStore.uts`（`get/setManagerName`）
  - `storage/storage-repository.uts`（`load/saveManagerName`）
- 依赖关系：P1-T03
- 验收标准：
  - [ ] 设置页可保存管理员姓名；录入/扣分记录可读取该姓名快照
  - [ ] 模板选择入口保留（Phase 6 实现具体导出）

### P2-T08 发酵仓基础表（bin registry）与 ID 分配策略
- 任务描述：为发酵仓（`class-floor-seq`）建立本地 registry（稳定 `bin_id`），支撑跨会话按仓查询与 CROSS_BIN 来源引用。
- 涉及的文件/模块（计划新增/扩展）：
  - `storage/storage-repository.uts`（`loadBins/saveBins` 扩展：按 code upsert）
  - `domain/services/BinRegistryService.uts`（新增）
  - `domain/models/ferment.uts`
- 依赖关系：P2-T05
- 验收标准：
  - [ ] 同一仓号多次录入返回同一 `bin_id`
  - [ ] 新仓号首次出现时自动创建并持久化（无需预置全量仓）

---

## Phase 3：工分录入核心功能（高复杂度）

**阶段目标**：完成统一录入页的“日期/环节/仓选择/仓内人员分配”的闭环，落地 BIN 总分计算、曲坯数复用、人员互斥与草稿/提交状态。

### P3-T01 统一录入页：顶部上下文与日期切换
- 任务描述：补齐录入页顶部控制区：日期选择（默认今日，可录历史）、环节标题、班级只读信息；根据环节动态渲染区块。
- 涉及的文件/模块：
  - `pages/work/entry.uvue`
  - `domain/models/stage-session.uts`
- 依赖关系：P2-T05, P2-T06
- 验收标准：
  - [ ] 可切换日期查看/编辑历史录入单
  - [ ] 堆曲环节不展示“发酵仓选择区”，其他环节展示

### P3-T02 StageSession 生命周期：创建/加载/保存草稿
- 任务描述：实现会话的创建（含 `uuid/status=draft/created_by_manager`）、加载（同 key 复用）、保存草稿（不强校验）与覆盖更新。
- 涉及的文件/模块：
  - `storage/storage-repository.uts`（`saveSession/loadSession/getSessionsByDateAndStage`）
  - `domain/stores/AppStore.uts`（`EVENT_SESSION_SAVED`）
  - `pages/index/index.uvue`（最近草稿列表）
  - `pages/work/entry.uvue`
- 依赖关系：P1-T03, P2-T07
- 验收标准：
  - [ ] 保存草稿后，工作台“最近草稿”可见并可一键继续编辑
  - [ ] 同一日期+环节+轮次重复进入时加载同一份会话数据（不生成多份）

### P3-T03 发酵仓选择器接入与“默认 2 仓”体验
- 任务描述：录入页默认展示 2 仓（堆曲除外），支持 `+/-` 快速增减，同时保留网格多选能力与智能推断预选。
- 涉及的文件/模块：
  - `components/biz-bin-selector/biz-bin-selector.uvue`
  - `domain/services/BinService.uts`
  - `pages/work/entry.uvue`
- 依赖关系：P2-T05, P2-T08
- 验收标准：
  - [ ] 首次进入无历史时默认 `3-3-1/3-3-2`；有历史时按规则推断下一组
  - [ ] 达到楼层末尾时自动跨楼层（`3-3-24 → 3-4-1`）

### P3-T04 仓卡片组件（BIN 卡片区）与曲坯数录入
- 任务描述：实现仓卡片渲染：仓号、曲坯数量输入（仅安曲可编辑）、仓总分展示、仓内人员列表与站位顺序。
- 涉及的文件/模块（计划新增/扩展）：
  - `components/biz-bin-card/biz-bin-card.uvue`（新增）
  - `domain/services/ScoreCalculator.uts`
  - `domain/models/stage-session.uts`（StageBin 结构落地到 session JSON）
  - `pages/work/entry.uvue`
- 依赖关系：P3-T03
- 验收标准：
  - [ ] 安曲曲坯数变更会实时刷新仓总分，并刷新“当日安曲总曲坯数”（供晾堂池子使用）
  - [ ] 非安曲环节曲坯数默认只读展示（更正需回安曲记录）

### P3-T05 曲坯数复用：从安曲记录带出
- 任务描述：实现“一翻/二翻/拆曲”的曲坯数量从该仓安曲记录自动带出；缺失时给予明确提示与跳转入口。
- 涉及的文件/模块：
  - `domain/services/DuiQuBaseService.uts`（`getBinKojiCountFromAnQu` 相关）
  - `storage/storage-repository.uts`（会话遍历/索引优化后续补齐）
  - `pages/work/entry.uvue`
- 依赖关系：P3-T04
- 验收标准：
  - [ ] 非安曲环节选仓后自动填入曲坯数；无记录时阻止提交并提示“请先录安曲”

### P3-T06 BIN 工分分配行（人员选择 + 工分输入 + 站位）
- 任务描述：在每个仓卡片内生成默认人数的分配行（按环节配置），支持人员选择、工分输入、站位顺序维护。
- 涉及的文件/模块：
  - `components/biz-worker-selector-pinyin/biz-worker-selector-pinyin.uvue`
  - `domain/services/StageCoefService.uts`（默认人数/岗位配置）
  - `domain/models/assignment.uts`
  - `pages/work/entry.uvue`
- 依赖关系：P2-T01, P3-T04
- 验收标准：
  - [ ] 同仓人员顺序即 `position_index`（门口→最里面），且提交前必须完整
  - [ ] 同一会话内人员互斥（已选人员在其他位置置灰/不可选）

### P3-T07 工分输入控件（Stepper + 直接输入）统一封装
- 任务描述：抽离统一的“0.1 精度输入控件”，支持 `+0.1/-0.1` 微调、输入纠错与格式化，避免页面重复实现。
- 涉及的文件/模块（计划新增/扩展）：
  - `components/biz-score-input/biz-score-input.uvue`（新增）
  - `domain/models/types.uts`（`pointsToUnits/unitsToPoints`）
  - 复用：`components/biz-cross-bin-input/biz-cross-bin-input.uvue`
- 依赖关系：P1-T06
- 验收标准：
  - [ ] 任意输入最终落为 0.1 精度且不出现浮点误差（内部单位整数）
  - [ ] 大字号/大触控区域满足现场操作

### P3-T08 会话保存数据结构落地（session JSON Schema）
- 任务描述：定义并固化“一期 session JSON”字段结构（bins/assignments/crossBinSources/penalties/...），保证后续统计/导出可稳定读取。
- 涉及的文件/模块：
  - `storage/storage-repository.uts`
  - `domain/models/stage-session.uts`
  - `domain/models/assignment.uts`
- 依赖关系：P3-T02, P3-T04, P3-T06
- 验收标准：
  - [ ] 单条会话 JSON 可独立还原录入页所有状态（含跨仓/晾堂/扣分等后续字段占位）
  - [ ] 同一字段命名在 PRD/方案与代码中一致（避免后续迁移成本）

### P3-T09 提交确认前置校验框架（错误集中展示）
- 任务描述：在录入页底部建立“实时对账状态 + 错误列表”展示框架，提交前统一拦截不合法状态。
- 涉及的文件/模块：
  - `domain/services/Validator.uts`
  - `pages/work/entry.uvue`
- 依赖关系：P3-T06
- 验收标准：
  - [ ] 不平衡/缺字段时提交按钮禁用或提交后明确报错
  - [ ] 错误文案能定位到具体仓号/岗位/差额，便于现场修正

### P3-T10 工作台“最近草稿/已提交”列表与快速入口
- 任务描述：补齐工作台列表：展示最近草稿、最近提交、按日期分组，支持快速继续编辑与删除草稿。
- 涉及的文件/模块：
  - `pages/index/index.uvue`
  - `storage/storage-repository.uts`（按日期索引查询）
- 依赖关系：P3-T02
- 验收标准：
  - [ ] 可从工作台一键进入指定日期/环节/轮次的会话
  - [ ] 删除草稿会同步清理索引（不出现“幽灵条目”）

---

## Phase 4：跨仓与会话计分（高复杂度）

**阶段目标**：落地 CROSS_BIN 抽取、SESSION 池子（晾堂/堆曲）、轮次/混合轮次规则、以及完整的对账校验闭环。

### P4-T01 CROSS_BIN 岗位录入（人 + 工分 + 来源预览）
- 任务描述：实现跨仓岗位通用化（拉车/打杂），支持按环节配置自动展示，或手动添加/移除（仅在允许的环节）。
- 涉及的文件/模块：
  - `components/biz-cross-bin-input/biz-cross-bin-input.uvue`
  - `domain/services/ScoreAllocator.uts`（跨仓最大余数法）
  - `domain/services/StageCoefService.uts`（环节岗位配置）
  - `pages/work/entry.uvue`
- 依赖关系：P3-T04, P3-T06
- 验收标准：
  - [ ] 修改跨仓工分或所选仓后，来源分摊实时更新且总和恒等
  - [ ] 来源预览能展示每仓扣减工分与占比（便于现场核对）

### P4-T02 CROSS_BIN 来源落库与回显
- 任务描述：跨仓分配需持久化 `AssignmentSource` 列表；再次进入会话需可完整回显来源与预览。
- 涉及的文件/模块：
  - `domain/models/assignment.uts`（`AssignmentSource`）
  - `storage/storage-repository.uts`（session JSON 存储结构）
  - `pages/work/entry.uvue`
- 依赖关系：P4-T01, P3-T08
- 验收标准：
  - [ ] `Assignment.points_units = SUM(source_points_units)` 校验可通过
  - [ ] 会话重进后来源预览一致（不因重新计算导致漂移）

### P4-T03 BIN 平衡计算：纳入跨仓扣减
- 任务描述：对每个仓实现“仓总分 = 仓内分配 + 被跨仓抽取”的平衡对账；并在 UI 中提示差额来源。
- 涉及的文件/模块：
  - `domain/services/Validator.uts`
  - `domain/models/assignment.uts`（`BinAssignmentSummary`）
  - `pages/work/entry.uvue`
- 依赖关系：P4-T02, P3-T09
- 验收标准：
  - [ ] 任意仓差额可精确定位并显示差额（单位到 0.1 分）
  - [ ] 不平衡时禁止提交确认

### P4-T04 安曲晾堂（SESSION）岗位池子生成与默认人员沿用
- 任务描述：按当日安曲总曲坯数生成晾堂各岗位池子；首次选人后默认沿用上一次安曲晾堂人员（仅回填人员，不回填分值）。
- 涉及的文件/模块（计划新增/扩展）：
  - `domain/services/DuiQuBaseService.uts`（`getAnQuLiangTangBase/calcAllLiangTangPools`）
  - `storage/storage-repository.uts`（`load/saveLiangTangDefault`）
  - `pages/work/entry.uvue`
- 依赖关系：P3-T04, P2-T06
- 验收标准：
  - [ ] 晾堂岗位展示“基数/系数/池子总分”，并与当日安曲总曲坯数联动
  - [ ] `micro_enabled=0` 时隐藏/禁用微机岗位，且提交校验阻止误录

### P4-T05 堆曲（SESSION）基数获取、兜底策略与堆曲仓号标识
- 任务描述：堆曲基数=当日拆曲总曲坯数（同日多单求和，不区分轮次）；无拆曲数据提供跳转或手工补录；堆曲必须录入 `session_room_code` 并默认沿用。
- 涉及的文件/模块：
  - `domain/services/DuiQuBaseService.uts`（`getDuiQuBase`）
  - `domain/stores/AppStore.uts`（`get/setLastDuiQuRoom`）
  - `pages/work/entry.uvue`
- 依赖关系：P3-T01, P3-T02
- 验收标准：
  - [ ] 当日存在拆曲数据时自动汇总并计算堆曲总分
  - [ ] 当日无拆曲数据时给出明确警告与两种操作入口（跳转/补录）
  - [ ] 堆曲仓号首次必填，后续默认回填，修改后成为新默认

### P4-T06 轮次/混合轮次规则在录入页的约束落地
- 任务描述：非安曲环节需推断所选仓归属轮次用于追溯；若同会话内所选仓来自不同轮次，需提示“按轮次拆分录入单”并禁止提交；堆曲允许“混合轮次”但需提示。
- 涉及的文件/模块（计划新增/扩展）：
  - `domain/services/RoundInferenceService.uts`（新增，或扩展现有服务）
  - `pages/work/entry.uvue`
- 依赖关系：P2-T06, P3-T05
- 验收标准：
  - [ ] 非安曲提交前能判断所选仓轮次一致性，不一致时明确阻止
  - [ ] 堆曲当日拆曲存在多个轮次时 `round_id` 允许为空且 UI 提示“混合轮次”

### P4-T07 提交确认：全量校验 + 状态切换
- 任务描述：提交确认前执行 BIN/CROSS_BIN/SESSION/站位/微机计分权等全量校验，通过后置 `status=submitted` 并记录 `updated_by_manager`。
- 涉及的文件/模块：
  - `domain/services/Validator.uts`
  - `pages/work/entry.uvue`
  - `domain/stores/AppStore.uts`（`EVENT_SESSION_SUBMITTED`）
- 依赖关系：P4-T03, P4-T04, P4-T05, P4-T06
- 验收标准：
  - [ ] 任何一条校验失败都不会写入 submitted 状态
  - [ ] 提交后仍可再次进入修改（历史可改），并正确更新 `updated_by_manager/updated_at`

### P4-T08 索引加速：按人/按仓索引维护（避免全盘扫描）
- 任务描述：在保存会话时维护 `pp:idx:person:*` 与 `pp:idx:bin:*`，用于统计与追责查询，减少 `uni.getStorageInfoSync()` 全量扫描。
- 涉及的文件/模块（计划新增/扩展）：
  - `storage/storage-repository.uts`（新增：`add/removeToPersonIndex/add/removeToBinIndex`）
  - `storage/storage-keys.uts`
- 依赖关系：P3-T02, P2-T08
- 验收标准：
  - [ ] person-detail/bin-detail 查询不依赖全量遍历所有 session key
  - [ ] 更新/删除会话后索引同步更新，查询结果无重复/无缺失

### P4-T09 公示标记字段（published_at）写入与回显（入口预留）
- 任务描述：支持在环节内触发【公示】写入 `published_at`，并为 Phase 5 的“公示预览页”提供数据与入口。
- 涉及的文件/模块：
  - `domain/models/stage-session.uts`（`published_at`）
  - `pages/work/entry.uvue`
  - `pages/stats/date-detail.uvue`
- 依赖关系：P3-T02
- 验收标准：
  - [ ] 触发公示后能记录时间戳并在统计页展示“最近公示时间”
  - [ ] 不产生锁定效果，修改后仍可再次公示

---

## Phase 5：考核与统计（中等复杂度）

**阶段目标**：实现扣分录入（原始/扣分/最终三段口径）、公示预览（截图友好）、按人/按仓/按日查询与概览统计。

### P5-T01 扣分数据结构与存储口径落地
- 任务描述：按“扣分独立明细”口径实现 PenaltyRecord 的存储、查询与汇总（最终分不回写 Assignment 原始分）。
- 涉及的文件/模块（计划新增/扩展）：
  - `domain/models/assignment.uts`（`PenaltyRecord`）
  - `domain/services/PenaltyService.uts`（新增：CRUD + 汇总）
  - `storage/storage-repository.uts`（session 内嵌 penalties 或独立 key 的实现方案）
- 依赖关系：P3-T08
- 验收标准：
  - [ ] 任何统计展示的最终分均满足：`final = raw - SUM(deducted)`
  - [ ] 扣分记录包含：日期、被考核人、考核人（管理员）、原因、扣分值

### P5-T02 录入页“考核”交互（原始-扣分=最终）
- 任务描述：在每条人员分配行提供【考核】按钮，展开两段式输入与原因必填，并实时计算最终分。
- 涉及的文件/模块：
  - `pages/work/entry.uvue`
  - `domain/models/assignment.uts`（`calcFinalPoints`）
  - `domain/services/PenaltyService.uts`（新增）
- 依赖关系：P5-T01, P3-T07
- 验收标准：
  - [ ] 扣分>0 时原因必填；扣分=0 可不填原因
  - [ ] 行内实时显示原始/扣分/最终，且最终不为负数

### P5-T03 每日公示预览页（截图友好）
- 任务描述：按日期+环节展示公示列表，默认显示最终分，可切换原始/扣分/最终；布局适合截图发送群。
- 涉及的文件/模块：
  - `pages/stats/date-detail.uvue`
  - `storage/storage-repository.uts`（按日期索引取会话）
  - `domain/services/PenaltyService.uts`
- 依赖关系：P4-T09, P5-T01
- 验收标准：
  - [ ] 同一日期不同环节可独立公示，互不影响
  - [ ] 公示页展示口径正确且可切换列（原始/扣分/最终）

### P5-T04 按人员查询（工资条）
- 任务描述：实现按人员维度汇总每日工分（原始/扣分/最终），可展开查看扣分明细原因。
- 涉及的文件/模块：
  - `pages/stats/person-detail.uvue`
  - `components/biz-worker-selector-pinyin/biz-worker-selector-pinyin.uvue`
  - `storage/storage-repository.uts`（`pp:idx:person:*`）
- 依赖关系：P4-T08, P5-T01
- 验收标准：
  - [ ] 选择人员后能看到按日期的工分明细与扣分原因
  - [ ] 数据来源可追溯到具体会话（支持跳转回录入页编辑）

### P5-T05 按发酵仓查询（追责定位：日期 + 仓号）
- 任务描述：按日期+仓号展示该仓当日人员与站位顺序（门口→最里面），并能查看对应扣分记录。
- 涉及的文件/模块：
  - `pages/stats/bin-detail.uvue`
  - `components/biz-bin-selector/biz-bin-selector.uvue`（或新增“单仓选择器”）
  - `storage/storage-repository.uts`（`pp:idx:bin:*`）
- 依赖关系：P4-T08, P5-T01
- 验收标准：
  - [ ] 能准确展示站位顺序与人员（position_index）
  - [ ] 可关联展示该仓相关的扣分原因（用于追责说明）

### P5-T06 统计首页概览（本月录入/总工分/参与人数）
- 任务描述：实现统计首页的聚合指标（按月/按日），优先从索引聚合，避免全量扫描。
- 涉及的文件/模块：
  - `pages/stats/index.uvue`
  - `storage/storage-repository.uts`（日期索引 + 可选月索引）
- 依赖关系：P4-T08
- 验收标准：
  - [ ] 指标能反映真实数据（提交/草稿区分口径需明确）
  - [ ] 数据量增大时依旧不卡顿（避免遍历全部 key）

### P5-T07 审计字段贯通（created_by/updated_by）
- 任务描述：会话与分配行写入管理员姓名快照（创建/更新），便于追溯“谁录入/谁最后修改”。
- 涉及的文件/模块：
  - `domain/models/stage-session.uts`
  - `domain/models/assignment.uts`
  - `domain/stores/AppStore.uts`（`getManagerName`）
  - `pages/work/entry.uvue`
- 依赖关系：P2-T07, P3-T02
- 验收标准：
  - [ ] 新建/修改会话时字段写入正确；旧数据读取缺字段时兼容为空字符串
  - [ ] 统计/详情页可展示创建者/最后编辑者（至少在详情页）

### P5-T08 公示/查询场景的 UX 强化
- 任务描述：优化公示/查询的可读性与截图体验（字号/对比/固定表头/一屏关键数据）。
- 涉及的文件/模块：
  - `pages/stats/date-detail.uvue`
  - `pages/stats/person-detail.uvue`
  - `pages/stats/bin-detail.uvue`
- 依赖关系：P5-T03, P5-T04, P5-T05
- 验收标准：
  - [ ] 公示列表无需横向滚动即可截图（或提供“截图模式”）
  - [ ] 列表滚动性能稳定（不出现明显掉帧）

---

## Phase 6：导入导出与优化（中等复杂度）

**阶段目标**：补齐 OCR 导入、Excel 模板导出、JSON 备份迁移、技能建议分配与自动平衡算法，并进行性能/体验优化。

### P6-T01 OCR 导入花名册（拍照/选图 → 识别 → 校对入库）
- 任务描述：接入 OCR（平台能力或第三方插件），仅提取“姓名”并复用 Phase 2 的校对流程。
- 涉及的文件/模块：
  - `pages/mine/roster-import.uvue`
  - `domain/services/OcrRosterService.uts`（新增，封装 OCR 调用与结果解析）
- 依赖关系：P2-T02
- 验收标准：
  - [ ] OCR 结果无论好坏都进入校对列表（可编辑/删除/去重）
  - [ ] OCR 失败可明确提示并允许改用粘贴导入

### P6-T02 Excel 模板选择与持久化
- 任务描述：实现模板文件选择、保存模板引用（路径/文件信息），以及导出相关配置项（列映射增强项可后置）。
- 涉及的文件/模块：
  - `pages/mine/settings.uvue`
  - `domain/services/ExcelTemplateService.uts`（新增）
  - `storage/storage-repository.uts`（新增对应 cfg key）
- 依赖关系：P2-T07
- 验收标准：
  - [ ] 模板选择后可持久化，重启仍可用于导出
  - [ ] 能展示模板文件名与最后更新时间（便于核对）

### P6-T03 Excel 导出服务（按日期 + 姓名定位填充）
- 任务描述：按既定模板规则定位单元格并填入数据，另存为新文件并调用系统分享/保存；导出后输出缺失清单。
- 涉及的文件/模块（计划新增/扩展）：
  - `domain/services/ExcelExportService.uts`（新增）
  - `pages/stats/date-detail.uvue`（导出入口）
  - 依赖数据：`storage/storage-repository.uts`、`domain/services/PenaltyService.uts`
- 依赖关系：P6-T02, P5-T01, P5-T03
- 验收标准：
  - [ ] 模板定位遵循约定：`B列=姓名`、`第2行=日期(YYYY/MM/DD)`、填值为交叉单元格
  - [ ] 默认填“最终工分”；可配置增强项：写入原始/扣分/最终三列
  - [ ] 导出完成后展示“模板缺失的姓名/日期”清单

### P6-T04 JSON 备份导出/导入（离线迁移兜底）
- 任务描述：提供全量或按日期导出 JSON，用于人工备份与跨设备迁移；导入支持覆盖/合并策略（二次确认）。
- 涉及的文件/模块（计划新增）：
  - `pages/mine/settings.uvue`（或新增 `pages/mine/backup.uvue`）
  - `domain/services/BackupService.uts`
  - `storage/storage-repository.uts`
- 依赖关系：P1-T03
- 验收标准：
  - [ ] 导出文件包含版本号与时间戳（便于回滚）
  - [ ] 导入过程有明确风险提示与二次确认，避免误覆盖

### P6-T05 技能建议分配（最大余数法）落地到 BIN/SESSION
- 任务描述：实现“一键按技能建议分配”，基于技能系数按比例分配到 0.1 精度，保证总和不变。
- 涉及的文件/模块：
  - `domain/services/ScoreAllocator.uts`（`allocateBinPointsByCoef`）
  - `storage/storage-repository.uts`（技能系数数据）
  - `components/biz-bin-card/biz-bin-card.uvue`
  - `pages/work/entry.uvue`
- 依赖关系：P2-T04, P3-T06
- 验收标准：
  - [ ] 建议分配结果满足 `SUM(units_i)=totalUnits` 且符合最大余数法
  - [ ] 管理员可在建议值基础上继续微调，不影响对账闭环

### P6-T06 微调平衡算法（同作用域自动平衡 + 剩余单位轮转）
- 任务描述：实现“调整一人 → 同作用域内其他人自动平衡”的算法（按技能系数权重分摊），并按规则处理不足 0.1 的剩余单位轮转。
- 涉及的文件/模块（计划新增/扩展）：
  - `domain/services/BalanceService.uts`（新增）
  - `components/biz-score-input/biz-score-input.uvue`
  - `components/biz-bin-card/biz-bin-card.uvue`
- 依赖关系：P6-T05, P3-T07
- 验收标准：
  - [ ] 任意微调后，BIN/SESSION 池子总分保持不变
  - [ ] 剩余单位按“第一名/第二名交替”规则分配，长期不偏置同一人
  - [ ] UI 对被联动调整的行有明显反馈（高亮/提示）

### P6-T07 性能与存储容量优化（小程序限制适配）
- 任务描述：在大量录入（多日期、多仓）场景下，优化查询与存储体积：索引、分页、字段裁剪、避免单 key 过大。
- 涉及的文件/模块：
  - `storage/storage-repository.uts`
  - `storage/storage-keys.uts`
  - 相关页面：`pages/stats/*`、`pages/index/index.uvue`
- 依赖关系：P4-T08, P5-T06
- 验收标准：
  - [ ] 单日多仓录入时会话 JSON 仍控制在合理体积（避免单 key 超限）
  - [ ] 统计/查询页首屏响应时间可接受（不出现明显卡顿）

### P6-T08 现场输入体验增强（大键盘/容错/提示）
- 任务描述：实现更适合手套操作的大按钮数字键盘、输入容错提示、关键提示文案与操作反馈。
- 涉及的文件/模块：
  - `components/biz-score-input/biz-score-input.uvue`
  - `pages/work/entry.uvue`
  - `components/*`（通用弹窗/提示组件）
- 依赖关系：P3-T07
- 验收标准：
  - [ ] 直接输入时自动格式化为 1 位小数，不合法输入可被纠正并提示
  - [ ] 提交/公示/导出等关键动作有二次确认或明确反馈

---

## 附：执行顺序建议（跨 Phase 的关键依赖链）

1. **先配置与花名册**（P2-T01~T07）→ 才能顺畅完成录入页人员选择与审计字段
2. **先 BIN 卡片闭环**（P3-T03~T09）→ 再做 CROSS_BIN/SESSION（Phase 4）→ 再做扣分/统计（Phase 5）
3. **索引维护尽早做**（P4-T08）→ 否则统计/查询会被全量扫描拖慢
4. **导出/OCR/技能建议**（Phase 6）可在核心闭环稳定后迭代上线

