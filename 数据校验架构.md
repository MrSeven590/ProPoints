# 数据校验架构文档

> **最后更新**: 2026-02-13
> **目的**: 记录项目中数据校验的实现方式和位置，便于后期修改和维护

---

## 概述

项目采用**两层校验架构**：

| 校验层级 | 阻塞性 | 目的 | 实现方式 |
|---------|--------|------|---------|
| **UI层校验** | ❌ 非阻塞 | 提升用户体验 | 视觉提示、自动修正、禁用状态 |
| **提交时校验** | ✅ 完全阻塞 | 保证数据完整性 | 强制校验，失败则阻止提交 |

**设计理念**: UI层提供友好的输入体验，提交时进行强制校验确保脏数据无法进入存储层。

---

## 一、UI层校验（非阻塞）

### 1.1 工分输入控件

**文件**: `components/biz-score-input/biz-score-input.uvue`

**校验逻辑**:
- **位置**: `onPointsBlur()` 方法 (124-139行)
- **触发时机**: 输入框失焦时
- **校验内容**:
  - 解析输入值，NaN 转为 0
  - 应用 min/max 边界限制
  - 格式化显示值
- **阻塞性**: ❌ 不阻止输入，只在失焦时自动修正

```typescript
// components/biz-score-input/biz-score-input.uvue:124-139
onPointsBlur() {
  // 解析输入值
  let inputVal = parseFloat(this.displayPoints)
  if (isNaN(inputVal)) {
    inputVal = 0
  }
  // 转换为整数单位
  let units = pointsToUnits(inputVal)
  // 应用边界限制
  units = this.clampValue(units)
  // 更新内部状态
  this.internalUnits = units
  this.displayPoints = units == 0 ? '' : formatPointsUnits(units)
  // 发送更新事件
  this.$emit('update:modelValue', units)
}
```

**Props 配置**:
- `min`: 最小值（单位），默认 0
- `max`: 最大值（单位），默认 null（无限制）
- `step`: 步进值（单位），默认 1（对应 0.1 分）
- `disabled`: 禁用状态

---

### 1.2 人员选择器

**文件**: `components/biz-worker-selector-pinyin/biz-worker-selector-pinyin.uvue`

**校验逻辑**:
- **位置**: `getPersonItemClass()` 方法 (248-256行)
- **校验内容**: 检查人员是否已被占用
- **阻塞性**: ❌ 仅视觉提示（灰色禁用样式）

```typescript
// components/biz-worker-selector-pinyin/biz-worker-selector-pinyin.uvue:248-256
getPersonItemClass(person: SearchablePerson): string {
  if (this.isPersonOccupied(person)) {
    return 'person-item-disabled'  // 灰色背景
  }
  if (this.isPersonSelected(person)) {
    return 'person-item-selected'  // 蓝色选中
  }
  return 'person-item'
}
```

**样式**:
```css
.person-item-disabled {
  background-color: #f5f5f5;
  border-color: #e8e8e8;
}

.person-name-disabled {
  color: #bbbbbb;
}
```

---

### 1.3 跨仓工分输入

**文件**: `components/biz-cross-bin-input/biz-cross-bin-input.uvue`

**校验逻辑**:
- **位置**: `onPointsBlur()` 方法 (33-34行)
- **校验内容**: 与 `biz-score-input` 类似的失焦格式化
- **阻塞性**: ❌ 不阻止输入

---

## 二、提交时校验（完全阻塞）

### 2.1 校验入口

**文件**: `pages/work/entry.uvue`
**方法**: `submit()` (1341-1571行)

**校验流程**:
```
1. 数据校验（工分平衡、跨仓来源）
   ↓ 失败 → 显示 Modal "无法提交" → return
2. 基础必填校验
   ↓ 失败 → 显示 Toast → return
3. 晾堂岗位校验（仅安曲环节）
   ↓ 失败 → 显示 Toast/Modal → return
4. 用户确认 Modal
   ↓ 确认 → 提交数据
```

---

### 2.2 数据校验（使用 Validator 服务）

#### 2.2.1 发酵仓工分平衡校验

**位置**: `pages/work/entry.uvue:1347-1373`

**校验规则**:
```
bin.total_points_units = sum(BIN分配原始工分) + sum(从该仓抽取的工分)
```

**实现**:
```typescript
// pages/work/entry.uvue:1347-1373
// 1. 校验 BIN 平衡
if (this.showBinSection == true) {
  for (let i = 0; i < this.stageBinInfos.length; i++) {
    const info = this.stageBinInfos[i]
    const cardData = this.binCardsData.get(info.stage_bin_id)
    if (cardData != null) {
      // 计算已分配原始工分
      let assignedOriginalUnits = 0
      for (let j = 0; j < cardData.assignments.length; j++) {
        assignedOriginalUnits += cardData.assignments[j].original_points_units
      }

      // 获取跨仓抽取工分
      const crossDeduction = this.getCrossBinDeduction(info.stage_bin_id)

      // 校验平衡
      const result = validateBinBalance({
        bin_id: info.bin_id,
        bin_code: info.bin_code,
        total_points_units: cardData.totalPointsUnits,
        assigned_points_units: assignedOriginalUnits,
        cross_bin_deducted_units: crossDeduction
      })
      validationResults.push(result)
    }
  }
}
```

**校验服务**: `domain/services/Validator.uts:validateBinBalance()` (34-49行)

**失败处理**:
```typescript
// pages/work/entry.uvue:1387-1399
if (finalResult.isValid == false) {
  let errorMsg = '数据校验失败：\n'
  for (let i = 0; i < finalResult.errors.length; i++) {
    errorMsg = errorMsg + '\n' + (i + 1) + '. ' + finalResult.errors[i]
  }
  uni.showModal({
    title: '无法提交',
    content: errorMsg,
    showCancel: false
  })
  return  // ✅ 阻止提交
}
```

---

#### 2.2.2 跨仓来源完整性校验

**位置**: `pages/work/entry.uvue:1375-1383`

**校验规则**:
```
Assignment.points_units = sum(AssignmentSource.source_points_units)
```

**实现**:
```typescript
// pages/work/entry.uvue:1375-1383
// 2. 校验跨仓来源完整性
if (this.showCrossBinSection == true && this.crossBinPointsUnits > 0) {
  let sourceSum = 0
  for (let i = 0; i < this.crossBinSources.length; i++) {
    sourceSum = sourceSum + this.crossBinSources[i].source_points_units
  }
  const result = validateCrossBinSource(this.crossBinPointsUnits, sourceSum)
  validationResults.push(result)
}
```

**校验服务**: `domain/services/Validator.uts:validateCrossBinSource()` (59-73行)

---

#### 2.2.3 会话池子平衡校验

**校验服务**: `domain/services/Validator.uts:validateSessionPoolBalance()` (83-98行)

**校验规则**:
```
session_total_points_units = sum(SESSION分配原始工分)
```

**注**: 当前在录入页未直接调用，但服务已实现，可用于晾堂等会话级校验。

---

### 2.3 基础必填校验

#### 2.3.1 安曲记录完整性

**位置**: `pages/work/entry.uvue:1405-1424`

**校验内容**: 堆曲/翻曲环节必须有对应的安曲记录（用于获取曲坯数）

**实现**:
```typescript
// pages/work/entry.uvue:1405-1424
// 校验是否存在缺失安曲记录的仓
if (this.missingAnQuBins.length > 0) {
  const binList = this.missingAnQuBins.join(', ')
  uni.showModal({
    title: '无法提交',
    content: `以下仓位缺少安曲记录: ${binList}，请先录入安曲数据。`,
    showCancel: false,
    success: (res) => {
      if (res.confirm == true) {
        // 跳转到安曲录入页
        uni.navigateTo({
          url: `/pages/work/entry?date=${this.sessionDate}&stage=AN_QU&round=${this.roundId}`
        })
      }
    }
  })
  return  // ✅ 阻止提交
}
```

**数据来源**: `missingAnQuBins` 计算属性，调用 `getBinKojiCountFromAnQu()` 检查

---

#### 2.3.2 发酵仓选择校验

**位置**: `pages/work/entry.uvue:1426-1433`

**校验内容**: 非堆曲环节必须选择至少一个发酵仓

**实现**:
```typescript
// pages/work/entry.uvue:1426-1433
// 校验是否有发酵仓数据（非堆曲环节）
if (this.showBinSection == true && this.stageBinInfos.length == 0) {
  uni.showToast({
    title: '请选择发酵仓',
    icon: 'none'
  })
  return  // ✅ 阻止提交
}
```

---

#### 2.3.3 仓位人员分配校验

**位置**: `pages/work/entry.uvue:1435-1464`

**校验内容**: 每个选中的发酵仓必须至少有一个人员分配

**实现**:
```typescript
// pages/work/entry.uvue:1435-1464
// 校验每个仓是否有人员分配
if (this.showBinSection == true) {
  for (let i = 0; i < this.stageBinInfos.length; i++) {
    const info = this.stageBinInfos[i]
    const cardData = this.binCardsData.get(info.stage_bin_id)
    if (cardData == null) {
      uni.showToast({
        title: `请为仓位 ${info.bin_code} 分配人员`,
        icon: 'none'
      })
      return  // ✅ 阻止提交
    }

    // 检查是否有有效的人员分配
    let hasValidAssignment = false
    for (let j = 0; j < cardData.assignments.length; j++) {
      if (cardData.assignments[j].person_id != null) {
        hasValidAssignment = true
        break
      }
    }
    if (hasValidAssignment == false) {
      uni.showToast({
        title: `请为仓位 ${info.bin_code} 分配人员`,
        icon: 'none'
      })
      return  // ✅ 阻止提交
    }
  }
}
```

---

#### 2.3.4 跨仓岗位人员校验

**位置**: `pages/work/entry.uvue:1466-1475`

**校验内容**: 如果有跨仓工分，必须选择跨仓岗位人员

**实现**:
```typescript
// pages/work/entry.uvue:1466-1475
// 校验跨仓岗位
if (this.showCrossBinSection == true && this.crossBinPointsUnits > 0) {
  if (this.crossBinPersonId == null) {
    uni.showToast({
      title: '请选择跨仓岗位人员',
      icon: 'none'
    })
    return  // ✅ 阻止提交
  }
}
```

---

### 2.4 晾堂岗位校验（仅安曲环节）

**位置**: `pages/work/entry.uvue:1477-1528`

#### 2.4.1 微机计分权校验

**位置**: `pages/work/entry.uvue:1479-1498`

**校验内容**: 当前轮次未开启微机计分权时，不允许有微机记录

**实现**:
```typescript
// pages/work/entry.uvue:1479-1498
// 校验微机计分权（micro_enabled=0 时不允许有微机记录）
if (this.microEnabled == false) {
  const microData = this.liangTangRolesData.get('MICRO_OPERATOR')
  if (microData != null && microData.workers.length > 0) {
    let hasMicroWorker = false
    for (let i = 0; i < microData.workers.length; i++) {
      if (microData.workers[i].personId != null) {
        hasMicroWorker = true
        break
      }
    }
    if (hasMicroWorker == true) {
      uni.showModal({
        title: '无法提交',
        content: '当前轮次未开启微机计分权，请移除微机岗位人员。',
        showCancel: false
      })
      return  // ✅ 阻止提交
    }
  }
}
```

**微机权限判断**: 使用 `isMicroEnabledByRoundId(this.roundId)` 判断会话所属轮次的微机权限

---

#### 2.4.2 晾堂岗位工分平衡校验

**位置**: `pages/work/entry.uvue:1500-1528`

**校验内容**: 每个晾堂岗位的已分配工分必须等于该岗位的工分池

**实现**:
```typescript
// pages/work/entry.uvue:1500-1528
// 校验各晾堂岗位工分平衡
const liangTangRoles: LiangTangRoleValidation[] = [
  { code: 'WHEAT_MATERIAL', name: '麦料参数', pool: this.calcWheatMaterialPoolUnits() },
  { code: 'MACHINE_GUARD', name: '守机', pool: this.calcMachineGuardPoolUnits() },
  { code: 'KOJI_UNLOADER', name: '下曲', pool: this.calcKojiUnloaderPoolUnits() }
]
// 如果微机计分权开启，也校验微机岗位
if (this.microEnabled == true) {
  liangTangRoles.push({
    code: 'MICRO_OPERATOR',
    name: '微机',
    pool: this.calcMicroOperatorPoolUnits()
  })
}

for (let i = 0; i < liangTangRoles.length; i++) {
  const role = liangTangRoles[i]
  const roleData = this.liangTangRolesData.get(role.code)
  if (roleData != null) {
    let totalAssigned = 0
    for (let j = 0; j < roleData.workers.length; j++) {
      totalAssigned = totalAssigned + roleData.workers[j].pointsUnits
    }
    if (totalAssigned != role.pool) {
      uni.showToast({
        title: `${role.name}岗位工分未分配完`,
        icon: 'none'
      })
      return  // ✅ 阻止提交
    }
  }
}
```

**工分池计算方法**:
- `calcWheatMaterialPoolUnits()`: 麦料参数岗位工分池
- `calcMachineGuardPoolUnits()`: 守机岗位工分池
- `calcKojiUnloaderPoolUnits()`: 下曲岗位工分池
- `calcMicroOperatorPoolUnits()`: 微机岗位工分池

---

## 三、校验服务层

### 3.1 Validator 服务

**文件**: `domain/services/Validator.uts`

**导出函数**:

| 函数名 | 用途 | 返回类型 |
|--------|------|---------|
| `validateBinBalance()` | 校验发酵仓工分平衡 | `ValidationResult` |
| `validateCrossBinSource()` | 校验跨仓来源完整性 | `ValidationResult` |
| `validateSessionPoolBalance()` | 校验会话池子平衡 | `ValidationResult` |
| `mergeValidationResults()` | 合并多个校验结果 | `ValidationResult` |

**类型定义**:
```typescript
// domain/services/Validator.uts:11-14
export type ValidationResult = {
  isValid: boolean
  errors: string[]
}

// domain/services/Validator.uts:19-25
export type BinBalanceData = {
  bin_id: number
  bin_code: string
  total_points_units: PointsUnits
  assigned_points_units: PointsUnits
  cross_bin_deducted_units: PointsUnits
}
```

---

### 3.2 校验结果合并

**函数**: `mergeValidationResults()`
**位置**: `domain/services/Validator.uts:105-123`

**用途**: 将多个校验结果合并为一个，收集所有错误信息

**实现**:
```typescript
// domain/services/Validator.uts:105-123
export function mergeValidationResults(results: ValidationResult[]): ValidationResult {
  const allErrors: string[] = []
  let allValid = true

  for (let i = 0; i < results.length; i++) {
    const result = results[i]
    if (!result.isValid) {
      allValid = false
      for (let j = 0; j < result.errors.length; j++) {
        allErrors.push(result.errors[j])
      }
    }
  }

  return {
    isValid: allValid,
    errors: allErrors
  } as ValidationResult
}
```

---

## 四、修改指南

### 4.1 添加新的UI层校验

**场景**: 需要在输入时提供实时反馈

**步骤**:
1. 在组件的 `@input` 或 `@blur` 事件中添加校验逻辑
2. 使用 `disabled` 属性或样式类提供视觉反馈
3. **不要阻止用户操作**，只提供提示

**示例**: 参考 `biz-score-input.uvue:124-139`

---

### 4.2 添加新的提交时校验

**场景**: 需要强制保证数据完整性

**步骤**:

1. **如果是通用校验规则**，在 `Validator.uts` 中添加新函数:
   ```typescript
   // domain/services/Validator.uts
   export function validateNewRule(data: NewRuleData): ValidationResult {
     const errors: string[] = []

     // 校验逻辑
     if (/* 校验失败条件 */) {
       errors.push('错误信息')
     }

     return {
       isValid: errors.length == 0,
       errors: errors
     } as ValidationResult
   }
   ```

2. **在 `entry.uvue` 的 `submit()` 方法中调用**:
   ```typescript
   // pages/work/entry.uvue:submit()

   // 在 "数据校验" 部分添加
   const newResult = validateNewRule(/* 数据 */)
   validationResults.push(newResult)

   // 或在 "基础必填校验" 部分添加
   if (/* 校验失败条件 */) {
     uni.showToast({
       title: '错误提示',
       icon: 'none'
     })
     return  // ✅ 阻止提交
   }
   ```

3. **确保在所有校验通过后才显示确认 Modal** (1530行)

---

### 4.3 修改现有校验规则

**步骤**:

1. **定位校验位置**:
   - 查看本文档的"二、提交时校验"部分
   - 找到对应的文件和行号

2. **修改校验逻辑**:
   - 如果是 Validator 服务中的规则，修改 `domain/services/Validator.uts`
   - 如果是页面特定的规则，修改 `pages/work/entry.uvue:submit()`

3. **更新错误提示**:
   - Toast: 用于简单提示
   - Modal: 用于需要用户确认或提供详细信息的场景

4. **测试**:
   - 测试校验失败时是否正确阻止提交
   - 测试错误提示是否清晰
   - 测试校验通过时是否能正常提交

---

### 4.4 调整校验的阻塞性

**场景**: 需要将某个校验从阻塞改为非阻塞，或反之

**从阻塞改为非阻塞**:
1. 移除 `return` 语句
2. 改用 Toast 提示或视觉反馈
3. 允许用户继续操作

**从非阻塞改为阻塞**:
1. 在 `submit()` 方法中添加校验逻辑
2. 校验失败时显示错误提示
3. 添加 `return` 语句阻止提交

---

## 五、已知问题和改进建议

### 5.1 已知问题

参考 `开发进度.md` 中的"待修复问题清单":

| 编号 | 问题描述 | 影响范围 | 相关校验 |
|------|---------|---------|---------|
| H1 | 微机岗位严格1人仅在 UI 层强制 | 数据完整性 | 建议在提交时添加校验 |
| M1 | 晾堂校验只检查 map 中存在的岗位 | 数据完整性 | 改为遍历所有必需岗位 |

---

### 5.2 改进建议

1. **统一校验框架**:
   - 考虑将所有提交时校验统一到 Validator 服务
   - 定义统一的校验配置格式

2. **错误提示优化**:
   - 考虑使用统一的错误提示组件
   - 提供更详细的错误定位信息（如仓号、岗位名）

3. **校验规则文档化**:
   - 在 Validator 服务中添加详细的注释
   - 说明每个校验规则的业务背景

4. **测试覆盖**:
   - 为每个校验规则编写测试用例
   - 确保边界情况被正确处理

---

## 六、快速参考

### 6.1 关键文件

| 文件 | 用途 |
|------|------|
| `domain/services/Validator.uts` | 通用校验服务 |
| `pages/work/entry.uvue` | 录入页提交校验 |
| `components/biz-score-input/biz-score-input.uvue` | 工分输入控件 |
| `components/biz-worker-selector-pinyin/biz-worker-selector-pinyin.uvue` | 人员选择器 |

---

### 6.2 校验类型速查

| 校验类型 | 阻塞性 | 位置 |
|---------|--------|------|
| 工分输入边界 | ❌ | `biz-score-input.uvue:124-139` |
| 人员占用提示 | ❌ | `biz-worker-selector-pinyin.uvue:248-256` |
| 发酵仓工分平衡 | ✅ | `entry.uvue:1347-1373` |
| 跨仓来源完整性 | ✅ | `entry.uvue:1375-1383` |
| 安曲记录完整性 | ✅ | `entry.uvue:1405-1424` |
| 发酵仓选择 | ✅ | `entry.uvue:1426-1433` |
| 仓位人员分配 | ✅ | `entry.uvue:1435-1464` |
| 跨仓岗位人员 | ✅ | `entry.uvue:1466-1475` |
| 微机计分权 | ✅ | `entry.uvue:1479-1498` |
| 晾堂岗位工分平衡 | ✅ | `entry.uvue:1500-1528` |

---

## 七、变更记录

| 日期 | 变更内容 |
|------|---------|
| 2026-02-13 | 初始版本，记录当前校验架构 |

---

**维护说明**: 每次修改校验逻辑后，请更新本文档对应部分。
