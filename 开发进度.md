# 开发进度：白酒制曲车间工分管理系统

> **最后更新**：2026-02-22
> **总体进度**：约 88%
> **Git 状态**：main 分支，最新提交 d84b3a3

---

## 📊 进度概览

| Phase | 阶段名称 | 计划任务 | 完成 | 进行中 | 未开始 | 完成度 |
|-------|---------|---------|------|--------|--------|--------|
| Phase 1 | 基础架构搭建 | 5 | 5 | 0 | 0 | ✅ 100% |
| Phase 2 | 人员与配置模块 | 8 | 6 | 2 | 0 | 🔄 75% |
| Phase 3 | 工分录入核心功能 | 10 | 10 | 0 | 0 | ✅ 100% |
| Phase 4 | 跨仓与会话计分 | 9 | 9 | 0 | 0 | ✅ 100% |
| Phase 5 | 考核与统计 | 8 | 8 | 0 | 0 | ✅ 100% |
| Phase 6 | 导入导出与优化 | 8 | 0 | 2 | 6 | ❌ 10% |

---

## Phase 1：基础架构搭建 — ✅ 100%

| 任务编号 | 任务名称 | 状态 | 说明 |
|----------|---------|------|------|
| P1-T01 | 目录结构与模块边界固化 | ✅ 完成 | pages/components/domain/storage 结构清晰，无跨层循环依赖 |
| P1-T02 | 核心数据类型与枚举统一 | ✅ 完成 | types.uts、stage-session.uts、assignment.uts、person.uts、ferment.uts 完整 |
| P1-T03 | Storage Key 规范与 Repository 基座 | ✅ 完成 | storage-keys.uts Key 规范、storage-repository.uts 读写封装、init.uts 初始化完整 |
| P1-T05 | App 初始化与 TabBar/路由打通 | ✅ 完成 | App.uvue 启动初始化、pages.json TabBar 配置完整 |
| P1-T06 | 基础 UI 规范与通用样式基座 | ✅ 完成 | 全局样式已定义，统一按钮/卡片样式已实现 |

> **备注**：P1-T04 SQLite 建表任务已移除（当前项目采用AppStore存储架构，暂不改动）

---

## Phase 2：人员与配置模块 — 🔄 75%

| 任务编号 | 任务名称 | 状态 | 说明 |
|----------|---------|------|------|
| P2-T01 | 花名册数据模型与 CRUD | ✅ 完成 | domain/models/person.uts + pages/mine/roster-import.uvue |
| P2-T02 | 粘贴导入 → 校对列表 → 去重入库 | 🔄 部分完成 | 页面存在，需验证完整导入流程 |
| P2-T03 | 拼音索引生成策略 | ✅ 完成 | PinyinMatchService.uts（45KB）+ PersonSearchService.uts 完整实现 |
| P2-T04 | 技能系数配置与持久化 | 🔄 部分完成 | Storage 层支持已实现，UI 配置入口需验证 |
| P2-T05 | 发酵仓楼层默认仓数配置 | ✅ 完成 | BinService.uts + pages/mine/class-config.uvue |
| P2-T06 | 轮次管理与微机计分权推断 | ✅ 完成 | RoundService.uts（21KB）完整实现 |
| P2-T07 | 管理员姓名与导出模板设置 | ✅ 完成 | pages/mine/settings.uvue + Storage 层支持 |
| P2-T08 | 发酵仓基础表与 ID 分配策略 | ✅ 完成 | ferment.uts + BinService.uts |

---

## Phase 3：工分录入核心功能 — ✅ 100%

| 任务编号 | 任务名称 | 状态 | 说明 |
|----------|---------|------|------|
| P3-T01 | 统一录入页：顶部上下文与日期切换 | ✅ 完成 | pages/work/entry.uvue 日期选择、环节标题、动态渲染 |
| P3-T02 | StageSession 生命周期 | ✅ 完成 | 会话创建、加载、保存草稿逻辑完整 |
| P3-T03 | 发酵仓选择器接入与默认体验 | ✅ 完成 | components/biz-bin-selector/biz-bin-selector.uvue |
| P3-T04 | 仓卡片组件与曲坯数录入 | ✅ 完成 | biz-bin-card.uvue（860行）完整实现，含人员分配、工分输入、互斥逻辑 |
| P3-T05 | 曲坯数复用：从安曲记录带出 | ✅ 完成 | entry.uvue 调用 getBinKojiCountFromAnQu，缺失时警告并阻止提交 |
| P3-T06 | BIN 工分分配行 | ✅ 完成 | 已集成在 biz-bin-card 组件中（站位顺序、人员选择、工分输入） |
| P3-T07 | 工分输入控件统一封装 | ✅ 完成 | biz-score-input.uvue（295行）支持 v-model、两种尺寸、禁用态 |
| P3-T08 | 会话保存数据结构落地 | ✅ 完成 | stage-session.uts 结构完整，Storage 支持完整 |
| P3-T09 | 提交确认前置校验框架 | ✅ 完成 | Validator.uts 已实现 |
| P3-T10 | 工作台最近草稿/已提交列表 | ✅ 完成 | pages/index/index.uvue 实现草稿/已提交列表、删除、跳转功能 |

---

## Phase 4：跨仓与会话计分 — ✅ 100%

| 任务编号 | 任务名称 | 状态 | 说明 |
|----------|---------|------|------|
| P4-T01 | CROSS_BIN 岗位录入 | ✅ 完成 | biz-cross-bin-input.uvue（583行）完整实现 |
| P4-T02 | CROSS_BIN 来源落库与回显 | ✅ 完成 | AssignmentSource 类型定义、持久化、回显完整 |
| P4-T03 | BIN 平衡计算：纳入跨仓扣减 | ✅ 完成 | Validator.uts 校验逻辑含跨仓扣减 |
| P4-T04 | 安曲晾堂池子生成 | ✅ 完成 | biz-session-role-card.uvue（549行）完整实现，晾堂四岗位录入、微机权限控制、简化模式 |
| P4-T05 | 堆曲基数获取与兜底策略 | ✅ 完成 | DuiQuBaseService.uts 堆曲基数计算、兜底策略 |
| P4-T06 | 轮次/混合轮次规则约束 | ✅ 完成 | RoundService.uts 服务完整，录入页约束落地完成 |
| P4-T07 | 提交确认：全量校验 + 状态切换 | ✅ 完成 | Validator.uts + 状态切换逻辑 |
| P4-T08 | 索引加速：按人/按仓索引维护 | ✅ 完成 | Storage Key 规范已定义（person/bin 索引） |
| P4-T09 | 公示标记字段写入与回显 | ✅ 完成 | published_at 字段定义、数据结构支持完整 |

---

## Phase 5：考核与统计 — ✅ 100%

| 任务编号 | 任务名称 | 状态 | 说明 |
|----------|---------|------|------|
| P5-T01 | 扣分数据结构与存储口径 | ✅ 完成 | PenaltyService.uts（400行）CRUD + 汇总功能完整 |
| P5-T02 | 录入页"考核"交互 | ✅ 完成 | biz-bin-card.uvue 考核按钮、草稿模式、三段式工分显示、数据校验完整 |
| P5-T03 | 每日公示预览页 | ✅ 完成 | pages/stats/date-detail.uvue 按日期+环节展示,支持切换显示列 |
| P5-T04 | 按人员查询（工资条） | ✅ 完成 | pages/stats/person-detail.uvue 工分明细+扣分原因+跳转编辑 |
| P5-T05 | 按发酵仓查询 | ✅ 完成 | pages/stats/bin-detail.uvue 站位顺序+追责定位 |
| P5-T06 | 统计首页概览 | ✅ 完成 | pages/stats/index.uvue 本月概览+最近录入 |
| P5-T07 | 审计字段贯通 | ✅ 完成 | created_by_manager/updated_by_manager 字段写入逻辑完整 |
| P5-T08 | 公示/查询场景 UX 强化 | ✅ 完成 | 仓号数值排序、独立编辑按钮、最终分统一计算 |

---

## Phase 6：导入导出与优化 — ❌ 10%

| 任务编号 | 任务名称 | 状态 | 说明 |
|----------|---------|------|------|
| P6-T01 | OCR 导入花名册 | ❌ 未开始 | — |
| P6-T02 | Excel 模板选择与持久化 | ❌ 未开始 | — |
| P6-T03 | Excel 导出服务 | ❌ 未开始 | — |
| P6-T04 | JSON 备份导出/导入 | ❌ 未开始 | — |
| P6-T05 | 技能建议分配 | 🔄 算法已完成 | ScoreAllocator.uts 完整，**UI "一键建议"按钮缺失** |
| P6-T06 | 微调平衡算法 | 🔄 算法已完成 | ScoreAllocator.uts（535行）含最大余数法、轮转规则，**UI 交互缺失** |
| P6-T07 | 性能与存储容量优化 | ❌ 未开始 | — |
| P6-T08 | 现场输入体验增强 | ❌ 未开始 | — |

---

## 🎯 已完成的核心能力

### 算法层（完整）

- ✅ **工分计算**：ScoreCalculator.uts — 仓总分、环节系数
- ✅ **跨仓抽取**：ScoreAllocator.uts — 最大余数法按曲坯数比例分摊
- ✅ **技能分配**：ScoreAllocator.uts — 按技能系数分配、微调平衡
- ✅ **拼音匹配**：PinyinMatchService.uts（45KB）— 全拼/首字母搜索
- ✅ **轮次管理**：RoundService.uts（21KB）— 轮次创建/结束/微机计分权
- ✅ **扣分服务**：PenaltyService.uts（400行）— CRUD + 汇总，final = raw - deducted

### 组件层（部分）

- ✅ **发酵仓选择器**：biz-bin-selector — 网格多选、智能推断
- ✅ **人员选择器**：biz-worker-selector-pinyin — 拼音搜索、互斥
- ✅ **跨仓岗位录入**：biz-cross-bin-input — 完整实现（583行）
- ✅ **仓卡片组件**：biz-bin-card — 完整实现（860行），含人员分配、工分输入
- ✅ **工分输入控件**：biz-score-input — 统一封装（295行），支持 v-model、两种尺寸
- ✅ **晾堂岗位卡片**：biz-session-role-card — 完整实现（549行），支持简化模式、自动工分分配

### 数据层（完整）

- ✅ **Storage Key 规范**：会话/索引/配置完整定义
- ✅ **类型系统**：全部核心数据模型定义完整
- ✅ **初始化逻辑**：init.uts 启动初始化

---

## 🚀 下一步开发建议

### 高优先级（完善核心闭环）

| 优先级 | 任务 | 说明 |
|--------|------|------|
| 🔴 P0 | 功能测试与验证 | 验证统计查询功能、草稿覆盖bug修复效果 |
| 🟡 P1 | P2-T02 粘贴导入验证 | 验证完整导入流程 |

### 中优先级（功能增强）

| 优先级 | 任务 | 说明 |
|--------|------|------|
| 🟢 P2 | P6-T03 Excel 导出 | 核心导出功能 |
| 🟢 P2 | P6-T05/T06 UI 集成 | 算法已完成，补充 UI 按钮 |
| 🟢 P2 | P6-T01 OCR 导入 | 花名册 OCR |

---

## 🐛 待修复问题清单

### 关键问题（Critical）

| 编号 | 问题描述 | 影响范围 | 修复建议 |
|------|---------|---------|---------|
| ~~C1~~ | ~~微机权限判断基于当前轮次而非会话轮次~~ | ~~历史会话编辑~~ | ~~✅ 已修复（2026-02-13）~~ |
| ~~C2~~ | ~~统计页面未包含晾堂数据~~ | ~~统计报表~~ | ~~✅ 已修复（2026-02-22）~~ |
| ~~C3~~ | ~~默认人员 Key 缺少 classNo~~ | ~~多班级场景~~ | ~~✅ 已修复（2026-02-13）~~ |

### 高优先级问题（High）

| 编号 | 问题描述 | 影响范围 | 修复建议 |
|------|---------|---------|---------|
| H1 | 微机岗位严格1人仅在 UI 层强制 | 数据完整性 | 在 biz-session-role-card 组件中添加数据层校验 |

### 中优先级问题（Medium）

| 编号 | 问题描述 | 影响范围 | 修复建议 |
|------|---------|---------|---------|
| M1 | 晾堂校验只检查 map 中存在的岗位 | 数据完整性 | 改为遍历所有必需岗位进行校验 |
| M2 | session-role-card 未排除当前槽位人员 | 用户体验 | occupiedIds 应排除当前编辑槽位的人员 |

### 低优先级问题（Low）

| 编号 | 问题描述 | 影响范围 | 修复建议 |
|------|---------|---------|---------|
| L1 | 岗位显示名称不一致 | 界面一致性 | 统一使用"麦料参数"或"麦料" |
| L2 | 重复的岗位 key 数组和默认值加载代码 | 代码质量 | 提取为常量或配置 |

---

## 📝 变更记录

| 日期 | 变更内容 |
|------|---------|
| 2026-02-22 | **统计页面晾堂数据修复** - 修复 C2 问题，4个统计页面纳入晾堂人员数据，优化代码复用（提取 LIANG_TANG_ROLES 常量、使用 getRoleName()），修复排序稳定性（positionIndex 使用循环索引），Codex 审查 8.5/10 通过 |
| 2026-02-13 | **晾堂功能完成与优化** - P4-T04 完成，修复微机权限判断、默认人员Key、工分计算公式（/160），优化性能（Set去重、缓存计算），总体进度达到 87% |
| 2026-02-13 | **Phase 5 完成** - P5-T03~T06 统计查询页面全部实现，总体进度达到 85% |
| 2026-02-13 | **严重 Bug 修复** - 修复草稿覆盖已提交数据问题，Draft/Submitted key 完全分离 |
| 2026-02-13 | **存储架构优化** - 恢复全局草稿索引 (pp:idx:draft)，代码更简洁高效 |
| 2026-02-13 | **代码质量提升** - 统一使用 calcFinalPoints()，修复仓号排序、key冲突等6个问题 |
| 2026-02-13 | **文档完善** - 新增 storage-architecture.md，记录架构设计与历史教训 |
| 2026-02-11 | **P5-T02 录入页考核交互完成** - 实现考核按钮、草稿模式、三段式工分显示、数据校验 |
| 2026-02-11 | **代码优化** - 创建 formatPointsUnits 共享函数，21处统一应用，修复 UTS 规范问题 |
| 2026-02-11 | **文档更新** - 添加代码复用案例到 code-reuse-thinking-guide.md |
| 2026-02-07 | P3-T07 工分输入控件完成，biz-score-input.uvue（295行）支持 v-model、两种尺寸 |
| 2026-02-07 | P3-T10 工作台列表完成，实现草稿/已提交列表、删除、跳转功能 |
| 2026-02-07 | P5-T01 扣分服务完成，PenaltyService.uts（400行）实现 CRUD + 汇总 |
| 2026-02-07 | P3-T05 曲坯数复用完成，修复 biz-bin-card CSS 类名冲突 |
| 2026-02-07 | P3-T04 仓卡片组件完成（biz-bin-card.uvue 860行），P3-T06 BIN 分配行已集成 |
| 2026-02-07 | 初始化开发进度文档，移除 P1-T04 SQLite 任务 |

---

## 参考文档

- [开发计划.md](./开发计划.md) — 完整任务定义与验收标准
- [白酒制曲车间工分管理系统PRD.md](./白酒制曲车间工分管理系统PRD.md) — 产品需求文档
- [.claude/方案总结.md](./.claude/方案总结.md) — 技术方案总结